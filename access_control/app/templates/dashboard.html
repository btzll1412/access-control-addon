<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>">
    <title>Access Control System - Dashboard</title>
    <style>
        /* ========================================
           GLOBAL STYLES
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* ========================================
           HEADER
           ======================================== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        /* ========================================
           EMERGENCY ALERT BANNER
           ======================================== */
        .emergency-alert {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 20px 40px;
            display: none;
            align-items: center;
            justify-content: space-between;
            animation: emergencyPulse 2s infinite;
        }

        .emergency-alert.active {
            display: flex;
        }

        @keyframes emergencyPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .emergency-alert-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .emergency-alert-icon {
            font-size: 32px;
            animation: emergencyRotate 2s infinite;
        }

        @keyframes emergencyRotate {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }

        .emergency-alert-text h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .emergency-alert-text p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ========================================
           STATS BAR
           ======================================== */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            padding: 30px 40px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-card.success {
            border-left-color: #10b981;
        }

        .stat-card.warning {
            border-left-color: #f59e0b;
        }

        .stat-card.danger {
            border-left-color: #ef4444;
        }

        .stat-card.info {
            border-left-color: #3b82f6;
        }

        /* ========================================
           TABS
           ======================================== */
        .tabs {
            display: flex;
            background: #f1f5f9;
            padding: 0 40px;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 500;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        /* ========================================
           TAB CONTENT
           ======================================== */
        .tab-content {
            display: none;
            padding: 40px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* ========================================
           NOTIFICATION BANNER
           ======================================== */
        .notification-banner {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .notification-banner.show {
            display: flex;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification-text h4 {
            font-size: 16px;
            color: #92400e;
            margin-bottom: 5px;
        }

        .notification-text p {
            font-size: 14px;
            color: #78350f;
        }

        /* ========================================
           EMERGENCY CONTROLS PANEL
           ======================================== */
        .emergency-panel {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 3px solid #ef4444;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .emergency-panel-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #fca5a5;
        }

        .emergency-panel-header h2 {
            font-size: 22px;
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .emergency-board-controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .emergency-board-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .emergency-board-name {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .emergency-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .emergency-status.normal {
            background: #d1fae5;
            color: #065f46;
        }

        .emergency-status.locked {
            background: #fecaca;
            color: #991b1b;
        }

        .emergency-status.unlocked {
            background: #dbeafe;
            color: #1e40af;
        }

        .emergency-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .emergency-door-overrides {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f1f5f9;
        }

        .emergency-door-overrides h4 {
            font-size: 16px;
            color: #64748b;
            margin-bottom: 15px;
        }

        .emergency-door-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .emergency-door-name {
            font-weight: 600;
            color: #1e293b;
        }

        .emergency-door-actions {
            display: flex;
            gap: 8px;
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-emergency {
            background: #dc2626;
            color: white;
            font-weight: 700;
            animation: emergencyButtonPulse 2s infinite;
        }

        .btn-emergency:hover {
            background: #991b1b;
        }

        @keyframes emergencyButtonPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        }

        /* ========================================
           CARDS
           ======================================== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        .card.emergency-active {
            border: 3px solid #ef4444;
            background: #fef2f2;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .card-body {
            margin-bottom: 15px;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .card-info-label {
            color: #64748b;
            font-weight: 500;
        }

        .card-info-value {
            color: #1e293b;
            font-weight: 600;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #f1f5f9;
            flex-wrap: wrap;
        }

        /* ========================================
           BADGES
           ======================================== */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-emergency {
            background: #dc2626;
            color: white;
            animation: emergencyBadgePulse 1s infinite;
        }

        @keyframes emergencyBadgePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ========================================
           MODALS
           ======================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #64748b;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 2px solid #f1f5f9;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ========================================
           FORMS
           ======================================== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-help {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
            color: #1e293b;
        }

        /* ========================================
           TABLES
           ======================================== */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        thead {
            background: #f8fafc;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #1e293b;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* ========================================
           TOAST NOTIFICATIONS
           ======================================== */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            z-index: 2000;
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast-icon {
            font-size: 24px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }

        /* ========================================
           LOADING SPINNER
           ======================================== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========================================
           RESPONSIVE
           ======================================== */

        /* Tablet and below */
        @media (max-width: 1024px) {
            .cards-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        /* Mobile devices */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 12px;
            }

            /* Header - stack on mobile */
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .header h1 {
                font-size: 20px;
                text-align: center;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .header-actions .btn {
                flex: 1;
                justify-content: center;
            }

            /* Stats bar */
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                padding: 15px;
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card h3 {
                font-size: 12px;
            }

            .stat-card .stat-value {
                font-size: 24px;
            }

            /* Tabs - horizontal scroll with touch */
            .tabs {
                padding: 0 10px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                padding: 12px 16px;
                font-size: 13px;
                min-width: max-content;
            }

            /* Tab content */
            .tab-content {
                padding: 15px;
            }

            .tab-content h2 {
                font-size: 20px;
            }

            /* Notification banner - stack */
            .notification-banner {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .notification-content {
                flex-direction: column;
            }

            .notification-banner .btn {
                width: 100%;
            }

            /* Controller settings section */
            #controllerSettingsBody > div[style*="grid-template-columns"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 15px !important;
            }

            /* Cards grid */
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .card {
                padding: 15px;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .card-actions {
                flex-direction: column;
                width: 100%;
            }

            .card-actions .btn {
                width: 100%;
                justify-content: center;
            }

            /* Tables */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -15px;
                padding: 0 15px;
            }

            table {
                font-size: 13px;
                min-width: 600px;
            }

            th, td {
                padding: 10px 8px;
                white-space: nowrap;
            }

            /* Forms */
            .form-group {
                margin-bottom: 15px;
            }

            .form-input,
            .form-select,
            .form-textarea {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px 15px;
            }

            /* Form grids - stack on mobile */
            div[style*="grid-template-columns: 1fr 1fr"],
            div[style*="grid-template-columns: 120px 1fr 120px"],
            div[style*="grid-template-columns: 100px 1fr 100px"] {
                display: flex !important;
                flex-direction: column !important;
                gap: 15px !important;
            }

            /* Modal */
            .modal {
                padding: 0;
                align-items: flex-end;
            }

            .modal-content {
                max-width: 100%;
                max-height: 95vh;
                border-radius: 20px 20px 0 0;
                margin: 0;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-body {
                padding: 20px;
            }

            .modal-footer {
                padding: 15px 20px;
                flex-direction: column;
            }

            .modal-footer .btn {
                width: 100%;
                justify-content: center;
            }

            /* Emergency panels */
            .emergency-board-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .emergency-actions {
                width: 100%;
                flex-direction: column;
            }

            .emergency-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .emergency-door-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .emergency-door-actions {
                width: 100%;
                flex-wrap: wrap;
            }

            .emergency-door-actions .btn {
                flex: 1;
                min-width: 80px;
                justify-content: center;
            }

            /* Buttons */
            .btn {
                font-size: 14px;
                padding: 12px 16px;
                white-space: nowrap;
            }

            .btn-small {
                font-size: 12px;
                padding: 10px 14px;
            }

            /* Better touch targets */
            .btn-primary,
            .btn-success,
            .btn-danger,
            .btn-warning {
                min-height: 44px;
            }

            /* Button shadows for visibility */
            .btn-primary {
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }

            .btn-success {
                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            }

            .btn-danger {
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            }

            .btn-warning {
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
            }

            /* Toast notifications */
            .toast {
                bottom: 20px;
                right: 15px;
                left: 15px;
                min-width: auto;
            }

            /* Header row with buttons */
            div[style*="justify-content: space-between"][style*="margin-bottom: 20px"] {
                flex-direction: column !important;
                gap: 15px !important;
                align-items: stretch !important;
            }

            div[style*="justify-content: space-between"][style*="margin-bottom: 20px"] > div[style*="gap: 10px"] {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 10px !important;
            }

            div[style*="justify-content: space-between"][style*="margin-bottom: 20px"] > div[style*="gap: 10px"] .btn {
                flex: 1 1 auto !important;
                min-width: 120px !important;
            }

            /* Emergency alert banner */
            .emergency-alert {
                flex-direction: column;
                padding: 15px 20px;
                gap: 15px;
                text-align: center;
            }

            .emergency-alert-content {
                flex-direction: column;
            }
        }

        /* Extra small devices (phones in portrait) */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 12px 15px;
            }

            .header h1 {
                font-size: 16px;
            }

            /* Stats - single column on very small screens */
            .stats-bar {
                grid-template-columns: 1fr;
                padding: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-card .stat-value {
                font-size: 22px;
            }

            .tab {
                padding: 10px 14px;
                font-size: 12px;
            }

            .tab-content {
                padding: 12px;
            }

            .card {
                padding: 12px;
            }

            /* Full screen modals on small phones */
            .modal-content {
                border-radius: 0;
                height: 100vh;
                max-height: 100vh;
            }

            table {
                font-size: 11px;
            }

            th, td {
                padding: 8px 6px;
            }

            .btn {
                font-size: 13px;
                padding: 10px 12px;
            }

            .btn-small {
                font-size: 11px;
                padding: 8px 10px;
            }
        }

        /* Landscape mode on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal-content {
                max-height: 100vh;
                border-radius: 0;
            }

            .stats-bar {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Touch-friendly hover states */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover:not(:disabled) {
                transform: none;
            }

            .card:hover {
                transform: none;
            }

            /* Add active states for touch */
            .btn:active:not(:disabled) {
                transform: scale(0.98);
                opacity: 0.9;
            }

            .card:active {
                transform: scale(0.99);
            }
        }

        /* ========================================
           LOGIN OVERLAY & MODAL
           ======================================== */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-overlay.hidden {
            display: none !important;
        }
        
        .login-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 420px;
            margin: 20px;
            overflow: hidden;
            animation: loginSlideIn 0.4s ease-out;
        }
        
        @keyframes loginSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .login-header h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 8px 0;
        }
        
        .login-header p {
            font-size: 14px;
            opacity: 0.9;
            margin: 0;
        }
        
        .login-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .login-form-group {
            margin-bottom: 20px;
        }
        
        .login-form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }
        
        .login-form-group input[type="text"],
        .login-form-group input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
        }
        
        .login-form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }
        
        .login-remember {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .login-remember input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .login-remember label {
            font-size: 14px;
            color: #64748b;
            cursor: pointer;
            user-select: none;
        }
        
        .login-remember-days {
            color: #667eea;
            font-weight: 600;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .login-btn .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .login-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .login-error.show {
            display: flex;
        }
        
        .password-wrapper {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #94a3b8;
            padding: 5px;
        }
        
        .login-footer {
            text-align: center;
            padding: 20px 30px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }
        
        .login-footer p {
            font-size: 12px;
            color: #94a3b8;
            margin: 0;
        }
    </style>
</head>
<body>

   <!-- Login Overlay -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-container">
        <div class="login-header">
            <div class="login-icon">üîê</div>
            <h1>Access Control System</h1>
            <p>Please sign in to continue</p>
        </div>
        
        <div class="login-body">
            <div class="login-error" id="loginError">
                <span>‚ö†Ô∏è</span>
                <span id="loginErrorText">Invalid credentials</span>
            </div>
            
            <form id="loginForm">
                <div class="login-form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" name="username" 
                           placeholder="Enter username" required autocomplete="username">
                </div>
                
                <div class="login-form-group">
                    <label for="loginPassword">Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="loginPassword" name="password" 
                               placeholder="Enter password" required autocomplete="current-password">
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility()">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                
                <div class="login-remember">
                    <input type="checkbox" id="loginRemember" name="remember">
                    <label for="loginRemember">
                        Remember this device for <span class="login-remember-days" id="rememberDays">30</span> days
                    </label>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    <span id="loginBtnText">üîë Sign In</span>
                </button>
            </form>
        </div>
        
        <div class="login-footer">
            <p>Access Control System v1.0</p>
        </div>
    </div>
</div>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîê Access Control System</h1>
            <div class="header-actions">
                <button class="btn btn-secondary btn-small" onclick="handleLogout()">üö™ Logout</button>
                <button class="btn btn-secondary btn-small" onclick="location.reload()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Emergency Alert Banner -->
        <div class="emergency-alert" id="emergencyAlert">
            <div class="emergency-alert-content">
                <div class="emergency-alert-icon">üö®</div>
                <div class="emergency-alert-text">
                    <h3>EMERGENCY MODE ACTIVE</h3>
                    <p id="emergencyAlertText">Emergency lockdown in effect</p>
                </div>
            </div>
            <button class="btn btn-secondary btn-small" onclick="showTab('emergency')">
                View Emergency Controls
            </button>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card success">
                <h3>Online Boards</h3>
                <div class="stat-value" id="statOnlineBoards">0</div>
            </div>
            <div class="stat-card info">
                <h3>Active Users</h3>
                <div class="stat-value" id="statActiveUsers">0</div>
            </div>
            <div class="stat-card warning">
                <h3>Total Doors</h3>
                <div class="stat-value" id="statTotalDoors">0</div>
            </div>
            <div class="stat-card info">
                <h3>Today's Events</h3>
                <div class="stat-value" id="statTodayEvents">0</div>
            </div>
            <div class="stat-card danger" id="statEmergencyCard" style="display: none;">
                <h3>üö® Emergency Active</h3>
                <div class="stat-value" id="statEmergencyActive">0</div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('doors')">üö™ Doors</button>
            <button class="tab" onclick="showTab('scheduleTemplates')">üìã Templates</button>
            <button class="tab" onclick="showTab('boards')">üì° Boards</button>
            <button class="tab" onclick="showTab('users')">üë• Users</button>
            <button class="tab" onclick="showTab('groups')">üè¢ Groups</button>
            <button class="tab" onclick="showTab('schedules')">üìÖ Schedules</button>
            <button class="tab" onclick="showTab('emergency')">üö® Emergency</button>
            <button class="tab" onclick="showTab('tempcodes')">üé´ Temp Codes</button>
            <button class="tab" onclick="showTab('logs')">üìã Logs</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- Tab: Boards -->
        <div id="tab-boards" class="tab-content">
            <!-- Pending Boards Notification -->
            <div class="notification-banner" id="pendingBoardsNotification">
                <div class="notification-content">
                    <div class="notification-icon">üîî</div>
                    <div class="notification-text">
                        <h4>New Boards Waiting for Adoption</h4>
                        <p id="pendingBoardsText">0 boards are ready to be adopted</p>
                    </div>
                </div>
                <button class="btn btn-primary btn-small" onclick="showPendingBoards()">
                    ‚úÖ Adopt Boards
                </button>
            </div>

            <!-- Controller Settings Section -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #7dd3fc;">
                <div class="card-header" style="border-bottom: 1px solid #7dd3fc;">
                    <div class="card-title" style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">‚öôÔ∏è</span>
                        <span>Default Controller Settings</span>
                    </div>
                    <button class="btn btn-small" id="controllerSettingsToggle" onclick="toggleControllerSettings()" style="background: #0284c7; color: white;">
                        ‚ñº Show Settings
                    </button>
                </div>
                <div id="controllerSettingsBody" style="display: none; padding: 20px;">
                    <p style="color: #64748b; margin-bottom: 15px; font-size: 14px;">
                        Set the default controller address that boards will use to communicate back. This is useful when boards are on different networks or when using a domain name.
                    </p>
                    <div style="display: grid; grid-template-columns: 120px 1fr 120px; gap: 15px; align-items: end;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Protocol</label>
                            <select class="form-input" id="defaultControllerProtocol">
                                <option value="http">HTTP</option>
                                <option value="https">HTTPS</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Controller IP / Domain</label>
                            <input type="text" class="form-input" id="defaultControllerAddress"
                                   placeholder="e.g., 192.168.1.100 or controller.example.com">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-input" id="defaultControllerPort"
                                   value="8100" min="1" max="65535">
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span id="controllerSettingsPreview" style="color: #64748b; font-size: 13px;"></span>
                        <button class="btn btn-primary" onclick="saveControllerSettings()">
                            üíæ Save Default Settings
                        </button>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Boards</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="syncAllBoards()">üîÑ Sync All</button>
                    <button class="btn btn-primary" onclick="openBoardModal()">‚ûï Add Board</button>
                </div>
            </div>

            <div class="cards-grid" id="boardsList"></div>
        </div>

        <!-- Tab: Doors -->
        <div id="tab-doors" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Doors</h2>
            </div>

            <div class="cards-grid" id="doorsList"></div>
        </div>

        <!-- Tab: Users -->
        <div id="tab-users" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Users</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
            <!-- Search Box -->
            <input type="text" id="userSearchInput" placeholder="üîç Search users..."
                   oninput="applyUserFilters()"
                   style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; width: 200px;">

            <!-- Status Filter -->
            <select id="userStatusFilter" onchange="applyUserFilters()"
                    style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="all">All Status</option>
                <option value="active">‚úÖ Active</option>
                <option value="inactive">‚ùå Inactive</option>
            </select>

            <!-- Group Filter -->
            <select id="userGroupFilter" onchange="applyUserFilters()"
                    style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="all">All Groups</option>
                <!-- Populated dynamically -->
            </select>

            <!-- CSV Import/Export Buttons -->
            <button class="btn btn-secondary btn-small" onclick="window.location.href='/api/users/template'">
                üì• Download Template
            </button>

            <input type="file" accept=".csv" id="csvUpload" style="display: none;"
                   onchange="handleCSVUpload(this)">
            <button class="btn btn-success btn-small" onclick="document.getElementById('csvUpload').click()">
                üì§ Import CSV
            </button>

            <button class="btn btn-warning btn-small" onclick="window.location.href='/api/users/export'">
                üíæ Export All
            </button>

            <button class="btn btn-primary" onclick="openUserModal()">‚ûï Add User</button>

            <!-- Select Mode Toggle Button -->
            <button class="btn btn-secondary btn-small" id="toggleSelectModeBtn" onclick="toggleSelectMode()">
                ‚òëÔ∏è Select
            </button>

            <!-- Delete Selected Button (hidden by default) -->
            <button class="btn btn-danger" id="deleteSelectedUsersBtn" style="display: none;" onclick="deleteSelectedUsers()">
                üóëÔ∏è Delete Selected (<span id="selectedUsersCount">0</span>)
            </button>

            <!-- Cancel Selection Button (hidden by default) -->
            <button class="btn btn-secondary btn-small" id="cancelSelectModeBtn" style="display: none;" onclick="toggleSelectMode()">
                ‚úñÔ∏è Cancel
            </button>
        </div>
    </div>

            <div class="table-container">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th class="select-column" style="width: 40px; display: none;">
                                <input type="checkbox" id="selectAllUsers" onchange="toggleSelectAllUsers(this)">
                            </th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Cards</th>
                            <th>PINs</th>
                            <th>Groups</th>
                            <th>Schedules</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersList"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Groups -->
        <div id="tab-groups" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Access Groups</h2>
                <button class="btn btn-primary" onclick="openGroupModal()">‚ûï Add Group</button>
            </div>

            <div class="cards-grid" id="groupsList"></div>
        </div>

        <!-- Tab: Schedules -->
        <div id="tab-schedules" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Access Schedules (User Time Restrictions)</h2>
                <button class="btn btn-primary" onclick="openScheduleModal()">‚ûï Add Schedule</button>
            </div>

            <!-- Help Section -->
            <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #1e40af;">üìò Understanding Schedules</h4>
                <p style="margin: 0 0 10px 0; color: #1e3a8a;">
                    <strong>User Schedules (this page):</strong> Restrict WHEN specific users can access doors.<br>
                    <em>Example: "Cleaning crew can only access Monday-Friday 6pm-10pm"</em>
                </p>
                <p style="margin: 0; color: #1e3a8a;">
                    <strong>Door Schedules (Doors tab ‚Üí Schedule button):</strong> Control WHAT MODE the door is in at different times.<br>
                    <em>Example: "Main entrance is unlocked 8am-6pm, controlled 6pm-10pm, locked 10pm-8am"</em>
                </p>
            </div>

            <div class="form-help" style="margin-bottom: 20px;">
                Access schedules define when users are allowed to access doors. 
                Users without an assigned schedule have 24/7 access (subject to group permissions).
            </div>
            <div class="cards-grid" id="schedulesList"></div>
        </div>

        <!-- Tab: Schedule Templates -->
        <div id="tab-scheduleTemplates" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2>üìã Schedule Templates</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="showPresetTemplates()">‚ö° Quick Presets</button>
                    <button class="btn btn-primary" onclick="openScheduleTemplateModal()">‚ûï Create Template</button>
                </div>
            </div>

            <!-- Help Section -->
            <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #1e40af;">üìò What are Schedule Templates?</h4>
                <p style="margin: 0; color: #1e3a8a;">
                    Templates let you create a schedule ONCE and apply it to MULTIPLE doors.<br>
                    <strong>Example:</strong> Create "Business Hours" template ‚Üí Apply to all office doors instantly!<br>
                    When you update a template, ALL assigned doors update automatically.
                </p>
            </div>

            <!-- Templates Grid -->
            <div class="cards-grid" id="scheduleTemplatesList"></div>
        </div>

        <!-- Tab: Emergency Controls -->
        <div id="tab-emergency" class="tab-content">
            <div style="margin-bottom: 20px;">
                <h2>üö® Emergency Controls</h2>
                <p style="color: #64748b; margin-top: 10px;">
                    Emergency controls override all schedules and permissions. Use with caution.
                </p>
            </div>

            <div id="emergencyControlsList"></div>
        </div>


        <!-- Tab: Temp Codes -->
<div id="tab-tempcodes" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2>üé´ Temporary Access Codes</h2>
        <button class="btn btn-primary" onclick="openTempCodeModal()">‚ûï Create Temp Code</button>
    </div>

    <!-- Help Section -->
    <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0; color: #1e40af;">üìò About Temporary Codes</h4>
        <p style="margin: 0; color: #1e3a8a;">
            Temporary codes provide time-limited access without creating full user accounts.<br>
            <strong>Use cases:</strong> Contractors, delivery personnel, guests, one-time visitors, cleaning crews.
        </p>
    </div>

    <div class="cards-grid" id="tempCodesList"></div>
</div>

        <!-- Tab: Access Logs -->
<div id="tab-logs" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
        <h2>Access Logs</h2>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-secondary btn-small" onclick="clearLogFilters()">
                üîÑ Clear Filters
            </button>
            <button class="btn btn-primary btn-small" onclick="loadLogs()">
                üîÑ Refresh Logs
            </button>
        </div>
    </div>

    <!-- Advanced Filters -->
    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h3 style="margin-bottom: 15px; font-size: 16px; color: #1e293b;">üîç Filters</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <!-- User Filter -->
            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 13px;">User</label>
                <select class="form-select" id="filterUser" onchange="loadLogs()" style="width: 100%;">
                    <option value="">All Users</option>
                </select>
            </div>

            <!-- Board Filter -->
            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 13px;">Board</label>
                <select class="form-select" id="filterBoard" onchange="loadLogs()" style="width: 100%;">
                    <option value="">All Boards</option>
                </select>
            </div>

            <!-- Door Filter -->
            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 13px;">Door</label>
                <select class="form-select" id="filterDoor" onchange="loadLogs()" style="width: 100%;">
                    <option value="">All Doors</option>
                </select>
            </div>

            <!-- Credential Type Filter -->
            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 13px;">Credential Type</label>
                <select class="form-select" id="filterCredentialType" onchange="loadLogs()" style="width: 100%;">
                    <option value="">All Types</option>
                    <option value="card">Card</option>
                    <option value="pin">PIN</option>
                    <option value="temp_code">Temp Code</option>
                    <option value="manual">Manual</option>
                    <option value="emergency">Emergency</option>
                </select>
            </div>

            <!-- Access Result Filter -->
            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 13px;">Access Result</label>
                <select class="form-select" id="filterAccessGranted" onchange="loadLogs()" style="width: 100%;">
                    <option value="">All Results</option>
                    <option value="true">‚úÖ Granted</option>
                    <option value="false">‚ùå Denied</option>
                </select>
            </div>

            <!-- Date From Filter -->
            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 13px;">Date From</label>
                <input type="date" class="form-input" id="filterDateFrom" onchange="loadLogs()" style="width: 100%;">
            </div>

            <!-- Date To Filter -->
            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 13px;">Date To</label>
                <input type="date" class="form-input" id="filterDateTo" onchange="loadLogs()" style="width: 100%;">
            </div>

            <!-- Limit Filter -->
            <div class="form-group" style="margin: 0;">
                <label class="form-label" style="font-size: 13px;">Show Entries</label>
                <select class="form-select" id="filterLimit" onchange="loadLogs()" style="width: 100%;">
                    <option value="50">Last 50</option>
                    <option value="100" selected>Last 100</option>
                    <option value="500">Last 500</option>
                    <option value="1000">Last 1000</option>
                </select>
            </div>
        </div>

        <!-- Search Box -->
        <div class="form-group" style="margin-top: 15px; margin-bottom: 0;">
            <label class="form-label" style="font-size: 13px;">üîé Search (Name, Board, Door, Credential, Reason)</label>
            <input type="text" class="form-input" id="filterSearch" 
                   placeholder="Type to search..." 
                   onkeyup="searchLogsDebounced()"
                   style="width: 100%;">
        </div>
    </div>

    <!-- Results Count -->
    <div style="margin-bottom: 15px; color: #64748b; font-size: 14px;">
        Showing <strong id="logsCount">0</strong> logs
        <span id="logsLastRefresh" style="margin-left: 20px; font-style: italic;"></span>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th style="min-width: 150px;">Timestamp</th>
                    <th>Board</th>
                    <th>Door</th>
                    <th>User</th>
                    <th>Credential</th>
                    <th style="text-align: center;">Result</th>
                    <th>Reason</th>
                </tr>
            </thead>
            <tbody id="logsList"></tbody>
        </table>
    </div>
</div>

        <!-- Tab: Settings -->
        <div id="tab-settings" class="tab-content">
            <div style="margin-bottom: 20px;">
                <h2>System Settings</h2>
            </div>

            <!-- System Backup Section -->
            <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #86efac;">
                <div class="card-header" style="border-bottom: 1px solid #86efac;">
                    <div class="card-title" style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">üíæ</span>
                        <span>System Backup & Restore</span>
                    </div>
                </div>
                <div class="card-body" style="padding: 20px;">
                    <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">
                        Export all system configuration (users, cards, PINs, groups, schedules, temp codes) to a JSON file.<br>
                        Use this to backup your system before making changes, or to restore after rebuilding.
                    </p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Export Section -->
                        <div style="padding: 20px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h4 style="margin-bottom: 15px; color: #059669;">üì§ Export Backup</h4>
                            <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">
                                Download a complete backup of your system configuration.
                            </p>
                            <button class="btn btn-primary" onclick="exportSystemBackup()" style="width: 100%;">
                                üì¶ Download System Backup
                            </button>
                        </div>

                        <!-- Import Section -->
                        <div style="padding: 20px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <h4 style="margin-bottom: 15px; color: #0284c7;">üì• Restore Backup</h4>
                            <p style="font-size: 13px; color: #64748b; margin-bottom: 15px;">
                                Upload a backup file to restore your system configuration.
                            </p>
                            <input type="file" id="systemBackupFile" accept=".json" style="display: none;" onchange="importSystemBackup(this)">
                            <button class="btn btn-secondary" onclick="document.getElementById('systemBackupFile').click()" style="width: 100%;">
                                üìÇ Upload Backup File
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 1px solid #fcd34d;">
                        <strong style="color: #92400e;">‚ö†Ô∏è Important Notes:</strong>
                        <ul style="margin: 10px 0 0 20px; color: #78350f; font-size: 13px;">
                            <li>Door-specific settings (group assignments, door schedules) require boards to be adopted first with the <strong>same board names</strong></li>
                            <li>Existing users with the same name will be updated with the imported data</li>
                            <li>Access logs are NOT included in the backup (they are historical data)</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Backup Contents Info -->
            <div class="card" style="background: #f8fafc; border: 1px solid #e2e8f0;">
                <div class="card-header">
                    <div class="card-title">üìã What's Included in Backup</div>
                </div>
                <div class="card-body" style="padding: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="padding: 10px; background: white; border-radius: 6px;">
                            <strong>üë• Users</strong>
                            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Names, cards, PINs, validity dates, notes</p>
                        </div>
                        <div style="padding: 10px; background: white; border-radius: 6px;">
                            <strong>üè¢ Access Groups</strong>
                            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Group names, descriptions, door assignments</p>
                        </div>
                        <div style="padding: 10px; background: white; border-radius: 6px;">
                            <strong>üìÖ Schedules</strong>
                            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">User time restrictions with all time slots</p>
                        </div>
                        <div style="padding: 10px; background: white; border-radius: 6px;">
                            <strong>üö™ Door Schedules</strong>
                            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Auto-lock/unlock schedules per door</p>
                        </div>
                        <div style="padding: 10px; background: white; border-radius: 6px;">
                            <strong>üé´ Temp Codes</strong>
                            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Temporary access codes with all settings</p>
                        </div>
                        <div style="padding: 10px; background: white; border-radius: 6px;">
                            <strong>‚öôÔ∏è Controller Settings</strong>
                            <p style="font-size: 12px; color: #64748b; margin-top: 5px;">Default controller address configuration</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Board Modal -->
    <div id="boardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="boardModalTitle">Add Board</h3>
                <button class="modal-close" onclick="closeBoardModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="boardForm" onsubmit="saveBoard(event)">
                    <input type="hidden" id="boardId">
                    
                    <div class="form-group">
                        <label class="form-label">Board Name *</label>
                        <input type="text" class="form-input" id="boardName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">IP Address *</label>
                        <input type="text" class="form-input" id="boardIP" required 
                               placeholder="192.168.1.100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Door 1 Name *</label>
                        <input type="text" class="form-input" id="boardDoor1" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Door 2 Name *</label>
                        <input type="text" class="form-input" id="boardDoor2" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBoardModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('boardForm').requestSubmit()">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Add User</h3>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="saveUser(event)">
                    <input type="hidden" id="userId">
                    
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="userName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="userActive" checked> Active
                        </label>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">Valid From</label>
                            <input type="date" class="form-input" id="userValidFrom">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Valid Until</label>
                            <input type="date" class="form-input" id="userValidUntil">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Card Numbers</label>
                        <div class="form-help" style="margin-bottom: 10px;">
                            Enter cards as "Facility Code + Card Code" (e.g., 173 37764) or just the "Card Code" (last 5 digits printed on card)
                        </div>
                        <div id="userCards"></div>
                        <button type="button" class="btn btn-secondary btn-small"
                                onclick="addCardInput()" style="margin-top: 10px;">
                            ‚ûï Add Card
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">PIN Codes</label>
                        <div id="userPins"></div>
                        <button type="button" class="btn btn-secondary btn-small" 
                                onclick="addPinInput()" style="margin-top: 10px;">
                            ‚ûï Add PIN
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Access Groups *</label>
                        <div class="form-help">Select which groups this user belongs to (determines door access)</div>
                        <div id="userGroupsCheckboxes" class="checkbox-group"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Time Schedules (Optional)</label>
                        <div class="form-help">Select schedules to restrict when this user can access doors. Leave empty for 24/7 access.</div>
                        <div id="userSchedulesCheckboxes" class="checkbox-group"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="userNotes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('userForm').requestSubmit()">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="groupModalTitle">Add Group</h3>
                <button class="modal-close" onclick="closeGroupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="groupForm" onsubmit="saveGroup(event)">
                    <input type="hidden" id="groupId">
                    
                    <div class="form-group">
                        <label class="form-label">Group Name *</label>
                        <input type="text" class="form-input" id="groupName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="groupDescription"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-input" id="groupColor" value="#6366f1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Doors Access *</label>
                        <div class="form-help">Select which doors this group can access</div>
                        <div id="groupDoorsCheckboxes" class="checkbox-group"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGroupModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('groupForm').requestSubmit()">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="scheduleModalTitle">Add Schedule</h3>
                <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" onsubmit="saveSchedule(event)">
                    <input type="hidden" id="scheduleId">
                    
                    <div class="form-group">
                        <label class="form-label">Schedule Name *</label>
                        <input type="text" class="form-input" id="scheduleName" required 
                               placeholder="e.g., Business Hours, Night Shift">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="scheduleDescription"
                                  placeholder="e.g., Monday-Friday 9 AM to 5 PM"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="scheduleActive" checked> Active
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Time Ranges *</label>
                        <div class="form-help">Add time ranges when access is allowed</div>
                        <div id="scheduleTimeRanges"></div>
                        <button type="button" class="btn btn-secondary btn-small" 
                                onclick="addScheduleTimeRange()" style="margin-top: 10px;">
                            ‚ûï Add Time Range
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                <button class="btn btn-primary" type="button" onclick="saveSchedule(event)">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>

    <!-- Door Schedule Modal -->
    <div id="doorScheduleModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="doorScheduleModalTitle">Door Schedule</h3>
                <button class="modal-close" onclick="closeDoorScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="doorScheduleDoorId">
                
                <!-- Schedule Source Selector -->
                <div class="form-group">
                    <label class="form-label">Schedule Source</label>
                    <select class="form-select" id="doorScheduleSource" onchange="onScheduleSourceChange()">
                        <option value="">-- Select Schedule --</option>
                        <option value="none">‚ùå No Schedule (Default Controlled)</option>
                        <!-- Templates will be populated here -->
                        <optgroup label="üìã Templates" id="doorScheduleTemplateOptions">
                        </optgroup>
                        <option value="custom">‚úèÔ∏è Custom (Per-Door Schedule)</option>
                    </select>
                    <div class="form-help" id="scheduleSourceHelp">
                        Choose a template to apply, or select "Custom" for per-door settings.
                    </div>
                </div>

                <!-- Template Info Banner (shown when template selected) -->
                <div id="templateInfoBanner" style="display: none; background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: #1e40af;">üìã Using Template: <span id="templateInfoName"></span></strong>
                            <p style="margin: 5px 0 0 0; color: #3b82f6; font-size: 13px;">
                                To modify this schedule, edit the template. Changes will apply to all doors using it.
                            </p>
                        </div>
                        <button type="button" class="btn btn-primary btn-small" onclick="goToTemplates()">
                            Edit Template
                        </button>
                    </div>
                </div>

                <!-- Schedule Preview (read-only when template, editable when custom) -->
                <div class="form-group">
                    <label class="form-label">Schedule Preview</label>
                    <div id="doorSchedulePreview" style="background: #f8fafc; border-radius: 12px; padding: 20px;">
                        <p style="color: #94a3b8; text-align: center;">Select a schedule source above</p>
                    </div>
                </div>

                <!-- Custom Schedule Editor (hidden by default) -->
                <div id="customScheduleEditor" style="display: none;">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <label class="form-label" style="margin: 0;">Custom Time Slots</label>
                            <div>
                                <button type="button" class="btn btn-secondary btn-small" onclick="addDoorScheduleSlot()">
                                    ‚ûï Add Slot
                                </button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="copyMondayToWeekdaysDoor()">
                                    üìã Copy Mon‚ÜíWeekdays
                                </button>
                            </div>
                        </div>
                        <div id="doorScheduleSlotsList"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDoorScheduleModal()">Cancel</button>
                <button class="btn btn-primary" id="saveDoorScheduleBtn" onclick="saveDoorScheduleNew()">
                    üíæ Apply Schedule
                </button>
            </div>
        </div>
    </div>

    <!-- Door Settings Modal -->
<div id="doorSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="doorSettingsModalTitle">Door Settings</h3>
            <button class="modal-close" onclick="closeDoorSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="doorSettingsForm" onsubmit="saveDoorSettings(event)">
                <input type="hidden" id="settingsDoorId">
                
                <div class="form-group">
                    <label class="form-label">Door Name</label>
                    <input type="text" class="form-input" id="settingsDoorName" readonly disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Unlock Duration (milliseconds)</label>
                    <input type="number" class="form-input" id="settingsUnlockDuration" 
                           min="500" max="30000" step="100" value="3000" required>
                    <div class="form-help">
                        How long the relay stays active (1000ms = 1 second)<br>
                        Recommended: 3000-5000ms for standard doors
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDoorSettingsModal()">Cancel</button>
            <button class="btn btn-primary" onclick="document.getElementById('doorSettingsForm').requestSubmit()">
                üíæ Save Settings
            </button>
        </div>
    </div>
</div>

    <!-- Pending Boards Modal -->
    <div id="pendingBoardsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Pending Boards</h3>
                <button class="modal-close" onclick="closePendingBoardsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Board Name</th>
                                <th>IP Address</th>
                                <th>MAC Address</th>
                                <th>First Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingBoardsList"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePendingBoardsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Adopt Board Configuration Modal -->
    <div id="adoptBoardModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-bottom-color: #86efac;">
                <h3 class="modal-title" style="color: #166534;">‚úÖ Adopt Board</h3>
                <button class="modal-close" onclick="closeAdoptBoardModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; font-size: 14px; color: #64748b;">
                        <strong>Board:</strong> <span id="adoptBoardName" style="color: #1e293b;"></span><br>
                        <strong>IP Address:</strong> <span id="adoptBoardIP" style="color: #1e293b;"></span>
                    </p>
                </div>

                <input type="hidden" id="adoptPendingId">

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="adoptUseDefault" checked onchange="toggleAdoptControllerFields()">
                        <span class="form-label" style="margin: 0;">Use default controller settings</span>
                    </label>
                </div>

                <div id="adoptControllerFields">
                    <div style="display: grid; grid-template-columns: 100px 1fr 100px; gap: 10px; margin-top: 15px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Protocol</label>
                            <select class="form-input" id="adoptControllerProtocol" disabled>
                                <option value="http">HTTP</option>
                                <option value="https">HTTPS</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Controller Address</label>
                            <input type="text" class="form-input" id="adoptControllerAddress"
                                   placeholder="IP or domain" disabled>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-input" id="adoptControllerPort"
                                   value="8100" min="1" max="65535" disabled>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <span id="adoptControllerPreview" style="color: #64748b; font-size: 13px;"></span>
                    </div>
                </div>

                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0; font-size: 13px; color: #92400e;">
                        <strong>Note:</strong> The board will be configured to send heartbeats and access logs to this controller address. Make sure the address is reachable from the board's network.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAdoptBoardModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmAdoptBoard()">
                    ‚úÖ Adopt Board
                </button>
            </div>
        </div>
    </div>

    <!-- Emergency Confirm Modal -->
    <div id="emergencyConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: #fef2f2; border-bottom-color: #fecaca;">
                <h3 class="modal-title" style="color: #991b1b;">‚ö†Ô∏è Confirm Emergency Action</h3>
                <button class="modal-close" onclick="closeEmergencyConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="emergencyConfirmText" style="font-size: 16px; color: #1e293b; margin-bottom: 20px;"></p>
                
                <div class="form-group">
                    <label class="form-label">Your Name (for audit log)</label>
                    <input type="text" class="form-input" id="emergencyActivatedBy" 
                           placeholder="Enter your name" required>
                </div>

                <div id="emergencyAutoResetContainer" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Auto-Reset Time (minutes)</label>
                        <input type="number" class="form-input" id="emergencyAutoReset" 
                               value="30" min="5" max="480">
                        <div class="form-help">Door will automatically return to normal mode after this time</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmergencyConfirmModal()">Cancel</button>
                <button class="btn btn-emergency" id="emergencyConfirmButton" onclick="confirmEmergencyAction()">
                    Confirm
                </button>
            </div>
        </div>
    </div>


<!-- Schedule Template Modal -->
    <div id="scheduleTemplateModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="scheduleTemplateModalTitle">Create Schedule Template</h3>
                <button class="modal-close" onclick="closeScheduleTemplateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scheduleTemplateForm" onsubmit="saveScheduleTemplate(event)">
                    <input type="hidden" id="templateId">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label class="form-label">Template Name *</label>
                            <input type="text" class="form-input" id="templateName" required
                                   placeholder="e.g., Business Hours, Night Shift, Weekend Access">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input" id="templateDescription"
                                   placeholder="e.g., Mon-Fri 9am-5pm unlocked">
                        </div>
                    </div>

                    <!-- Visual Week Grid -->
                    <div class="form-group">
                        <label class="form-label">Weekly Schedule</label>
                        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-top: 10px;">
                            <div id="templateWeekGrid"></div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #e2e8f0;">
                                <button type="button" class="btn btn-secondary btn-small" onclick="addTemplateSlot()">
                                    ‚ûï Add Time Slot
                                </button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="copyMondayToWeekdays()">
                                    üìã Copy Monday ‚Üí Weekdays
                                </button>
                                <button type="button" class="btn btn-secondary btn-small" onclick="clearAllSlots()">
                                    üóëÔ∏è Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Door Assignment -->
                    <div class="form-group">
                        <label class="form-label">Assign to Doors</label>
                        <div class="form-help">Select which doors should use this template</div>
                        <div id="templateDoorsCheckboxes" class="checkbox-group" 
                             style="max-height: 200px; overflow-y: auto; background: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeScheduleTemplateModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('scheduleTemplateForm').requestSubmit()">
                    üíæ Save Template
                </button>
            </div>
        </div>
    </div>

    <!-- Preset Templates Modal -->
    <div id="presetTemplatesModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">‚ö° Quick Preset Templates</h3>
                <button class="modal-close" onclick="closePresetTemplatesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #64748b; margin-bottom: 20px;">
                    Choose a preset to quickly create a new template. You can customize it after creation.
                </p>
                <div id="presetTemplatesList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePresetTemplatesModal()">Close</button>
            </div>
        </div>
    </div>


    <!-- Temp Code Modal -->
<div id="tempCodeModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title" id="tempCodeModalTitle">Create Temp Code</h3>
            <button class="modal-close" onclick="closeTempCodeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="tempCodeForm" onsubmit="saveTempCode(event)">
                <input type="hidden" id="tempCodeId">
                
                <div class="form-group">
                    <label class="form-label">Code Name / Description *</label>
                    <input type="text" class="form-input" id="tempCodeName" required
                           placeholder="e.g., Plumber - John Smith, Delivery Access">
                </div>

                <div class="form-group">
                    <label class="form-label">PIN Code *</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-input" id="tempCodePin" required
                               placeholder="4-8 digits" maxlength="8" pattern="[0-9]{4,8}"
                               style="flex: 1;">
                        <button type="button" class="btn btn-secondary" onclick="generateRandomPin()">
                            üé≤ Generate
                        </button>
                    </div>
                    <div class="form-help">PIN must be 4-8 digits</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="tempCodeActive" checked>
                        <label class="form-check-label" for="tempCodeActive">
                            Active
                        </label>
                    </div>
                </div>

                <!-- Usage Type -->
                <div class="form-group">
                    <label class="form-label">Usage Type *</label>
                    <select class="form-select" id="tempCodeUsageType" onchange="updateUsageTypeUI()">
                        <option value="one_time">One-Time Use (single entry)</option>
                        <option value="limited">Limited Uses (set max entries)</option>
                        <option value="unlimited">Unlimited Uses (within time period)</option>
                    </select>
                </div>

                <div class="form-group" id="maxUsesGroup" style="display: none;">
                    <label class="form-label">Maximum Uses</label>
                    <input type="number" class="form-input" id="tempCodeMaxUses" 
                           min="1" max="100" value="5">
                </div>

                <!-- Time Validity -->
                <div class="form-group">
                    <label class="form-label">Time Validity *</label>
                    <select class="form-select" id="tempCodeTimeType" onchange="updateTimeTypeUI()">
                        <option value="hours">Valid for X Hours (from first use)</option>
                        <option value="date_range">Date Range (specific dates)</option>
                        <option value="permanent">No Expiry (until manually disabled)</option>
                    </select>
                </div>

                <div class="form-group" id="validHoursGroup">
                    <label class="form-label">Valid for (hours)</label>
                    <input type="number" class="form-input" id="tempCodeValidHours" 
                           min="1" max="720" value="24">
                    <div class="form-help">Timer starts when code is first used</div>
                </div>

                <div id="dateRangeGroup" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">Valid From</label>
                            <input type="datetime-local" class="form-input" id="tempCodeValidFrom">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valid Until</label>
                            <input type="datetime-local" class="form-input" id="tempCodeValidUntil">
                        </div>
                    </div>
                </div>

                <!-- Door Access -->
                <div class="form-group">
                    <label class="form-label">Access Method *</label>
                    <select class="form-select" id="tempCodeAccessMethod" onchange="updateAccessMethodUI()">
                        <option value="doors">Specific Doors</option>
                        <option value="groups">Access Groups</option>
                    </select>
                </div>

                <div class="form-group" id="tempCodeDoorsGroup">
                    <label class="form-label">Select Doors *</label>
                    <div id="tempCodeDoorsCheckboxes" class="checkbox-group"></div>
                </div>

                <div class="form-group" id="tempCodeGroupsGroup" style="display: none;">
                    <label class="form-label">Select Groups *</label>
                    <div id="tempCodeGroupsCheckboxes" class="checkbox-group"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes (optional)</label>
                    <textarea class="form-textarea" id="tempCodeNotes" 
                              placeholder="e.g., Contact: 555-1234, Purpose: HVAC repair"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeTempCodeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="document.getElementById('tempCodeForm').requestSubmit()">
                üíæ Save
            </button>
        </div>
    </div>
</div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="toast-icon" id="toastIcon"></div>
        <div class="toast-message" id="toastMessage"></div>
    </div>

<script>
'use strict';

console.log('üî• SCRIPT STARTING...');

// ==================== SINGLE DOMCONTENTLOADED LISTENER ====================
document.addEventListener('DOMContentLoaded', async function() {
    console.log('‚úÖ DOM Ready');
    
    // 1. Setup login handler
    const loginForm = document.getElementById('loginForm');
    
    if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('üîê Login form submitted');
            
            hideLoginError();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const remember = document.getElementById('loginRemember').checked;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',  // ‚úÖ Include cookies
                    body: JSON.stringify({ username, password, remember })
                });
                
                const data = await response.json();
                console.log('Login response:', data);
                
                if (data.success) {
                    console.log('‚úÖ Login successful!');
                    hideLoginOverlay();
                    isAuthenticated = true;
                    
                    showToast('Login successful!', 'success');
                    
                    // Load dashboard data
                    loadStats();
                    loadDoors();
                    loadPendingBoards();
                    loadEmergencyStatus();
                    
                } else {
                    console.log('‚ùå Login failed:', data.message);
                    showLoginError(data.message || 'Invalid credentials');
                }
            } catch (error) {
                console.error('‚ùå Login error:', error);
                showLoginError('Connection error. Please try again.');
            }
        });
    }
    
    // 2. Check authentication and load dashboard
    console.log('üöÄ Checking authentication...');
    const isAuthed = await checkAuthStatus();
    console.log('Auth result:', isAuthed);
    
    if (isAuthed) {
        console.log('‚úÖ Loading dashboard...');
        loadStats();
        loadDoors();
        loadPendingBoards();
        loadEmergencyStatus();
        
        // Refresh data every 15 seconds
        setInterval(() => {
            if (isAuthenticated) {
                loadStats();
                loadPendingBoards();
                loadEmergencyStatus();
        
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabText = activeTab.textContent.trim();
                    if (tabText.includes('Doors')) loadDoors();
                    if (tabText.includes('Boards')) loadBoards();
                    if (tabText.includes('Users')) loadUsers();
                    if (tabText.includes('Groups')) loadGroups();
                    if (tabText.includes('Schedules')) loadSchedules();
                    if (tabText.includes('Temp')) loadTempCodes();
                    if (tabText.includes('Logs')) {
                        loadLogFilterOptions();
                        loadLogs();
                    }
                }
            }
        }, 15000);
    } else {
        console.log('‚è∏Ô∏è Not authenticated - waiting for login');
    }
});


        // ==================== AUTHENTICATION (FLASK SESSION-BASED) ====================
let isAuthenticated = false;
let rememberDays = 30;

async function checkAuthStatus() {
    try {
        const response = await fetch('/api/auth-status', {
            credentials: 'same-origin'  // ‚úÖ Include session cookies
        });
        
        const data = await response.json();
        console.log('üîê Auth status:', data);
        
        // Update remember days
        if (data.remember_days) {
            rememberDays = data.remember_days;
            const rememberDaysEl = document.getElementById('rememberDays');
            if (rememberDaysEl) {
                rememberDaysEl.textContent = rememberDays;
            }
        }
        
        // Check if auth is required
        if (!data.auth_required) {
            console.log('‚úÖ Auth not required');
            hideLoginOverlay();
            isAuthenticated = true;
            return true;
        }
        
        // Check if authenticated
        if (data.authenticated) {
            console.log('‚úÖ Authenticated via session');
            hideLoginOverlay();
            isAuthenticated = true;
            return true;
        } else {
            console.log('‚ùå Not authenticated');
            showLoginOverlay();
            isAuthenticated = false;
            
            if (data.password_changed) {
                showLoginError('Password changed. Please log in again.');
            }
            
            return false;
        }
    } catch (error) {
        console.error('‚ùå Auth check failed:', error);
        showLoginOverlay();
        isAuthenticated = false;
        return false;
    }
}

function showLoginOverlay() {
    const overlay = document.getElementById('loginOverlay');
    if (overlay) {
        overlay.classList.remove('hidden');
        const usernameInput = document.getElementById('loginUsername');
        if (usernameInput) usernameInput.focus();
    }
}

function hideLoginOverlay() {
    const overlay = document.getElementById('loginOverlay');
    if (overlay) {
        overlay.classList.add('hidden');
    }
}

function showLoginError(message) {
    const errorDiv = document.getElementById('loginError');
    const errorText = document.getElementById('loginErrorText');
    if (errorDiv && errorText) {
        errorText.textContent = message;
        errorDiv.classList.add('show');
    }
}

function hideLoginError() {
    const errorDiv = document.getElementById('loginError');
    if (errorDiv) {
        errorDiv.classList.remove('show');
    }
}

function togglePasswordVisibility() {
    const passwordInput = document.getElementById('loginPassword');
    const toggleBtn = document.querySelector('.password-toggle');
    
    if (passwordInput && toggleBtn) {
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleBtn.textContent = 'üôà';
        } else {
            passwordInput.type = 'password';
            toggleBtn.textContent = 'üëÅÔ∏è';
        }
    }
}

async function handleLogout() {
    try {
        await fetch('/api/logout', {
            method: 'POST',
            credentials: 'same-origin'  // ‚úÖ Include session cookies
        });
        
        isAuthenticated = false;
        showLoginOverlay();
        
        // Reset form
        const loginForm = document.getElementById('loginForm');
        if (loginForm) loginForm.reset();
        
        showToast('Logged out successfully', 'success');
        
        // Reload after 1 second
        setTimeout(() => {
            window.location.reload();
        }, 1000);
        
    } catch (error) {
        console.error('Logout error:', error);
        window.location.reload();
    }
}

        
        // ==================== GLOBAL STATE ====================
        let currentBoardId = null;
        let currentUserId = null;
        let currentGroupId = null;
        let currentScheduleId = null;
        let currentDoorId = null;
        let doorSchedules = [];
        let emergencyAction = null;
        let allGroups = [];
        let allSchedules = [];
        let allDoors = [];

        // ==================== INITIALIZATION ====================
        
        // ==================== TAB MANAGEMENT ====================
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
        
            // Show selected tab content
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // Find and activate the correct tab button using onclick attribute matching
            const allTabs = document.querySelectorAll('.tab');
            allTabs.forEach(tab => {
                const onclickAttr = tab.getAttribute('onclick') || '';
                if (onclickAttr.includes(`'${tabName}'`)) {
                    tab.classList.add('active');
                }
            });
        
            // Load data for tab
            if (tabName === 'boards') loadBoards();
            if (tabName === 'doors') loadDoors();
            if (tabName === 'scheduleTemplates') loadScheduleTemplates();
            if (tabName === 'users') loadUsers();
            if (tabName === 'groups') loadGroups();
            if (tabName === 'schedules') loadSchedules();
            if (tabName === 'emergency') loadEmergencyControls();
            if (tabName === 'tempcodes') loadTempCodes();
            if (tabName === 'logs') {
                loadLogFilterOptions();
                loadLogs();
            }
        }
        // ==================== STATS ====================
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('statOnlineBoards').textContent = 
                        data.stats.online_boards + '/' + data.stats.total_boards;
                    document.getElementById('statActiveUsers').textContent =
                        data.stats.active_users + '/' + data.stats.total_users;
                    document.getElementById('statTotalDoors').textContent = data.stats.total_doors;
                    document.getElementById('statTodayEvents').textContent = data.stats.today_events;
                    
                    if (data.stats.emergency_active > 0) {
                        document.getElementById('statEmergencyCard').style.display = 'block';
                        document.getElementById('statEmergencyActive').textContent = data.stats.emergency_active;
                    } else {
                        document.getElementById('statEmergencyCard').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ==================== EMERGENCY STATUS ====================
        async function loadEmergencyStatus() {
            try {
                const response = await fetch('/api/emergency-status');
                const data = await response.json();

                if (data.success) {
                    const hasEmergency = data.emergency_boards.length > 0 || data.emergency_doors.length > 0;
                    
                    if (hasEmergency) {
                        document.getElementById('emergencyAlert').classList.add('active');
                        
                        let alertText = '';
                        if (data.emergency_boards.length > 0) {
                            const board = data.emergency_boards[0];
                            const mode = board.emergency_mode === 'lock' ? 'LOCKDOWN' : 'EVACUATION';
                            alertText = `${board.name}: ${mode} - Activated by ${board.emergency_activated_by}`;
                        } else if (data.emergency_doors.length > 0) {
                            alertText = `${data.emergency_doors.length} door(s) in override mode`;
                        }
                        
                        document.getElementById('emergencyAlertText').textContent = alertText;
                    } else {
                        document.getElementById('emergencyAlert').classList.remove('active');
                    }
                }
            } catch (error) {
                console.error('Error loading emergency status:', error);
            }
        }

        // ==================== BOARDS ====================
        async function loadBoards() {
            try {
                const response = await fetch('/api/boards');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('boardsList');
                    
                    if (data.boards.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No boards configured yet</p>';
                        return;
                    }

                    container.innerHTML = data.boards.map(board => {
                        const isEmergency = board.emergency_mode !== null;
                        const emergencyClass = isEmergency ? 'emergency-active' : '';
                        
                        return `
                            <div class="card ${emergencyClass}">
                                <div class="card-header">
                                    <div class="card-title">${board.name}</div>
                                    <span class="badge ${board.online ? 'badge-success' : 'badge-danger'}">
                                        ${board.online ? 'üü¢ Online' : 'üî¥ Offline'}
                                    </span>
                                </div>
                                ${isEmergency ? `
                                    <div style="background: #fef2f2; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                                        <span class="badge badge-emergency">
                                            üö® ${board.emergency_mode === 'lock' ? 'LOCKED' : 'UNLOCKED'}
                                        </span>
                                        <div style="font-size: 12px; color: #991b1b; margin-top: 5px;">
                                            By: ${board.emergency_activated_by || 'Unknown'}
                                        </div>
                                    </div>
                                ` : ''}
                                <div class="card-body">
                                    <div class="card-info">
                                        <span class="card-info-label">IP Address:</span>
                                        <span class="card-info-value">${board.ip_address}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Door 1:</span>
                                        <span class="card-info-value">${board.door1_name}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Door 2:</span>
                                        <span class="card-info-value">${board.door2_name}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Last Seen:</span>
                                        <span class="card-info-value">${board.last_seen_text}</span>
                                    </div>
                                    ${board.last_sync ? `
                                        <div class="card-info">
                                            <span class="card-info-label">Last Sync:</span>
                                            <span class="card-info-value">${board.last_sync}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-success btn-small" 
                                            onclick="syncBoard(${board.id})"
                                            ${!board.online ? 'disabled' : ''}>
                                        üîÑ Sync
                                    </button>
                                    <button class="btn btn-secondary btn-small" 
                                            onclick="editBoard(${board.id})">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="btn btn-danger btn-small" 
                                            onclick="deleteBoard(${board.id})">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading boards:', error);
                showToast('Error loading boards', 'error');
            }
        }

        async function syncBoard(boardId) {
            try {
                showToast('Syncing board...', 'info');
                const response = await fetch(`/api/boards/${boardId}/sync`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadBoards();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error syncing board:', error);
                showToast('Error syncing board', 'error');
            }
        }

        async function syncAllBoards() {
            try {
                showToast('Syncing all boards...', 'info');
                const response = await fetch('/api/boards/sync-all', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadBoards();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error syncing boards:', error);
                showToast('Error syncing boards', 'error');
            }
        }

        function openBoardModal(boardId = null) {
            currentBoardId = boardId;
            
            if (boardId) {
                document.getElementById('boardModalTitle').textContent = 'Edit Board';
                // Load board data
                fetch(`/api/boards`)
                    .then(r => r.json())
                    .then(data => {
                        const board = data.boards.find(b => b.id === boardId);
                        if (board) {
                            document.getElementById('boardId').value = board.id;
                            document.getElementById('boardName').value = board.name;
                            document.getElementById('boardIP').value = board.ip_address;
                            document.getElementById('boardDoor1').value = board.door1_name;
                            document.getElementById('boardDoor2').value = board.door2_name;
                        }
                    });
            } else {
                document.getElementById('boardModalTitle').textContent = 'Add Board';
                document.getElementById('boardForm').reset();
                document.getElementById('boardId').value = '';
            }

            document.getElementById('boardModal').classList.add('active');
        }

        function closeBoardModal() {
            document.getElementById('boardModal').classList.remove('active');
        }

        async function saveBoard(event) {
            event.preventDefault();

            const boardId = document.getElementById('boardId').value;
            const boardData = {
                name: document.getElementById('boardName').value,
                ip_address: document.getElementById('boardIP').value,
                door1_name: document.getElementById('boardDoor1').value,
                door2_name: document.getElementById('boardDoor2').value
            };

            try {
                const url = boardId ? `/api/boards/${boardId}` : '/api/boards';
                const method = boardId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(boardData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    closeBoardModal();
                    loadBoards();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving board:', error);
                showToast('Error saving board', 'error');
            }
        }

        function editBoard(boardId) {
            openBoardModal(boardId);
        }

        async function deleteBoard(boardId) {
            if (!confirm('Are you sure you want to delete this board? This will also delete all associated doors.')) {
                return;
            }

            try {
                const response = await fetch(`/api/boards/${boardId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadBoards();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting board:', error);
                showToast('Error deleting board', 'error');
            }
        }

        // ==================== PENDING BOARDS ====================
        async function loadPendingBoards() {
            try {
                const response = await fetch('/api/pending-boards');
                const data = await response.json();

                if (data.success && data.pending_boards.length > 0) {
                    document.getElementById('pendingBoardsNotification').classList.add('show');
                    document.getElementById('pendingBoardsText').textContent = 
                        `${data.pending_boards.length} board(s) ready to be adopted`;
                } else {
                    document.getElementById('pendingBoardsNotification').classList.remove('show');
                }
            } catch (error) {
                console.error('Error loading pending boards:', error);
            }
        }

        async function showPendingBoards() {
            try {
                const response = await fetch('/api/pending-boards');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('pendingBoardsList');

                    if (data.pending_boards.length === 0) {
                        container.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b;">No pending boards</td></tr>';
                    } else {
                        container.innerHTML = data.pending_boards.map(board => `
                            <tr>
                                <td>${board.board_name}</td>
                                <td>${board.ip_address}</td>
                                <td>${board.mac_address}</td>
                                <td>${board.first_seen}</td>
                                <td>
                                    <button class="btn btn-success btn-small"
                                            onclick="showAdoptBoardModal(${board.id}, '${board.board_name.replace(/'/g, "\\'")}', '${board.ip_address}')">
                                        ‚úÖ Adopt
                                    </button>
                                    <button class="btn btn-danger btn-small"
                                            onclick="rejectBoard(${board.id})">
                                        ‚ùå Reject
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }

                    document.getElementById('pendingBoardsModal').classList.add('active');
                }
            } catch (error) {
                console.error('Error showing pending boards:', error);
                showToast('Error loading pending boards', 'error');
            }
        }

        function closePendingBoardsModal() {
            document.getElementById('pendingBoardsModal').classList.remove('active');
        }

        // ==================== CONTROLLER SETTINGS ====================
        let defaultControllerSettings = {
            protocol: 'http',
            address: '',
            port: 8100
        };

        async function loadControllerSettings() {
            try {
                const response = await fetch('/api/controller-settings');
                const data = await response.json();

                if (data.success) {
                    defaultControllerSettings = {
                        protocol: data.settings.default_protocol,
                        address: data.settings.default_controller_address,
                        port: data.settings.default_controller_port
                    };

                    document.getElementById('defaultControllerProtocol').value = data.settings.default_protocol;
                    document.getElementById('defaultControllerAddress').value = data.settings.default_controller_address;
                    document.getElementById('defaultControllerPort').value = data.settings.default_controller_port;

                    updateControllerPreview();
                }
            } catch (error) {
                console.error('Error loading controller settings:', error);
            }
        }

        function toggleControllerSettings() {
            const body = document.getElementById('controllerSettingsBody');
            const btn = document.getElementById('controllerSettingsToggle');

            if (body.style.display === 'none') {
                body.style.display = 'block';
                btn.innerHTML = '‚ñ≤ Hide Settings';
                loadControllerSettings();
            } else {
                body.style.display = 'none';
                btn.innerHTML = '‚ñº Show Settings';
            }
        }

        function updateControllerPreview() {
            const protocol = document.getElementById('defaultControllerProtocol').value;
            const address = document.getElementById('defaultControllerAddress').value;
            const port = document.getElementById('defaultControllerPort').value;

            const preview = document.getElementById('controllerSettingsPreview');
            if (address) {
                preview.textContent = `Preview: ${protocol}://${address}:${port}`;
            } else {
                preview.textContent = 'No default set - will use current browser address';
            }
        }

        // Add event listeners for preview updates
        document.getElementById('defaultControllerProtocol')?.addEventListener('change', updateControllerPreview);
        document.getElementById('defaultControllerAddress')?.addEventListener('input', updateControllerPreview);
        document.getElementById('defaultControllerPort')?.addEventListener('input', updateControllerPreview);

        async function saveControllerSettings() {
            const protocol = document.getElementById('defaultControllerProtocol').value;
            const address = document.getElementById('defaultControllerAddress').value.trim();
            const portValue = document.getElementById('defaultControllerPort').value;
            // Default port: 443 for HTTPS, 8100 for HTTP
            const defaultPort = protocol === 'https' ? 443 : 8100;
            const port = parseInt(portValue) || defaultPort;

            try {
                const response = await fetch('/api/controller-settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        default_protocol: protocol,
                        default_controller_address: address,
                        default_controller_port: port
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Controller settings saved successfully', 'success');
                    defaultControllerSettings = { protocol, address, port: port };
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving controller settings:', error);
                showToast('Error saving controller settings', 'error');
            }
        }

        // ==================== ADOPT BOARD MODAL ====================
        async function showAdoptBoardModal(pendingId, boardName, boardIP) {
            // Load controller settings first
            await loadControllerSettings();

            document.getElementById('adoptPendingId').value = pendingId;
            document.getElementById('adoptBoardName').textContent = boardName;
            document.getElementById('adoptBoardIP').textContent = boardIP;

            // Reset to use default
            document.getElementById('adoptUseDefault').checked = true;
            toggleAdoptControllerFields();

            // Pre-populate with default settings
            document.getElementById('adoptControllerProtocol').value = defaultControllerSettings.protocol;
            document.getElementById('adoptControllerAddress').value = defaultControllerSettings.address;
            document.getElementById('adoptControllerPort').value = defaultControllerSettings.port;

            updateAdoptControllerPreview();

            document.getElementById('adoptBoardModal').classList.add('active');
        }

        function closeAdoptBoardModal() {
            document.getElementById('adoptBoardModal').classList.remove('active');
        }

        function toggleAdoptControllerFields() {
            const useDefault = document.getElementById('adoptUseDefault').checked;
            const protocolField = document.getElementById('adoptControllerProtocol');
            const addressField = document.getElementById('adoptControllerAddress');
            const portField = document.getElementById('adoptControllerPort');

            protocolField.disabled = useDefault;
            addressField.disabled = useDefault;
            portField.disabled = useDefault;

            if (useDefault) {
                // Show default values
                protocolField.value = defaultControllerSettings.protocol;
                addressField.value = defaultControllerSettings.address;
                portField.value = defaultControllerSettings.port;
            }

            updateAdoptControllerPreview();
        }

        function updateAdoptControllerPreview() {
            const useDefault = document.getElementById('adoptUseDefault').checked;
            const protocol = document.getElementById('adoptControllerProtocol').value;
            const address = document.getElementById('adoptControllerAddress').value;
            const port = document.getElementById('adoptControllerPort').value;

            const preview = document.getElementById('adoptControllerPreview');

            if (useDefault) {
                if (defaultControllerSettings.address) {
                    preview.innerHTML = `<strong>Using default:</strong> ${defaultControllerSettings.protocol}://${defaultControllerSettings.address}:${defaultControllerSettings.port}`;
                } else {
                    preview.innerHTML = `<strong>Using default:</strong> Current browser address (auto-detected)`;
                }
            } else {
                if (address) {
                    preview.innerHTML = `<strong>Custom:</strong> ${protocol}://${address}:${port}`;
                } else {
                    preview.innerHTML = `<strong>Custom:</strong> Please enter an address`;
                }
            }
        }

        // Add event listeners for adopt modal preview updates
        document.getElementById('adoptControllerProtocol')?.addEventListener('change', updateAdoptControllerPreview);
        document.getElementById('adoptControllerAddress')?.addEventListener('input', updateAdoptControllerPreview);
        document.getElementById('adoptControllerPort')?.addEventListener('input', updateAdoptControllerPreview);

        async function confirmAdoptBoard() {
            const pendingId = document.getElementById('adoptPendingId').value;
            const useDefault = document.getElementById('adoptUseDefault').checked;

            let adoptData = { use_default: useDefault };

            if (!useDefault) {
                const protocol = document.getElementById('adoptControllerProtocol').value;
                const address = document.getElementById('adoptControllerAddress').value.trim();
                const portValue = document.getElementById('adoptControllerPort').value;
                // Default port: 443 for HTTPS, 8100 for HTTP
                const defaultPort = protocol === 'https' ? 443 : 8100;
                const port = parseInt(portValue) || defaultPort;

                if (!address) {
                    showToast('Please enter a controller address', 'error');
                    return;
                }

                adoptData = {
                    use_default: false,
                    controller_protocol: protocol,
                    controller_address: address,
                    controller_port: port
                };
            }

            try {
                showToast('Adopting board...', 'info');
                const response = await fetch(`/api/pending-boards/${pendingId}/adopt`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(adoptData)
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadPendingBoards();
                    loadBoards();
                    closeAdoptBoardModal();
                    closePendingBoardsModal();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error adopting board:', error);
                showToast('Error adopting board', 'error');
            }
        }

        async function rejectBoard(pendingId) {
            if (!confirm('Are you sure you want to reject this board?')) {
                return;
            }

            try {
                const response = await fetch(`/api/pending-boards/${pendingId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadPendingBoards();
                    showPendingBoards(); // Refresh modal
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error rejecting board:', error);
                showToast('Error rejecting board', 'error');
            }
        }

        // ==================== DOORS ====================
        async function loadDoors() {
            try {
                const response = await fetch('/api/doors');
                const data = await response.json();

                if (data.success) {
                    allDoors = data.doors;
                    const container = document.getElementById('doorsList');
                    
                    if (data.doors.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No doors configured yet</p>';
                        return;
                    }

                    container.innerHTML = data.doors.map(door => {
                        const isEmergency = door.emergency_override !== null;
                        const emergencyClass = isEmergency ? 'emergency-active' : '';
    
                        return `
                            <div class="card ${emergencyClass}">
                                <div class="card-header">
                                    <div class="card-title">${door.name}</div>
                                    <span class="badge ${door.board_online ? 'badge-success' : 'badge-danger'}">
                                        ${door.board_online ? 'üü¢ Online' : 'üî¥ Offline'}
                                    </span>
                                </div>
            
                                <!-- Door Status Banner -->
                                <div style="background: ${door.status_color}20; border-left: 4px solid ${door.status_color}; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                                    <div style="font-size: 16px; font-weight: 700; color: ${door.status_color};">
                                        ${door.status}
                                    </div>
                                    ${door.status_reason ? `
                                        <div style="font-size: 13px; color: #64748b; margin-top: 4px;">
                                            ${door.status_reason}
                                        </div>
                                    ` : ''}
                                </div>
            
                                ${isEmergency ? `
                                    <div style="background: #fef2f2; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                                        <span class="badge badge-emergency">
                                            üö® Override: ${door.emergency_override.toUpperCase()}
                                        </span>
                                    </div>
                                ` : ''}
                                <div class="card-body">
                                    <div class="card-info">
                                        <span class="card-info-label">Board:</span>
                                        <span class="card-info-value">${door.board_name}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">IP Address:</span>
                                        <span class="card-info-value">${door.ip_address}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Door Number:</span>
                                        <span class="card-info-value">${door.door_number}</span>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-success btn-small" 
                                            onclick="unlockDoor(${door.id})"
                                            ${!door.board_online ? 'disabled' : ''}>
                                        üîì Unlock
                                    </button>
                                    <button class="btn btn-secondary btn-small" 
                                            onclick="openDoorScheduleModal(${door.id}, '${door.name}')">
                                        üìÖ Schedule
                                    </button>
                                    <button class="btn btn-secondary btn-small" 
                                            onclick="openDoorSettingsModal(${door.id}, '${door.name}', ${door.unlock_duration || 3000})">
                                        ‚öôÔ∏è Settings
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading doors:', error);
                showToast('Error loading doors', 'error');
            }
        }

        async function unlockDoor(doorId) {
            try {
                const response = await fetch(`/api/doors/${doorId}/unlock`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error unlocking door:', error);
                showToast('Error unlocking door', 'error');
            }
        }

        // ==================== Continue in next message... ====================
        // ==================== EMERGENCY CONTROLS ====================
async function loadEmergencyControls() {
    try {
        const [boardsResponse, doorsResponse] = await Promise.all([
            fetch('/api/boards'),
            fetch('/api/doors')
        ]);

        const boardsData = await boardsResponse.json();
        const doorsData = await doorsResponse.json();

        if (boardsData.success && doorsData.success) {
            const container = document.getElementById('emergencyControlsList');
            
            if (boardsData.boards.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b;">No boards configured</p>';
                return;
            }

            // ‚úÖ Check if any board has emergency active
            const hasAnyEmergency = boardsData.boards.some(b => b.emergency_mode !== null);
            
            // ‚úÖ Build HTML with system-wide controls FIRST, then individual boards
            container.innerHTML = `
                <!-- SYSTEM-WIDE CONTROLS -->
                <div class="emergency-panel" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); border: 3px solid #dc2626;">
                    <div class="emergency-panel-header">
                        <h2 style="color: #991b1b;">üö®üö® SYSTEM-WIDE EMERGENCY CONTROLS</h2>
                    </div>
                    
                    <div class="emergency-board-controls">
                        <div class="emergency-board-info">
                            <div class="emergency-board-name" style="font-size: 20px;">ALL LOCATIONS</div>
                            <div class="emergency-status ${hasAnyEmergency ? 'locked' : 'normal'}">
                                ${hasAnyEmergency ? 'üö® EMERGENCY ACTIVE' : 'üü¢ Normal Operation'}
                            </div>
                        </div>
                        
                        <p style="color: #78350f; margin: 15px 0; font-weight: 600;">
                            ‚ö†Ô∏è These controls affect ALL boards and doors simultaneously
                        </p>
                        
                        <div class="emergency-actions">
                            ${hasAnyEmergency ? `
                                <button class="btn btn-success" onclick="systemEmergencyReset()" style="font-size: 16px; padding: 15px 30px;">
                                    ‚úÖ RESET ALL TO NORMAL
                                </button>
                            ` : `
                                <button class="btn btn-emergency" onclick="systemEmergencyLock()" style="font-size: 16px; padding: 15px 30px;">
                                    üîí LOCK ENTIRE SYSTEM
                                </button>
                                <button class="btn btn-warning" onclick="systemEmergencyUnlock()" style="font-size: 16px; padding: 15px 30px;">
                                    üîì UNLOCK ENTIRE SYSTEM
                                </button>
                            `}
                        </div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 20px 0; color: #64748b;">Individual Board Controls:</h3>
            ` + boardsData.boards.map(board => {
                const boardDoors = doorsData.doors.filter(d => d.board_id === board.id);
                const isEmergency = board.emergency_mode !== null;
                
                return `
                    <div class="emergency-panel">
                        <div class="emergency-panel-header">
                            <h2>üö® ${board.name}</h2>
                        </div>

                        <div class="emergency-board-controls">
                            <div class="emergency-board-info">
                                <div class="emergency-board-name">${board.name}</div>
                                <div class="emergency-status ${isEmergency ? (board.emergency_mode === 'lock' ? 'locked' : 'unlocked') : 'normal'}">
                                    ${isEmergency 
                                        ? (board.emergency_mode === 'lock' ? 'üîí EMERGENCY LOCKED' : 'üîì EMERGENCY UNLOCKED')
                                        : 'üü¢ Normal Operation'
                                    }
                                </div>
                            </div>

                            ${isEmergency ? `
                                <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <strong>Active Since:</strong> ${new Date(board.emergency_activated_at).toLocaleString()}<br>
                                    <strong>Activated By:</strong> ${board.emergency_activated_by || 'Unknown'}<br>
                                    ${board.emergency_auto_reset_at ? `
                                        <strong>Auto-Reset:</strong> ${new Date(board.emergency_auto_reset_at).toLocaleString()}
                                    ` : ''}
                                </div>
                            ` : ''}

                            <div class="emergency-actions">
                                ${isEmergency ? `
                                    <button class="btn btn-success" 
                                            onclick="emergencyReset(${board.id}, '${board.name}')"
                                            ${!board.online ? 'disabled' : ''}>
                                        ‚úÖ Reset to Normal
                                    </button>
                                ` : `
                                    <button class="btn btn-emergency" 
                                            onclick="emergencyLock(${board.id}, '${board.name}')"
                                            ${!board.online ? 'disabled' : ''}>
                                        üîí EMERGENCY LOCK ALL
                                    </button>
                                    <button class="btn btn-warning" 
                                            onclick="emergencyUnlock(${board.id}, '${board.name}')"
                                            ${!board.online ? 'disabled' : ''}>
                                        üîì EMERGENCY UNLOCK ALL
                                    </button>
                                `}
                            </div>

                            <div class="emergency-door-overrides">
                                <h4>Individual Door Controls:</h4>
                                ${boardDoors.map(door => `
                                    <div class="emergency-door-item">
                                        <div>
                                            <div class="emergency-door-name">üö™ ${door.name}</div>
                                            ${door.emergency_override ? `
                                                <span class="badge badge-emergency" style="margin-left: 10px;">
                                                    Override: ${door.emergency_override.toUpperCase()}
                                                </span>
                                            ` : ''}
                                        </div>
                                        <div class="emergency-door-actions">
                                            ${door.emergency_override ? `
                                                <button class="btn btn-success btn-small" 
                                                        onclick="doorOverrideReset(${door.id}, '${door.name}')"
                                                        ${!board.online ? 'disabled' : ''}>
                                                    Reset
                                                </button>
                                            ` : `
                                                <button class="btn btn-danger btn-small" 
                                                        onclick="doorOverrideLock(${door.id}, '${door.name}')"
                                                        ${!board.online ? 'disabled' : ''}>
                                                    üîí Lock
                                                </button>
                                                <button class="btn btn-warning btn-small" 
                                                        onclick="doorOverrideUnlock(${door.id}, '${door.name}')"
                                                        ${!board.online ? 'disabled' : ''}>
                                                    üîì Unlock
                                                </button>
                                            `}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
    } catch (error) {
        console.error('Error loading emergency controls:', error);
        showToast('Error loading emergency controls', 'error');
    }
}

// ‚úÖ System-wide emergency functions
function systemEmergencyLock() {
    emergencyAction = {
        type: 'system-lock'
    };

    document.getElementById('emergencyConfirmText').textContent = 
        `üö®üö® LOCK ENTIRE SYSTEM? This will LOCK ALL DOORS on ALL BOARDS immediately. This should only be used in critical security situations.`;
    document.getElementById('emergencyAutoResetContainer').style.display = 'none';
    document.getElementById('emergencyConfirmButton').textContent = 'üîí LOCK ENTIRE SYSTEM';
    document.getElementById('emergencyActivatedBy').value = '';
    document.getElementById('emergencyConfirmModal').classList.add('active');
}

function systemEmergencyUnlock() {
    emergencyAction = {
        type: 'system-unlock'
    };

    document.getElementById('emergencyConfirmText').textContent = 
        `üö®üö® UNLOCK ENTIRE SYSTEM? This will UNLOCK ALL DOORS on ALL BOARDS for evacuation. All doors will allow free passage.`;
    document.getElementById('emergencyAutoResetContainer').style.display = 'block';
    document.getElementById('emergencyConfirmButton').textContent = 'üîì UNLOCK ENTIRE SYSTEM';
    document.getElementById('emergencyActivatedBy').value = '';
    document.getElementById('emergencyConfirmModal').classList.add('active');
}

function systemEmergencyReset() {
    emergencyAction = {
        type: 'system-reset'
    };

    document.getElementById('emergencyConfirmText').textContent = 
        `Reset emergency mode on ALL BOARDS and return entire system to normal operation?`;
    document.getElementById('emergencyAutoResetContainer').style.display = 'none';
    document.getElementById('emergencyConfirmButton').textContent = '‚úÖ Reset Entire System';
    document.getElementById('emergencyActivatedBy').value = '';
    document.getElementById('emergencyConfirmModal').classList.add('active');
}

// ‚úÖ Per-board emergency functions
function emergencyLock(boardId, boardName) {
    emergencyAction = {
        type: 'lock',
        boardId: boardId,
        boardName: boardName
    };

    document.getElementById('emergencyConfirmText').textContent = 
        `Are you sure you want to EMERGENCY LOCK all doors on "${boardName}"? This will override all schedules and prevent ALL access.`;
    document.getElementById('emergencyAutoResetContainer').style.display = 'none';
    document.getElementById('emergencyConfirmButton').textContent = 'üîí LOCK ALL DOORS';
    document.getElementById('emergencyActivatedBy').value = '';
    document.getElementById('emergencyConfirmModal').classList.add('active');
}

function emergencyUnlock(boardId, boardName) {
    emergencyAction = {
        type: 'unlock',
        boardId: boardId,
        boardName: boardName
    };

    document.getElementById('emergencyConfirmText').textContent = 
        `Are you sure you want to EMERGENCY UNLOCK all doors on "${boardName}"? This will grant FREE ACCESS to all doors for evacuation purposes.`;
    document.getElementById('emergencyAutoResetContainer').style.display = 'block';
    document.getElementById('emergencyConfirmButton').textContent = 'üîì UNLOCK ALL DOORS';
    document.getElementById('emergencyActivatedBy').value = '';
    document.getElementById('emergencyConfirmModal').classList.add('active');
}

function emergencyReset(boardId, boardName) {
    emergencyAction = {
        type: 'reset',
        boardId: boardId,
        boardName: boardName
    };

    document.getElementById('emergencyConfirmText').textContent = 
        `Reset emergency mode on "${boardName}" and return to normal operation?`;
    document.getElementById('emergencyAutoResetContainer').style.display = 'none';
    document.getElementById('emergencyConfirmButton').textContent = '‚úÖ Reset to Normal';
    document.getElementById('emergencyActivatedBy').value = '';
    document.getElementById('emergencyConfirmModal').classList.add('active');
}

// Keep your existing confirmEmergencyAction() function but add system-wide handling at the beginning...

        function doorOverrideLock(doorId, doorName) {
            emergencyAction = {
                type: 'door-lock',
                doorId: doorId,
                doorName: doorName
            };

            document.getElementById('emergencyConfirmText').textContent = 
                `Lock "${doorName}" in emergency mode? This door will be locked regardless of schedules.`;
            document.getElementById('emergencyAutoResetContainer').style.display = 'none';
            document.getElementById('emergencyConfirmButton').textContent = 'üîí Lock Door';
            document.getElementById('emergencyActivatedBy').value = '';
            document.getElementById('emergencyConfirmModal').classList.add('active');
        }

        function doorOverrideUnlock(doorId, doorName) {
            emergencyAction = {
                type: 'door-unlock',
                doorId: doorId,
                doorName: doorName
            };

            document.getElementById('emergencyConfirmText').textContent = 
                `Unlock "${doorName}" in emergency mode? This door will be unlocked regardless of schedules.`;
            document.getElementById('emergencyAutoResetContainer').style.display = 'none';
            document.getElementById('emergencyConfirmButton').textContent = 'üîì Unlock Door';
            document.getElementById('emergencyActivatedBy').value = '';
            document.getElementById('emergencyConfirmModal').classList.add('active');
        }

        function doorOverrideReset(doorId, doorName) {
            emergencyAction = {
                type: 'door-reset',
                doorId: doorId,
                doorName: doorName
            };

            document.getElementById('emergencyConfirmText').textContent = 
                `Reset emergency override on "${doorName}" and return to normal operation?`;
            document.getElementById('emergencyAutoResetContainer').style.display = 'none';
            document.getElementById('emergencyConfirmButton').textContent = '‚úÖ Reset Door';
            document.getElementById('emergencyActivatedBy').value = '';
            document.getElementById('emergencyConfirmModal').classList.add('active');
        }

        function closeEmergencyConfirmModal() {
            document.getElementById('emergencyConfirmModal').classList.remove('active');
            emergencyAction = null;
        }

        async function confirmEmergencyAction() {
            if (!emergencyAction) return;
        
            const activatedBy = document.getElementById('emergencyActivatedBy').value.trim();
            if (!activatedBy) {
                showToast('Please enter your name for the audit log', 'warning');
                return;
            }
        
            try {
                let url, method = 'POST', body = { activated_by: activatedBy };
        
                // ‚úÖ Handle system-wide actions FIRST
                if (emergencyAction.type === 'system-lock') {
                    url = `/api/emergency/system-lock`;
                } else if (emergencyAction.type === 'system-unlock') {
                    url = `/api/emergency/system-unlock`;
                    body.auto_reset_minutes = parseInt(document.getElementById('emergencyAutoReset').value);
                } else if (emergencyAction.type === 'system-reset') {
                    url = `/api/emergency/system-reset`;
                    body.reset_by = activatedBy;
                }
                // Per-board actions
                else if (emergencyAction.type === 'lock') {
                    url = `/api/boards/${emergencyAction.boardId}/emergency-lock`;
                } else if (emergencyAction.type === 'unlock') {
                    url = `/api/boards/${emergencyAction.boardId}/emergency-unlock`;
                    body.auto_reset_minutes = parseInt(document.getElementById('emergencyAutoReset').value);
                } else if (emergencyAction.type === 'reset') {
                    url = `/api/boards/${emergencyAction.boardId}/emergency-reset`;
                    body.reset_by = activatedBy;
                }
                // Per-door actions
                else if (emergencyAction.type === 'door-lock') {
                    url = `/api/doors/${emergencyAction.doorId}/emergency-override`;
                    body.mode = 'lock';
                } else if (emergencyAction.type === 'door-unlock') {
                    url = `/api/doors/${emergencyAction.doorId}/emergency-override`;
                    body.mode = 'unlock';
                } else if (emergencyAction.type === 'door-reset') {
                    url = `/api/doors/${emergencyAction.doorId}/emergency-override`;
                    body.mode = null;
                }
        
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
        
                const data = await response.json();
        
                if (data.success) {
                    showToast(data.message, 'success');
                    closeEmergencyConfirmModal();
                    loadEmergencyControls();
                    loadEmergencyStatus();
                    loadBoards();
                    loadDoors();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error executing emergency action:', error);
                showToast('Error executing emergency action', 'error');
            }
        }
        // ==================== DOOR SCHEDULE (NEW UNIFIED SYSTEM) ====================
        let currentDoorScheduleData = {
            doorId: null,
            doorName: '',
            currentTemplateId: null,
            customSlots: [],
            allTemplates: []
        };

        async function openDoorScheduleModal(doorId, doorName) {
            currentDoorScheduleData = {
                doorId: doorId,
                doorName: doorName,
                currentTemplateId: null,
                customSlots: [],
                allTemplates: []
            };

            document.getElementById('doorScheduleModalTitle').textContent = `üìÖ Schedule: ${doorName}`;
            document.getElementById('doorScheduleDoorId').value = doorId;

            // Reset UI
            document.getElementById('doorScheduleSource').value = '';
            document.getElementById('templateInfoBanner').style.display = 'none';
            document.getElementById('customScheduleEditor').style.display = 'none';
            document.getElementById('doorSchedulePreview').innerHTML = '<p style="color: #94a3b8; text-align: center;">Loading...</p>';

            try {
                // Load all templates
                const templatesResponse = await fetch('/api/schedule-templates');
                const templatesData = await templatesResponse.json();

                if (templatesData.success) {
                    currentDoorScheduleData.allTemplates = templatesData.templates;

                    // Populate template dropdown
                    const optgroup = document.getElementById('doorScheduleTemplateOptions');
                    optgroup.innerHTML = templatesData.templates.map(t => 
                        `<option value="template-${t.id}">üìã ${t.name}</option>`
                    ).join('');
                }

                // Load current door schedules
                const schedulesResponse = await fetch(`/api/door-schedules/${doorId}`);
                const schedulesData = await schedulesResponse.json();

                if (schedulesData.success && schedulesData.schedules.length > 0) {
                    // Check if using a template (name starts with [T:X])
                    const firstSchedule = schedulesData.schedules[0];
                    const templateMatch = firstSchedule.name.match(/^\[T:(\d+)\]/);

                    if (templateMatch) {
                        // Using a template
                        const templateId = parseInt(templateMatch[1]);
                        currentDoorScheduleData.currentTemplateId = templateId;
                        document.getElementById('doorScheduleSource').value = `template-${templateId}`;
                        onScheduleSourceChange();
                    } else {
                        // Custom per-door schedule
                        currentDoorScheduleData.customSlots = convertSchedulesToSlots(schedulesData.schedules);
                        document.getElementById('doorScheduleSource').value = 'custom';
                        onScheduleSourceChange();
                    }
                } else {
                    // No schedule
                    document.getElementById('doorScheduleSource').value = 'none';
                    onScheduleSourceChange();
                }

            } catch (error) {
                console.error('Error loading door schedule:', error);
                showToast('Error loading schedule', 'error');
            }

            document.getElementById('doorScheduleModal').classList.add('active');
        }

        function closeDoorScheduleModal() {
            document.getElementById('doorScheduleModal').classList.remove('active');
            currentDoorScheduleData = {
                doorId: null,
                doorName: '',
                currentTemplateId: null,
                customSlots: [],
                allTemplates: []
            };
        }

        function convertSchedulesToSlots(schedules) {
            // Convert door_schedules format to slots format
            return schedules.map(s => ({
                day_of_week: s.day_of_week,
                start_time: s.start_time,
                end_time: s.end_time,
                mode: s.schedule_type,
                priority: s.priority || 0,
                name: s.name
            }));
        }

        function onScheduleSourceChange() {
            const source = document.getElementById('doorScheduleSource').value;
            const templateBanner = document.getElementById('templateInfoBanner');
            const customEditor = document.getElementById('customScheduleEditor');
            const preview = document.getElementById('doorSchedulePreview');
            const saveBtn = document.getElementById('saveDoorScheduleBtn');

            // Hide all first
            templateBanner.style.display = 'none';
            customEditor.style.display = 'none';

            if (source === '' || source === 'none') {
                // No schedule
                preview.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #64748b;">
                        <div style="font-size: 32px; margin-bottom: 10px;">üîê</div>
                        <p>No schedule applied. Door will operate in <strong>Controlled</strong> mode 24/7.</p>
                        <p style="font-size: 13px;">(Requires credentials for access)</p>
                    </div>
                `;
                saveBtn.disabled = false;

            } else if (source === 'custom') {
                // Custom per-door schedule
                customEditor.style.display = 'block';
                renderCustomScheduleSlots();
                renderSchedulePreview(currentDoorScheduleData.customSlots);
                saveBtn.disabled = false;

            } else if (source.startsWith('template-')) {
                // Template selected
                const templateId = parseInt(source.replace('template-', ''));
                const template = currentDoorScheduleData.allTemplates.find(t => t.id === templateId);

                if (template) {
                    templateBanner.style.display = 'block';
                    document.getElementById('templateInfoName').textContent = template.name;
                    renderSchedulePreview(template.slots);
                }
                saveBtn.disabled = false;
            }
        }

        function renderSchedulePreview(slots) {
            const preview = document.getElementById('doorSchedulePreview');
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            if (!slots || slots.length === 0) {
                preview.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #94a3b8;">
                        <p>No time slots configured</p>
                    </div>
                `;
                return;
            }

            const modeColors = {
                'unlock': { bg: '#d1fae5', border: '#10b981', text: '#065f46', icon: 'üîì' },
                'controlled': { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af', icon: 'üîê' },
                'locked': { bg: '#fee2e2', border: '#ef4444', text: '#991b1b', icon: 'üîí' }
            };

            let html = '<div style="display: grid; gap: 8px;">';

            for (let day = 0; day < 7; day++) {
                const daySlots = slots.filter(s => s.day_of_week === day);

                html += `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; 
                                background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                        <span style="width: 80px; font-weight: 600; color: #374151; font-size: 13px;">
                            ${dayNames[day]}
                        </span>
                        <div style="flex: 1; display: flex; flex-wrap: wrap; gap: 6px;">
                `;

                if (daySlots.length === 0) {
                    html += `<span style="color: #9ca3af; font-size: 13px;">Default (Controlled)</span>`;
                } else {
                    daySlots.forEach(slot => {
                        const mode = slot.mode || slot.schedule_type || 'controlled';
                        const colors = modeColors[mode] || modeColors['controlled'];
                        const startTime = (slot.start_time || '').substring(0, 5);
                        const endTime = (slot.end_time || '').substring(0, 5);

                        html += `
                            <span style="background: ${colors.bg}; color: ${colors.text}; 
                                         padding: 4px 10px; border-radius: 6px; font-size: 12px;
                                         border-left: 3px solid ${colors.border}; font-weight: 500;">
                                ${colors.icon} ${startTime} - ${endTime}
                            </span>
                        `;
                    });
                }

                html += `
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            preview.innerHTML = html;
        }

        function renderCustomScheduleSlots() {
            const container = document.getElementById('doorScheduleSlotsList');
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            if (currentDoorScheduleData.customSlots.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #94a3b8; background: #f8fafc; border-radius: 8px;">
                        <p>No custom slots. Click "‚ûï Add Slot" to create one.</p>
                    </div>
                `;
                return;
            }

            const modeColors = {
                'unlock': { bg: '#d1fae5', border: '#10b981' },
                'controlled': { bg: '#dbeafe', border: '#3b82f6' },
                'locked': { bg: '#fee2e2', border: '#ef4444' }
            };

            container.innerHTML = currentDoorScheduleData.customSlots.map((slot, index) => {
                const colors = modeColors[slot.mode] || modeColors['controlled'];

                return `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 12px;
                                background: ${colors.bg}; border-left: 4px solid ${colors.border}; border-radius: 8px;">
                        <select class="form-select" style="width: 120px;" 
                                onchange="updateCustomSlot(${index}, 'day_of_week', parseInt(this.value))">
                            ${dayNames.map((day, i) => `
                                <option value="${i}" ${slot.day_of_week === i ? 'selected' : ''}>${day}</option>
                            `).join('')}
                        </select>
                        <select class="form-select" style="width: 130px;"
                                onchange="updateCustomSlot(${index}, 'mode', this.value)">
                            <option value="unlock" ${slot.mode === 'unlock' ? 'selected' : ''}>üîì Unlock</option>
                            <option value="controlled" ${slot.mode === 'controlled' ? 'selected' : ''}>üîê Controlled</option>
                            <option value="locked" ${slot.mode === 'locked' ? 'selected' : ''}>üîí Locked</option>
                        </select>
                        <input type="time" class="form-input" style="width: 110px;"
                               value="${(slot.start_time || '09:00:00').substring(0, 5)}"
                               onchange="updateCustomSlot(${index}, 'start_time', this.value + ':00')">
                        <span style="color: #64748b;">to</span>
                        <input type="time" class="form-input" style="width: 110px;"
                               value="${(slot.end_time || '17:00:00').substring(0, 5)}"
                               onchange="updateCustomSlot(${index}, 'end_time', this.value + ':00')">
                        <button type="button" onclick="removeCustomSlot(${index})"
                                style="background: #ef4444; color: white; border: none; border-radius: 50%;
                                       width: 28px; height: 28px; cursor: pointer; font-size: 16px;">√ó</button>
                    </div>
                `;
            }).join('');
        }

        function addDoorScheduleSlot() {
            currentDoorScheduleData.customSlots.push({
                day_of_week: 0,
                start_time: '09:00:00',
                end_time: '17:00:00',
                mode: 'unlock',
                priority: 0
            });
            renderCustomScheduleSlots();
            renderSchedulePreview(currentDoorScheduleData.customSlots);
        }

        function updateCustomSlot(index, field, value) {
            if (currentDoorScheduleData.customSlots[index]) {
                currentDoorScheduleData.customSlots[index][field] = value;
                renderCustomScheduleSlots();
                renderSchedulePreview(currentDoorScheduleData.customSlots);
            }
        }

        function removeCustomSlot(index) {
            currentDoorScheduleData.customSlots.splice(index, 1);
            renderCustomScheduleSlots();
            renderSchedulePreview(currentDoorScheduleData.customSlots);
        }

        function copyMondayToWeekdaysDoor() {
            const mondaySlots = currentDoorScheduleData.customSlots.filter(s => s.day_of_week === 0);

            if (mondaySlots.length === 0) {
                showToast('Add slots for Monday first', 'warning');
                return;
            }

            // Remove Tue-Fri slots
            currentDoorScheduleData.customSlots = currentDoorScheduleData.customSlots.filter(
                s => s.day_of_week === 0 || s.day_of_week > 4
            );

            // Copy Monday to Tue-Fri
            for (let day = 1; day <= 4; day++) {
                mondaySlots.forEach(slot => {
                    currentDoorScheduleData.customSlots.push({
                        ...slot,
                        day_of_week: day
                    });
                });
            }

            renderCustomScheduleSlots();
            renderSchedulePreview(currentDoorScheduleData.customSlots);
            showToast('Copied Monday to Tue-Fri', 'success');
        }

        function goToTemplates() {
            closeDoorScheduleModal();
            showTab('scheduleTemplates');
        }

        async function saveDoorScheduleNew() {
            const doorId = currentDoorScheduleData.doorId;
            const source = document.getElementById('doorScheduleSource').value;

            try {
                if (source === '' || source === 'none') {
                    // Clear all schedules for this door
                    await fetch(`/api/door-schedules/${doorId}`, {
                        method: 'DELETE'
                    });

                    // Remove from any template assignments
                    for (const template of currentDoorScheduleData.allTemplates) {
                        if (template.doors.some(d => d.id === doorId)) {
                            const newDoorIds = template.doors.filter(d => d.id !== doorId).map(d => d.id);
                            await fetch(`/api/schedule-templates/${template.id}/assign-doors`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ door_ids: newDoorIds })
                            });
                        }
                    }

                    showToast('Schedule cleared - door in default controlled mode', 'success');

                } else if (source === 'custom') {
                    // Remove from any template first
                    for (const template of currentDoorScheduleData.allTemplates) {
                        if (template.doors.some(d => d.id === doorId)) {
                            const newDoorIds = template.doors.filter(d => d.id !== doorId).map(d => d.id);
                            await fetch(`/api/schedule-templates/${template.id}/assign-doors`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ door_ids: newDoorIds })
                            });
                        }
                    }

                    // Save custom schedules
                    const schedules = [];
                    const slotsByDay = {};

                    // Group slots by day for naming
                    currentDoorScheduleData.customSlots.forEach(slot => {
                        if (!slotsByDay[slot.day_of_week]) {
                            slotsByDay[slot.day_of_week] = [];
                        }
                        slotsByDay[slot.day_of_week].push(slot);
                    });

                    // Convert to the format expected by saveDoorSchedules
                    currentDoorScheduleData.customSlots.forEach(slot => {
                        schedules.push({
                            name: 'Custom Schedule',
                            type: slot.mode,
                            days: [slot.day_of_week],
                            start_time: slot.start_time,
                            end_time: slot.end_time,
                            priority: slot.priority || 0
                        });
                    });

                    await fetch(`/api/door-schedules/${doorId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ schedules: schedules })
                    });

                    showToast('Custom schedule saved', 'success');

                } else if (source.startsWith('template-')) {
                    // Assign to template
                    const templateId = parseInt(source.replace('template-', ''));

                    // First remove from any other templates
                    for (const template of currentDoorScheduleData.allTemplates) {
                        if (template.id !== templateId && template.doors.some(d => d.id === doorId)) {
                            const newDoorIds = template.doors.filter(d => d.id !== doorId).map(d => d.id);
                            await fetch(`/api/schedule-templates/${template.id}/assign-doors`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ door_ids: newDoorIds })
                            });
                        }
                    }

                    // Add to selected template
                    const selectedTemplate = currentDoorScheduleData.allTemplates.find(t => t.id === templateId);
                    if (selectedTemplate) {
                        const existingDoorIds = selectedTemplate.doors.map(d => d.id);
                        if (!existingDoorIds.includes(doorId)) {
                            existingDoorIds.push(doorId);
                        }

                        await fetch(`/api/schedule-templates/${templateId}/assign-doors`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ door_ids: existingDoorIds })
                        });
                    }

                    showToast(`Template "${selectedTemplate?.name}" applied to door`, 'success');
                }

                closeDoorScheduleModal();
                loadDoors();

                // Sync boards
                await fetch('/api/boards/sync-all', { method: 'POST' });

            } catch (error) {
                console.error('Error saving door schedule:', error);
                showToast('Error saving schedule', 'error');
            }
        }



        // ==================== DOOR SETTINGS ====================
let currentDoorSettings = null;

async function openDoorSettingsModal(doorId, doorName, unlockDuration) {
    currentDoorSettings = { doorId, doorName };
    
    document.getElementById('doorSettingsModalTitle').textContent = `Settings: ${doorName}`;
    document.getElementById('settingsDoorId').value = doorId;
    document.getElementById('settingsDoorName').value = doorName;
    document.getElementById('settingsUnlockDuration').value = unlockDuration || 3000;
    
    document.getElementById('doorSettingsModal').classList.add('active');
}

function closeDoorSettingsModal() {
    document.getElementById('doorSettingsModal').classList.remove('active');
    currentDoorSettings = null;
}

async function saveDoorSettings(event) {
    event.preventDefault();
    
    const doorId = document.getElementById('settingsDoorId').value;
    const unlockDuration = parseInt(document.getElementById('settingsUnlockDuration').value);
    
    try {
        const response = await fetch(`/api/doors/${doorId}/settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ unlock_duration: unlockDuration })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Door settings saved', 'success');
            closeDoorSettingsModal();
            loadDoors();
        } else {
            showToast(data.message || 'Error saving settings', 'error');
        }
    } catch (error) {
        console.error('Error saving door settings:', error);
        showToast('Error saving settings', 'error');
    }
}

        // ==================== USERS ====================
        let allUsersData = [];  // Store all users for filtering

        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();

                if (data.success) {
                    allUsersData = data.users;  // Store for filtering

                    // Populate group filter dropdown
                    populateGroupFilter();

                    // Reset filters on reload
                    document.getElementById('userSearchInput').value = '';
                    document.getElementById('userStatusFilter').value = 'all';
                    document.getElementById('userGroupFilter').value = 'all';

                    renderUsers(allUsersData);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Error loading users', 'error');
            }
        }

        let selectModeActive = false;

        function renderUsers(users) {
            const container = document.getElementById('usersList');

            // Reset select all checkbox
            document.getElementById('selectAllUsers').checked = false;
            updateSelectedUsersCount();

            // Check if select mode is active
            const showCheckbox = selectModeActive ? '' : 'display: none;';

            if (users.length === 0) {
                container.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #64748b;">No users found</td></tr>';
                return;
            }

            container.innerHTML = users.map(user => `
                <tr>
                    <td class="select-column" style="${showCheckbox}">
                        <input type="checkbox" class="user-checkbox" value="${user.id}" onchange="updateSelectedUsersCount()">
                    </td>
                    <td><strong>${user.name}</strong></td>
                    <td>
                        <span class="badge ${user.active ? 'badge-success' : 'badge-danger'}">
                            ${user.active ? '‚úÖ Active' : '‚ùå Inactive'}
                        </span>
                    </td>
                    <td>${user.cards.length} card(s)</td>
                    <td>${user.pins.length} PIN(s)</td>
                    <td>${user.groups.length} group(s)</td>
                    <td>${user.schedules.length} schedule(s)</td>
                    <td>
                        <button class="btn btn-secondary btn-small" onclick="editUser(${user.id})">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteUser(${user.id})">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function toggleSelectMode() {
            selectModeActive = !selectModeActive;

            // Toggle visibility of select columns
            const selectColumns = document.querySelectorAll('.select-column');
            selectColumns.forEach(col => {
                col.style.display = selectModeActive ? '' : 'none';
            });

            // Toggle buttons visibility
            document.getElementById('toggleSelectModeBtn').style.display = selectModeActive ? 'none' : 'inline-block';
            document.getElementById('cancelSelectModeBtn').style.display = selectModeActive ? 'inline-block' : 'none';

            // If exiting select mode, clear all selections
            if (!selectModeActive) {
                document.getElementById('selectAllUsers').checked = false;
                document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
                updateSelectedUsersCount();
            }
        }

        function toggleSelectAllUsers(checkbox) {
            const userCheckboxes = document.querySelectorAll('.user-checkbox');
            userCheckboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedUsersCount();
        }

        function updateSelectedUsersCount() {
            const selected = document.querySelectorAll('.user-checkbox:checked').length;
            document.getElementById('selectedUsersCount').textContent = selected;
            // Only show delete button if in select mode AND users are selected
            document.getElementById('deleteSelectedUsersBtn').style.display = (selectModeActive && selected > 0) ? 'inline-block' : 'none';
        }

        async function deleteSelectedUsers() {
            const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));

            if (selectedIds.length === 0) {
                showToast('No users selected', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedIds.length} user(s)? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch('/api/users/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_ids: selectedIds })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(`Successfully deleted ${data.deleted} user(s)`, 'success');
                    // Exit select mode after successful delete
                    toggleSelectMode();
                    loadUsers();
                    loadStats();
                } else {
                    showToast(data.message || 'Error deleting users', 'error');
                }
            } catch (error) {
                console.error('Error deleting users:', error);
                showToast('Error deleting users', 'error');
            }
        }

        function applyUserFilters() {
            const searchTerm = document.getElementById('userSearchInput').value.toLowerCase().trim();
            const statusFilter = document.getElementById('userStatusFilter').value;
            const groupFilter = document.getElementById('userGroupFilter').value;

            let filtered = allUsersData;

            // Filter by status
            if (statusFilter === 'active') {
                filtered = filtered.filter(user => user.active);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(user => !user.active);
            }

            // Filter by group
            if (groupFilter !== 'all') {
                filtered = filtered.filter(user =>
                    user.groups.some(group => group.id === parseInt(groupFilter))
                );
            }

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(user => {
                    // Search by name
                    if (user.name.toLowerCase().includes(searchTerm)) return true;

                    // Search by card number
                    if (user.cards.some(card => card.card_number && card.card_number.toLowerCase().includes(searchTerm))) return true;

                    // Search by group name
                    if (user.groups.some(group => group.name && group.name.toLowerCase().includes(searchTerm))) return true;

                    return false;
                });
            }

            renderUsers(filtered);
        }

        function populateGroupFilter() {
            // Get unique groups from all users
            const groupsMap = new Map();
            allUsersData.forEach(user => {
                user.groups.forEach(group => {
                    if (!groupsMap.has(group.id)) {
                        groupsMap.set(group.id, group.name);
                    }
                });
            });

            const groupSelect = document.getElementById('userGroupFilter');
            const currentValue = groupSelect.value;

            // Keep "All Groups" and add the rest
            groupSelect.innerHTML = '<option value="all">All Groups</option>';
            groupsMap.forEach((name, id) => {
                groupSelect.innerHTML += `<option value="${id}">${name}</option>`;
            });

            // Restore selection if still valid
            if (currentValue !== 'all' && groupsMap.has(parseInt(currentValue))) {
                groupSelect.value = currentValue;
            }
        }

        // Keep old function name for compatibility
        function filterUsers(searchTerm) {
            document.getElementById('userSearchInput').value = searchTerm;
            applyUserFilters();
        }

        async function openUserModal(userId = null) {
            currentUserId = userId;

            // Load groups and schedules first
            await Promise.all([loadGroupsForUser(), loadSchedulesForUser()]);

            if (userId) {
                document.getElementById('userModalTitle').textContent = 'Edit User';
                const response = await fetch('/api/users');
                const data = await response.json();
                const user = data.users.find(u => u.id === userId);

                if (user) {
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userName').value = user.name;
                    document.getElementById('userActive').checked = user.active;
                    document.getElementById('userValidFrom').value = user.valid_from || '';
                    document.getElementById('userValidUntil').value = user.valid_until || '';
                    document.getElementById('userNotes').value = user.notes || '';

                    // Load cards with new format
                    const cardsContainer = document.getElementById('userCards');
                    cardsContainer.innerHTML = user.cards.map((card, index) => {
                        const cardNumber = card.card_number || '';
                        const parts = cardNumber.split(' ');
                        const hasSpace = parts.length >= 2;
                        const facility = hasSpace ? parts[0] : '';
                        const cardCode = hasSpace ? parts.slice(1).join(' ') : cardNumber;
                        const isCodeOnly = !hasSpace;
                        const radioName = `cardFormat_edit_${index}_${Date.now()}`;

                        return `
                        <div class="card-entry" style="margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9em;">
                                    <input type="radio" name="${radioName}" value="full" ${!isCodeOnly ? 'checked' : ''} onchange="toggleCardFormat(this)">
                                    Full (Facility + Card)
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9em;">
                                    <input type="radio" name="${radioName}" value="code_only" ${isCodeOnly ? 'checked' : ''} onchange="toggleCardFormat(this)">
                                    Card Code Only
                                </label>
                                <button type="button" class="btn btn-danger btn-small" onclick="this.closest('.card-entry').remove()" style="margin-left: auto;">√ó</button>
                            </div>
                            <div class="card-inputs" style="display: flex; gap: 10px;">
                                <input type="text" class="form-input facility-input" placeholder="Facility (e.g., 173)" style="width: 120px; ${isCodeOnly ? 'display: none;' : ''}" value="${facility}">
                                <input type="text" class="form-input card-code-input" placeholder="${isCodeOnly ? 'Card Code - last 5 digits (e.g., 37764)' : 'Card Code (e.g., 37764)'}" style="flex: 1;" value="${cardCode}">
                            </div>
                        </div>
                        `;
                    }).join('');

                    // Load PINs
                    const pinsContainer = document.getElementById('userPins');
                    pinsContainer.innerHTML = user.pins.map((pin, index) => `
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="form-input" value="${pin.pin}" 
                                   placeholder="PIN" data-pin-index="${index}">
                            <button type="button" class="btn btn-danger btn-small" 
                                    onclick="this.parentElement.remove()">√ó</button>
                        </div>
                    `).join('');

                    // Select groups
                    user.groups.forEach(group => {
                        const checkbox = document.getElementById(`user-group-${group.id}`);
                        if (checkbox) checkbox.checked = true;
                    });

                    // Select schedules
                    user.schedules.forEach(schedule => {
                        const checkbox = document.getElementById(`user-schedule-${schedule.id}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } else {
                document.getElementById('userModalTitle').textContent = 'Add User';
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
                document.getElementById('userCards').innerHTML = '';
                document.getElementById('userPins').innerHTML = '';
            }

            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        async function loadGroupsForUser() {
            const response = await fetch('/api/groups');
            const data = await response.json();

            if (data.success) {
                allGroups = data.groups;
                const container = document.getElementById('userGroupsCheckboxes');

                if (data.groups.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; font-size: 13px;">No groups available. Create groups first.</p>';
                } else {
                    container.innerHTML = data.groups.map(group => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="user-group-${group.id}" value="${group.id}">
                            <label for="user-group-${group.id}">
                                <span style="display: inline-block; width: 12px; height: 12px; background: ${group.color}; border-radius: 3px; margin-right: 8px;"></span>
                                ${group.name}
                            </label>
                        </div>
                    `).join('');
                }
            }
        }

        async function loadSchedulesForUser() {
            const response = await fetch('/api/schedules');
            const data = await response.json();

            if (data.success) {
                allSchedules = data.schedules;
                const container = document.getElementById('userSchedulesCheckboxes');

                if (data.schedules.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; font-size: 13px;">No schedules available. Leave empty for 24/7 access.</p>';
                } else {
                    container.innerHTML = data.schedules.map(schedule => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="user-schedule-${schedule.id}" value="${schedule.id}">
                            <label for="user-schedule-${schedule.id}">
                                ${schedule.name} ${schedule.active ? '' : '(Inactive)'}
                            </label>
                        </div>
                    `).join('');
                }
            }
        }

        function addCardInput() {
            const container = document.getElementById('userCards');
            const div = document.createElement('div');
            div.className = 'card-entry';
            div.style.cssText = 'margin-bottom: 15px; padding: 10px; background: var(--bg-secondary); border-radius: 8px;';
            div.innerHTML = `
                <div style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9em;">
                        <input type="radio" name="cardFormat_${Date.now()}" value="full" checked onchange="toggleCardFormat(this)">
                        Full (Facility + Card)
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 0.9em;">
                        <input type="radio" name="cardFormat_${Date.now()}" value="code_only" onchange="toggleCardFormat(this)">
                        Card Code Only
                    </label>
                    <button type="button" class="btn btn-danger btn-small" onclick="this.closest('.card-entry').remove()" style="margin-left: auto;">√ó</button>
                </div>
                <div class="card-inputs" style="display: flex; gap: 10px;">
                    <input type="text" class="form-input facility-input" placeholder="Facility (e.g., 173)" style="width: 120px;">
                    <input type="text" class="form-input card-code-input" placeholder="Card Code (e.g., 37764)" style="flex: 1;">
                </div>
            `;
            container.appendChild(div);
        }

        function toggleCardFormat(radio) {
            const cardEntry = radio.closest('.card-entry');
            const facilityInput = cardEntry.querySelector('.facility-input');
            const cardCodeInput = cardEntry.querySelector('.card-code-input');

            if (radio.value === 'code_only') {
                facilityInput.style.display = 'none';
                facilityInput.value = '';
                cardCodeInput.placeholder = 'Card Code - last 5 digits (e.g., 37764)';
            } else {
                facilityInput.style.display = 'block';
                cardCodeInput.placeholder = 'Card Code (e.g., 37764)';
            }
        }

        function addPinInput() {
            const container = document.getElementById('userPins');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            div.innerHTML = `
                <input type="text" class="form-input" placeholder="PIN (4-8 digits)" maxlength="8">
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        }

        async function saveUser(event) {
            event.preventDefault();

            const userId = document.getElementById('userId').value;

            // Collect cards from new format
            const cards = [];
            document.querySelectorAll('#userCards .card-entry').forEach(entry => {
                const facilityInput = entry.querySelector('.facility-input');
                const cardCodeInput = entry.querySelector('.card-code-input');
                const isCodeOnly = entry.querySelector('input[value="code_only"]')?.checked;

                const facility = facilityInput?.value?.trim() || '';
                const cardCode = cardCodeInput?.value?.trim() || '';

                if (cardCode) {
                    // If code_only mode or no facility entered, store just the card code
                    // Otherwise store as "facility cardcode"
                    const cardNumber = (isCodeOnly || !facility) ? cardCode : `${facility} ${cardCode}`;
                    cards.push({ number: cardNumber });
                }
            });

            // Collect PINs
            const pins = Array.from(document.querySelectorAll('#userPins input[type="text"]'))
                .map(input => ({ pin: input.value.trim() }))
                .filter(pin => pin.pin);

            // Collect selected groups
            const group_ids = Array.from(document.querySelectorAll('#userGroupsCheckboxes input:checked'))
                .map(input => parseInt(input.value));

            // Collect selected schedules
            const schedule_ids = Array.from(document.querySelectorAll('#userSchedulesCheckboxes input:checked'))
                .map(input => parseInt(input.value));

            if (group_ids.length === 0) {
                showToast('Please select at least one group', 'warning');
                return;
            }

            const userData = {
                name: document.getElementById('userName').value,
                active: document.getElementById('userActive').checked,
                valid_from: document.getElementById('userValidFrom').value || null,
                valid_until: document.getElementById('userValidUntil').value || null,
                notes: document.getElementById('userNotes').value,
                cards: cards,
                pins: pins,
                group_ids: group_ids,
                schedule_ids: schedule_ids
            };

            try {
                const url = userId ? `/api/users/${userId}` : '/api/users';
                const method = userId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    closeUserModal();
                    loadUsers();

                    // Sync all boards
                    await fetch('/api/boards/sync-all', { method: 'POST' });
                    showToast('All boards synced with user changes', 'success');
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                showToast('Error saving user', 'error');
            }
        }

        function editUser(userId) {
            openUserModal(userId);
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadUsers();

                    // Sync all boards
                    await fetch('/api/boards/sync-all', { method: 'POST' });
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Error deleting user', 'error');
            }
        }

        // ==================== GROUPS ====================
        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                const data = await response.json();

                if (data.success) {
                    allGroups = data.groups;
                    const container = document.getElementById('groupsList');

                    if (data.groups.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No groups configured yet</p>';
                        return;
                    }

                    container.innerHTML = data.groups.map(group => `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span style="display: inline-block; width: 16px; height: 16px; background: ${group.color}; border-radius: 4px; margin-right: 8px;"></span>
                                    ${group.name}
                                </div>
                                <span class="badge badge-info">${group.door_count} door(s)</span>
                            </div>
                            <div class="card-body">
                                ${group.description ? `<p style="color: #64748b; margin-bottom: 15px;">${group.description}</p>` : ''}

                                <!-- Assigned Doors -->
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 600;">ASSIGNED DOORS:</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px;">
                                    ${group.doors && group.doors.length > 0
                                        ? group.doors.map(door => `
                                            <span style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                                üö™ ${door.name}
                                            </span>
                                        `).join('')
                                        : '<span style="color: #94a3b8; font-size: 13px;">No doors assigned</span>'
                                    }
                                </div>

                                <div class="card-info">
                                    <span class="card-info-label">Users in group:</span>
                                    <span class="card-info-value">${group.user_count}</span>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-secondary btn-small" onclick="editGroup(${group.id})">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteGroup(${group.id})">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading groups:', error);
                showToast('Error loading groups', 'error');
            }
        }

        async function openGroupModal(groupId = null) {
            currentGroupId = groupId;

            // Load doors
            await loadDoorsForGroup();

            if (groupId) {
                document.getElementById('groupModalTitle').textContent = 'Edit Group';
                const response = await fetch('/api/groups');
                const data = await response.json();
                const group = data.groups.find(g => g.id === groupId);

                if (group) {
                    document.getElementById('groupId').value = group.id;
                    document.getElementById('groupName').value = group.name;
                    document.getElementById('groupDescription').value = group.description || '';
                    document.getElementById('groupColor').value = group.color;

                    // Select doors
                    group.doors.forEach(door => {
                        const checkbox = document.getElementById(`group-door-${door.id}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } else {
                document.getElementById('groupModalTitle').textContent = 'Add Group';
                document.getElementById('groupForm').reset();
                document.getElementById('groupId').value = '';
            }

            document.getElementById('groupModal').classList.add('active');
        }

        function closeGroupModal() {
            document.getElementById('groupModal').classList.remove('active');
        }

        async function loadDoorsForGroup() {
            const response = await fetch('/api/doors');
            const data = await response.json();

            if (data.success) {
                allDoors = data.doors;
                const container = document.getElementById('groupDoorsCheckboxes');

                if (data.doors.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; font-size: 13px;">No doors available. Add boards first.</p>';
                } else {
                    container.innerHTML = data.doors.map(door => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="group-door-${door.id}" value="${door.id}">
                            <label for="group-door-${door.id}">
                                ${door.board_name} - ${door.name}
                            </label>
                        </div>
                    `).join('');
                }
            }
        }

        async function saveGroup(event) {
            event.preventDefault();

            const groupId = document.getElementById('groupId').value;

            // Collect selected doors
            const door_ids = Array.from(document.querySelectorAll('#groupDoorsCheckboxes input:checked'))
                .map(input => parseInt(input.value));

            if (door_ids.length === 0) {
                showToast('Please select at least one door', 'warning');
                return;
            }

            const groupData = {
                name: document.getElementById('groupName').value,
                description: document.getElementById('groupDescription').value,
                color: document.getElementById('groupColor').value,
                door_ids: door_ids
            };

            try {
                const url = groupId ? `/api/groups/${groupId}` : '/api/groups';
                const method = groupId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(groupData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    closeGroupModal();
                    loadGroups();

                    // Sync all boards
                    await fetch('/api/boards/sync-all', { method: 'POST' });
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving group:', error);
                showToast('Error saving group', 'error');
            }
        }

        function editGroup(groupId) {
            openGroupModal(groupId);
        }

        async function deleteGroup(groupId) {
            if (!confirm('Are you sure you want to delete this group?')) {
                return;
            }

            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadGroups();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting group:', error);
                showToast('Error deleting group', 'error');
            }
        }

        // ==================== SCHEDULES (User Time Restrictions) ====================
        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules');
                const data = await response.json();

                if (data.success) {
                    allSchedules = data.schedules;
                    const container = document.getElementById('schedulesList');

                    if (data.schedules.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No schedules configured yet</p>';
                        return;
                    }

                    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

                    container.innerHTML = data.schedules.map(schedule => {
                        let timeRangesText = '';
                        if (schedule.times && schedule.times.length > 0) {
                            const grouped = {};
                            schedule.times.forEach(t => {
                                const key = `${t.start_time}-${t.end_time}`;
                                if (!grouped[key]) grouped[key] = [];
                                grouped[key].push(dayNames[t.day_of_week]);
                            });

                            timeRangesText = Object.entries(grouped).map(([time, days]) => {
                                const [start, end] = time.split('-');
                                return `${days.join(', ')}: ${start.substring(0, 5)} - ${end.substring(0, 5)}`;
                            }).join('<br>');
                        }

                        return `
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">${schedule.name}</div>
                                    <span class="badge ${schedule.active ? 'badge-success' : 'badge-danger'}">
                                        ${schedule.active ? '‚úÖ Active' : '‚ùå Inactive'}
                                    </span>
                                </div>
                                <div class="card-body">
                                    ${schedule.description ? `<p style="color: #64748b; margin-bottom: 15px;">${schedule.description}</p>` : ''}
                                    <div class="card-info">
                                        <span class="card-info-label">Time Ranges:</span>
                                    </div>
                                    <div style="font-size: 13px; color: #1e293b; margin-top: 5px;">
                                        ${timeRangesText || 'No time ranges'}
                                    </div>
                                    <div class="card-info" style="margin-top: 10px;">
                                        <span class="card-info-label">Users:</span>
                                        <span class="card-info-value">${schedule.user_count}</span>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-secondary btn-small" onclick="editSchedule(${schedule.id})">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteSchedule(${schedule.id})">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading schedules:', error);
                showToast('Error loading schedules', 'error');
            }
        }

        async function openScheduleModal(scheduleId = null) {
            currentScheduleId = scheduleId;

            if (scheduleId) {
                document.getElementById('scheduleModalTitle').textContent = 'Edit Schedule';
                const response = await fetch('/api/schedules');
                const data = await response.json();
                const schedule = data.schedules.find(s => s.id === scheduleId);

                if (schedule) {
                    document.getElementById('scheduleId').value = schedule.id;
                    document.getElementById('scheduleName').value = schedule.name;
                    document.getElementById('scheduleDescription').value = schedule.description || '';
                    document.getElementById('scheduleActive').checked = schedule.active;

                    // Load time ranges
                    const container = document.getElementById('scheduleTimeRanges');
                    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                    container.innerHTML = schedule.times.map((time) => `
                        <div class="schedule-time-range-item" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
                                <select class="form-select schedule-day">
                                    ${dayNames.map((day, dayIndex) => `
                                        <option value="${dayIndex}" ${time.day_of_week === dayIndex ? 'selected' : ''}>
                                            ${day}
                                        </option>
                                    `).join('')}
                                </select>
                                <input type="time" class="form-input schedule-start" value="${time.start_time.substring(0, 5)}">
                                <input type="time" class="form-input schedule-end" value="${time.end_time.substring(0, 5)}">
                                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.parentElement.remove()">√ó</button>
                            </div>
                        </div>
                    `).join('');
                }
            } else {
                document.getElementById('scheduleModalTitle').textContent = 'Add Schedule';
                document.getElementById('scheduleForm').reset();
                document.getElementById('scheduleId').value = '';
                document.getElementById('scheduleTimeRanges').innerHTML = '';
            }

            document.getElementById('scheduleModal').classList.add('active');
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
        }

        function addScheduleTimeRange() {
            const container = document.getElementById('scheduleTimeRanges');
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            const div = document.createElement('div');
            div.className = 'schedule-time-range-item';
            div.style.cssText = 'border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px;';
            div.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
                    <select class="form-select schedule-day">
                        ${dayNames.map((day, dayIndex) => `<option value="${dayIndex}">${day}</option>`).join('')}
                    </select>
                    <input type="time" class="form-input schedule-start" value="09:00">
                    <input type="time" class="form-input schedule-end" value="17:00">
                    <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            container.appendChild(div);
        }

        async function saveSchedule(event) {
            if (event) event.preventDefault();

            const scheduleId = document.getElementById('scheduleId').value;

            // Collect time ranges using the new class-based selectors
            const times = [];
            const timeRanges = document.querySelectorAll('.schedule-time-range-item');

            timeRanges.forEach((range) => {
                const day = range.querySelector('.schedule-day')?.value;
                const start = range.querySelector('.schedule-start')?.value;
                const end = range.querySelector('.schedule-end')?.value;

                if (day !== undefined && start && end) {
                    times.push({
                        day_of_week: parseInt(day),
                        start_time: start + ':00',
                        end_time: end + ':00'
                    });
                }
            });

            console.log('Collected times:', times); // Debug log

            if (times.length === 0) {
                showToast('Please add at least one time range', 'warning');
                return;
            }

            const scheduleData = {
                name: document.getElementById('scheduleName').value,
                description: document.getElementById('scheduleDescription').value,
                active: document.getElementById('scheduleActive').checked,
                times: times
            };

            try {
                const url = scheduleId ? `/api/schedules/${scheduleId}` : '/api/schedules';
                const method = scheduleId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    closeScheduleModal();
                    loadSchedules();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving schedule:', error);
                showToast('Error saving schedule', 'error');
            }
        }

        function editSchedule(scheduleId) {
            openScheduleModal(scheduleId);
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('Are you sure you want to delete this schedule?')) {
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadSchedules();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting schedule:', error);
                showToast('Error deleting schedule', 'error');
            }
        }

        // ==================== LOGS WITH ADVANCED FILTERING ====================
        let logFilterOptions = {};
        let searchTimeout;

        async function loadLogFilterOptions() {
            try {
                const response = await fetch('/api/logs/filter-options');
                const data = await response.json();

                if (data.success) {
                    logFilterOptions = data;

                    // Populate User dropdown
                    const userSelect = document.getElementById('filterUser');
                    const currentUserValue = userSelect.value;
                    userSelect.innerHTML = '<option value="">All Users</option>' +
                        data.users.map(user => 
                            `<option value="${user.id}">${user.name}</option>`
                        ).join('');
                    userSelect.value = currentUserValue;

                    // Populate Board dropdown
                    const boardSelect = document.getElementById('filterBoard');
                    const currentBoardValue = boardSelect.value;
                    boardSelect.innerHTML = '<option value="">All Boards</option>' +
                        data.boards.map(board => 
                            `<option value="${board}">${board}</option>`
                        ).join('');
                    boardSelect.value = currentBoardValue;

                    // Populate Door dropdown
                    const doorSelect = document.getElementById('filterDoor');
                    const currentDoorValue = doorSelect.value;
                    doorSelect.innerHTML = '<option value="">All Doors</option>' +
                        data.doors.map(door => 
                            `<option value="${door.id}">${door.name}</option>`
                        ).join('');
                    doorSelect.value = currentDoorValue;
                }
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        async function loadLogs() {
            try {
                // Build query parameters
                const params = new URLSearchParams();
                
                const limit = document.getElementById('filterLimit')?.value || '100';
                params.append('limit', limit);
        
                const userId = document.getElementById('filterUser')?.value;
                if (userId) params.append('user_id', userId);
        
                const boardName = document.getElementById('filterBoard')?.value;
                if (boardName) params.append('board_name', boardName);
        
                const doorId = document.getElementById('filterDoor')?.value;
                if (doorId) params.append('door_id', doorId);
        
                const credentialType = document.getElementById('filterCredentialType')?.value;
                if (credentialType) params.append('credential_type', credentialType);
        
                const accessGranted = document.getElementById('filterAccessGranted')?.value;
                if (accessGranted) params.append('access_granted', accessGranted);
        
                const dateFrom = document.getElementById('filterDateFrom')?.value;
                if (dateFrom) params.append('date_from', dateFrom);
        
                const dateTo = document.getElementById('filterDateTo')?.value;
                if (dateTo) params.append('date_to', dateTo);
        
                const search = document.getElementById('filterSearch')?.value;
                if (search) params.append('search', search);
        
                const response = await fetch(`/api/logs?${params.toString()}`);
                const data = await response.json();
        
                if (data.success) {
                    const container = document.getElementById('logsList');
                    const countElement = document.getElementById('logsCount');
                    const refreshElement = document.getElementById('logsLastRefresh');
                    
                    countElement.textContent = data.logs.length;
                    
                    // Update last refresh time
                    const now = new Date();
                    refreshElement.textContent = `Last refreshed: ${now.toLocaleTimeString()}`;
        
                    if (data.logs.length === 0) {
                        container.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b; padding: 40px;">No logs match the current filters</td></tr>';
                        return;
                    }
        
                    container.innerHTML = data.logs.map(log => {
                        // Check if it's a temp code
                        const isTempCode = log.temp_code_id || log.credential_type === 'temp_code';
                        const displayName = isTempCode 
                            ? `üé´ ${log.temp_code_name || log.user_name}`
                            : log.user_name || 'Unknown';
                        
                        return `
                            <tr>
                                <td style="white-space: nowrap;">${log.timestamp}</td>
                                <td>${log.board_name || 'N/A'}</td>
                                <td>${log.door_name || 'N/A'}</td>
                                <td><strong>${displayName}</strong></td>
                                <td>
                                    <strong>${log.credential || 'N/A'}</strong><br>
                                    <small style="color: #64748b;">(${log.credential_type || 'unknown'})</small>
                                    ${isTempCode && log.temp_code_remaining ? `<br><small style="color: #10b981;">${log.temp_code_remaining}</small>` : ''}
                                </td>
                                <td style="text-align: center;">
                                    <span class="badge ${log.access_granted ? 'badge-success' : 'badge-danger'}">
                                        ${log.access_granted ? '‚úÖ Granted' : '‚ùå Denied'}
                                    </span>
                                </td>
                                <td>${log.reason}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                showToast('Error loading logs', 'error');
            }
        }

        function searchLogsDebounced() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadLogs();
            }, 500); // Wait 500ms after user stops typing
        }

        function clearLogFilters() {
            document.getElementById('filterUser').value = '';
            document.getElementById('filterBoard').value = '';
            document.getElementById('filterDoor').value = '';
            document.getElementById('filterCredentialType').value = '';
            document.getElementById('filterAccessGranted').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterSearch').value = '';
            document.getElementById('filterLimit').value = '100';
            loadLogs();
        }

        // ==================== SYSTEM BACKUP ====================
        function exportSystemBackup() {
            showToast('Preparing system backup...', 'info');
            window.location.href = '/api/system/export';
        }

        async function importSystemBackup(input) {
            const file = input.files[0];
            if (!file) return;

            if (!confirm('This will import the backup configuration.\n\nExisting users with the same name will be UPDATED.\nNew items will be ADDED.\n\nAre you sure you want to proceed?')) {
                input.value = '';
                return;
            }

            showToast('Importing system backup...', 'info');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/system/import', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    let message = 'Backup imported successfully!\\n\\n';
                    message += `Groups: ${result.stats.groups_imported}\\n`;
                    message += `Users: ${result.stats.users_imported}\\n`;
                    message += `Schedules: ${result.stats.schedules_imported}\\n`;
                    message += `Temp Codes: ${result.stats.temp_codes_imported}\\n`;
                    message += `Door Schedules: ${result.stats.door_schedules_imported}`;

                    if (result.stats.errors && result.stats.errors.length > 0) {
                        message += `\\n\\nWarnings: ${result.stats.errors.length} items had issues`;
                        console.log('Import warnings:', result.stats.errors);
                    }

                    alert(message);
                    showToast('System backup imported successfully!', 'success');

                    // Reload all data
                    loadBoards();
                    loadDoors();
                    loadUsers();
                    loadGroups();
                    loadSchedules();
                    loadTempCodes();
                } else {
                    showToast('Import failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Import error:', error);
                showToast('Error importing backup: ' + error.message, 'error');
            }

            input.value = '';
        }

        // ==================== TOAST ====================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toast.className = 'toast show ' + type;
            toastMessage.textContent = message;

            if (type === 'success') {
                toastIcon.textContent = '‚úÖ';
            } else if (type === 'error') {
                toastIcon.textContent = '‚ùå';
            } else if (type === 'warning') {
                toastIcon.textContent = '‚ö†Ô∏è';
            } else {
                toastIcon.textContent = '‚ÑπÔ∏è';
            }

            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
        // ==================== CSV IMPORT ====================
        async function handleCSVUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showToast('Importing users from CSV...', 'info');
                
                const response = await fetch('/api/users/import', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = `‚úÖ Import complete!\n`;
                    message += `‚Ä¢ ${result.imported} new users created\n`;
                    message += `‚Ä¢ ${result.updated} existing users updated`;
                    
                    if (result.errors.length > 0) {
                        message += `\n\n‚ö†Ô∏è ${result.errors.length} errors:\n`;
                        message += result.errors.slice(0, 5).join('\n');
                        if (result.errors.length > 5) {
                            message += `\n... and ${result.errors.length - 5} more`;
                        }
                    }
                    
                    alert(message);
                    showToast('Users imported successfully!', 'success');
                    loadUsers();
                    
                    // Sync all boards
                    await fetch('/api/boards/sync-all', { method: 'POST' });
                    showToast('All boards synced with new users', 'success');
                } else {
                    showToast('Import failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error importing CSV:', error);
                showToast('Error importing CSV', 'error');
            }
            
            // Reset file input
            input.value = '';
        }

        // ==================== TEMP CODES ====================
        let currentTempCodeId = null;
        
        async function loadTempCodes() {
            try {
                const response = await fetch('/api/temp-codes');
                const data = await response.json();
        
                if (data.success) {
                    const container = document.getElementById('tempCodesList');
                    
                    if (data.temp_codes.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No temporary codes configured yet</p>';
                        return;
                    }
        
                    container.innerHTML = data.temp_codes.map(code => {
                        // ‚úÖ‚úÖ‚úÖ CORRECTED SMART LOGIC ‚úÖ‚úÖ‚úÖ
                        let statusBadge = '';
                        let statusColor = '';
                        
                        // First check if it's actually USABLE (not just active flag)
                        let isUsable = true;
                        let whyNotUsable = '';
                        let totalDoorsAssigned = code.doors ? code.doors.length : 0;
                        
                        // Check 1: Is it disabled?
                        if (!code.active) {
                            // If manually disabled, determine WHY it was disabled
                            
                            // Check usage limits (per-door logic)
                            if (code.usage_type === 'one_time' && code.current_uses >= totalDoorsAssigned) {
                                isUsable = false;
                                whyNotUsable = 'used_up';
                            } else if (code.usage_type === 'limited' && code.current_uses >= (code.max_uses * totalDoorsAssigned)) {
                                isUsable = false;
                                whyNotUsable = 'used_up';
                            }
                            // Check time expiry
                            else if (code.status === 'expired' || code.is_expired) {
                                isUsable = false;
                                whyNotUsable = 'expired';
                            }
                            // Otherwise, it's just manually disabled
                            else {
                                isUsable = false;
                                whyNotUsable = 'disabled';
                            }
                        }
                        // If active = true, code is usable (even if it was previously used/expired)
                        // The "Enable" button resets everything
                        
                        // NOW determine the badge based on actual usability
                        if (isUsable && code.active) {
                            // Code is actually usable and active
                            statusBadge = '<span class="badge badge-success">‚úÖ Active</span>';
                            statusColor = '#10b981';
                        } else {
                            // Not usable - show why
                            if (whyNotUsable === 'used_up') {
                                statusBadge = '<span class="badge badge-warning">üé´ Used</span>';
                                statusColor = '#f59e0b';
                            } else if (whyNotUsable === 'expired') {
                                statusBadge = '<span class="badge badge-warning">‚è∞ Expired</span>';
                                statusColor = '#f59e0b';
                            } else if (whyNotUsable === 'disabled') {
                                statusBadge = '<span class="badge badge-secondary">‚è∏Ô∏è Disabled</span>';
                                statusColor = '#64748b';
                            } else {
                                // Fallback
                                statusBadge = '<span class="badge badge-secondary">‚è∏Ô∏è Inactive</span>';
                                statusColor = '#64748b';
                            }
                        }
        
                        // Build usage info string with per-door tracking
                        let usageInfo = '';
                       
                        
                        if (code.usage_type === 'one_time') {
                            usageInfo = `One-time per door (${code.current_uses}/${totalDoorsAssigned} doors used)`;
                        } else if (code.usage_type === 'limited') {
                            usageInfo = `Limited (${code.max_uses} uses per door, ${totalDoorsAssigned} doors)`;
                        } else {
                            usageInfo = 'Unlimited';
                        }
        
                        // Time info
                        let timeInfo = '';
                        if (code.time_type === 'hours') {
                            if (code.last_activated_at) {
                                timeInfo = `${code.valid_hours}h from first use`;
                            } else {
                                timeInfo = `${code.valid_hours}h (not yet activated)`;
                            }
                        } else if (code.time_type === 'date_range') {
                            timeInfo = `${code.valid_from || 'Now'} - ${code.valid_until || 'No end'}`;
                        } else {
                            timeInfo = 'No expiry';
                        }
        
                        return `
                            <div class="card" style="border-left: 4px solid ${statusColor};">
                                <div class="card-header">
                                    <div class="card-title">üé´ ${code.name}</div>
                                    ${statusBadge}
                                </div>
                                <div class="card-body">
                                    <div class="card-info">
                                        <span class="card-info-label">PIN Code:</span>
                                        <span class="card-info-value" style="font-family: monospace; font-size: 18px; letter-spacing: 2px;">
                                            ${code.code}
                                        </span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Usage:</span>
                                        <span class="card-info-value">${usageInfo}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Validity:</span>
                                        <span class="card-info-value">${timeInfo}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Access:</span>
                                        <span class="card-info-value">
                                            ${code.access_method === 'doors' 
                                                ? `${code.doors?.length || 0} door(s)` 
                                                : `${code.groups?.length || 0} group(s)`}
                                        </span>
                                    </div>
                                    ${code.notes ? `
                                        <div class="card-info">
                                            <span class="card-info-label">Notes:</span>
                                            <span class="card-info-value">${code.notes}</span>
                                        </div>
                                    ` : ''}
                                    <div class="card-info">
                                        <span class="card-info-label">Created:</span>
                                        <span class="card-info-value">${code.created_at}</span>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="btn ${code.active ? 'btn-warning' : 'btn-success'} btn-small" 
                                            onclick="toggleTempCode(${code.id}, ${!code.active})">
                                        ${code.active ? '‚è∏Ô∏è Disable' : '‚ñ∂Ô∏è Enable'}
                                    </button>
                                    <button class="btn btn-secondary btn-small" onclick="editTempCode(${code.id})">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteTempCode(${code.id})">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading temp codes:', error);
                showToast('Error loading temp codes', 'error');
            }
        }

        
        async function openTempCodeModal(codeId = null) {
            currentTempCodeId = codeId;
            
            // Load doors and groups
            await Promise.all([loadDoorsForTempCode(), loadGroupsForTempCode()]);
            
            if (codeId) {
                document.getElementById('tempCodeModalTitle').textContent = 'Edit Temp Code';
                
                const response = await fetch('/api/temp-codes');
                const data = await response.json();
                const code = data.temp_codes.find(c => c.id === codeId);
                
                if (code) {
                    document.getElementById('tempCodeId').value = code.id;
                    document.getElementById('tempCodeName').value = code.name;
                    document.getElementById('tempCodePin').value = code.code;
                    document.getElementById('tempCodeActive').checked = code.active;
                    document.getElementById('tempCodeUsageType').value = code.usage_type;
                    document.getElementById('tempCodeMaxUses').value = code.max_uses || 5;
                    document.getElementById('tempCodeTimeType').value = code.time_type;
                    document.getElementById('tempCodeValidHours').value = code.valid_hours || 24;
                    document.getElementById('tempCodeValidFrom').value = code.valid_from || '';
                    document.getElementById('tempCodeValidUntil').value = code.valid_until || '';
                    document.getElementById('tempCodeAccessMethod').value = code.access_method;
                    document.getElementById('tempCodeNotes').value = code.notes || '';
                    
                    // Select doors
                    if (code.doors) {
                        code.doors.forEach(door => {
                            const checkbox = document.getElementById(`tempcode-door-${door.id}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    
                    // Select groups
                    if (code.groups) {
                        code.groups.forEach(group => {
                            const checkbox = document.getElementById(`tempcode-group-${group.id}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
            } else {
                document.getElementById('tempCodeModalTitle').textContent = 'Create Temp Code';
                document.getElementById('tempCodeForm').reset();
                document.getElementById('tempCodeId').value = '';
                document.getElementById('tempCodeActive').checked = true;
            }
            
            updateUsageTypeUI();
            updateTimeTypeUI();
            updateAccessMethodUI();
            
            document.getElementById('tempCodeModal').classList.add('active');
        }
        
        function closeTempCodeModal() {
            document.getElementById('tempCodeModal').classList.remove('active');
        }
        
        async function loadDoorsForTempCode() {
            const response = await fetch('/api/doors');
            const data = await response.json();
        
            if (data.success) {
                const container = document.getElementById('tempCodeDoorsCheckboxes');
                
                if (data.doors.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; font-size: 13px;">No doors available.</p>';
                } else {
                    container.innerHTML = data.doors.map(door => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="tempcode-door-${door.id}" value="${door.id}">
                            <label for="tempcode-door-${door.id}">
                                ${door.board_name} - ${door.name}
                            </label>
                        </div>
                    `).join('');
                }
            }
        }
        
        async function loadGroupsForTempCode() {
            const response = await fetch('/api/groups');
            const data = await response.json();
        
            if (data.success) {
                const container = document.getElementById('tempCodeGroupsCheckboxes');
                
                if (data.groups.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; font-size: 13px;">No groups available.</p>';
                } else {
                    container.innerHTML = data.groups.map(group => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="tempcode-group-${group.id}" value="${group.id}">
                            <label for="tempcode-group-${group.id}">
                                <span style="display: inline-block; width: 12px; height: 12px; background: ${group.color}; border-radius: 3px; margin-right: 8px;"></span>
                                ${group.name}
                            </label>
                        </div>
                    `).join('');
                }
            }
        }
        
        function updateUsageTypeUI() {
            const usageType = document.getElementById('tempCodeUsageType').value;
            document.getElementById('maxUsesGroup').style.display = 
                usageType === 'limited' ? 'block' : 'none';
        }
        
        function updateTimeTypeUI() {
            const timeType = document.getElementById('tempCodeTimeType').value;
            document.getElementById('validHoursGroup').style.display = 
                timeType === 'hours' ? 'block' : 'none';
            document.getElementById('dateRangeGroup').style.display = 
                timeType === 'date_range' ? 'block' : 'none';
        }
        
        function updateAccessMethodUI() {
            const method = document.getElementById('tempCodeAccessMethod').value;
            document.getElementById('tempCodeDoorsGroup').style.display = 
                method === 'doors' ? 'block' : 'none';
            document.getElementById('tempCodeGroupsGroup').style.display = 
                method === 'groups' ? 'block' : 'none';
        }
        
        function generateRandomPin() {
            const pin = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('tempCodePin').value = pin;
        }
        
        async function saveTempCode(event) {
    event.preventDefault();
    
    const codeId = document.getElementById('tempCodeId').value;
    const accessMethod = document.getElementById('tempCodeAccessMethod').value;
    
    // Collect selected doors or groups
    let door_ids = [];
    let group_ids = [];
    
    if (accessMethod === 'doors') {
        door_ids = Array.from(document.querySelectorAll('#tempCodeDoorsCheckboxes input:checked'))
            .map(input => parseInt(input.value));
        
        if (door_ids.length === 0) {
            showToast('Please select at least one door', 'warning');
            return;
        }
    } else {
        group_ids = Array.from(document.querySelectorAll('#tempCodeGroupsCheckboxes input:checked'))
            .map(input => parseInt(input.value));
        
        if (group_ids.length === 0) {
            showToast('Please select at least one group', 'warning');
            return;
        }
    }
    
    const tempCodeData = {
        name: document.getElementById('tempCodeName').value,
        code: document.getElementById('tempCodePin').value,
        active: document.getElementById('tempCodeActive').checked,
        usage_type: document.getElementById('tempCodeUsageType').value,
        max_uses: parseInt(document.getElementById('tempCodeMaxUses').value) || null,
        time_type: document.getElementById('tempCodeTimeType').value,
        valid_hours: parseInt(document.getElementById('tempCodeValidHours').value) || null,
        valid_from: document.getElementById('tempCodeValidFrom').value || null,
        valid_until: document.getElementById('tempCodeValidUntil').value || null,
        access_method: accessMethod,
        door_ids: door_ids,
        group_ids: group_ids,
        notes: document.getElementById('tempCodeNotes').value
    };
    
    try {
        const url = codeId ? `/api/temp-codes/${codeId}` : '/api/temp-codes';
        const method = codeId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(tempCodeData)
        });
        
        const data = await response.json();
        
        // ‚úÖ THIS IS THE CORRECT LOCATION
        if (data.success) {
            closeTempCodeModal();
            loadTempCodes();  // ‚úÖ Reload temp codes to show updated status
            showToast(data.message, 'success');
            
            // Sync all boards
            await fetch('/api/boards/sync-all', { method: 'POST' });
            showToast('All boards synced with new temp code', 'success');
        } else {
            showToast(data.message, 'error');
        }
    } catch (error) {
        console.error('Error saving temp code:', error);
        showToast('Error saving temp code', 'error');
    }
}
        
        function editTempCode(codeId) {
            openTempCodeModal(codeId);
        }
        
        async function toggleTempCode(codeId, newActiveState) {
            try {
                const response = await fetch(`/api/temp-codes/${codeId}/toggle`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: newActiveState })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    
                    // ‚úÖ RELOAD to show updated status
                    loadTempCodes();
                    
                    // ‚úÖ Give user feedback that boards are syncing
                    showToast('Syncing to boards...', 'info');
                    
                    // ‚úÖ Wait a moment for sync, then reload again
                    setTimeout(() => {
                        loadTempCodes();
                    }, 2000);
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error toggling temp code:', error);
                showToast('Error toggling temp code', 'error');
            }
        }
        
        async function deleteTempCode(codeId) {
            if (!confirm('Are you sure you want to delete this temporary code?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/temp-codes/${codeId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(data.message, 'success');
                    loadTempCodes();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting temp code:', error);
                showToast('Error deleting temp code', 'error');
            }
        }

    // ==================== COPY DOOR SCHEDULE ====================
        async function copyScheduleToOtherDoors(scheduleIndex) {
            const schedule = doorSchedules[scheduleIndex];
            
            // Get all doors except current one
            try {
                const response = await fetch('/api/doors');
                const data = await response.json();
                
                if (!data.success) {
                    showToast('Error loading doors', 'error');
                    return;
                }
                
                const currentDoorId = parseInt(document.getElementById('doorScheduleDoorId').value);
                const otherDoors = data.doors.filter(d => d.id !== currentDoorId);
                
                if (otherDoors.length === 0) {
                    showToast('No other doors available', 'warning');
                    return;
                }
                
                // Build selection modal
                const modalHtml = `
                    <div id="copyScheduleModal" class="modal active">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3 class="modal-title">üìã Copy Schedule to Other Doors</h3>
                                <button class="modal-close" onclick="closeCopyScheduleModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p style="margin-bottom: 20px; color: #64748b;">
                                    Copy "${schedule.name}" schedule to the selected doors:
                                </p>
                                
                                <div class="form-group">
                                    <div class="checkbox-group" id="copyScheduleDoorsList">
                                        ${otherDoors.map(door => `
                                            <div class="checkbox-item">
                                                <input type="checkbox" id="copy-door-${door.id}" value="${door.id}">
                                                <label for="copy-door-${door.id}">
                                                    ${door.board_name} - ${door.name}
                                                </label>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-top: 15px;">
                                    <small style="color: #1e40af;">
                                        ‚ÑπÔ∏è This will create a copy of this schedule on each selected door.
                                    </small>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="closeCopyScheduleModal()">Cancel</button>
                                <button class="btn btn-primary" onclick="executeCopySchedule(${scheduleIndex})">
                                    üìã Copy Schedule
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Inject modal into page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
            } catch (error) {
                console.error('Error preparing copy:', error);
                showToast('Error preparing copy', 'error');
            }
        }
        
        function closeCopyScheduleModal() {
            const modal = document.getElementById('copyScheduleModal');
            if (modal) modal.remove();
        }
        
        async function executeCopySchedule(scheduleIndex) {
            const schedule = doorSchedules[scheduleIndex];
            
            // Get selected doors
            const selectedDoorIds = Array.from(
                document.querySelectorAll('#copyScheduleDoorsList input:checked')
            ).map(cb => parseInt(cb.value));
            
            if (selectedDoorIds.length === 0) {
                showToast('Please select at least one door', 'warning');
                return;
            }
            
            try {
                showToast(`Copying schedule to ${selectedDoorIds.length} door(s)...`, 'info');
                
                // Copy schedule to each door
                for (const targetDoorId of selectedDoorIds) {
                    const response = await fetch(`/api/door-schedules/${targetDoorId}/copy`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ schedule: schedule })
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        showToast(`Error copying to door ${targetDoorId}: ${data.message}`, 'error');
                    }
                }
                
                showToast(`‚úÖ Schedule copied to ${selectedDoorIds.length} door(s)!`, 'success');
                closeCopyScheduleModal();
                
                // Sync all boards
                await fetch('/api/boards/sync-all', { method: 'POST' });
                showToast('All boards synced with new schedules', 'success');
                
            } catch (error) {
                console.error('Error copying schedule:', error);
                showToast('Error copying schedule', 'error');
            }
        }
        // ==================== SCHEDULE TEMPLATES ====================
        let currentTemplateId = null;
        let templateSlots = [];
        const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        async function loadScheduleTemplates() {
            try {
                const response = await fetch('/api/schedule-templates');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('scheduleTemplatesList');
                    
                    if (data.templates.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                                <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
                                <h3 style="margin-bottom: 10px; color: #1e293b;">No Templates Yet</h3>
                                <p style="margin-bottom: 20px;">Create a template to easily manage schedules across multiple doors.</p>
                                <button class="btn btn-primary" onclick="openScheduleTemplateModal()">
                                    ‚ûï Create Your First Template
                                </button>
                            </div>
                        `;
                        return;
                    }

                    container.innerHTML = data.templates.map(template => {
                        // Build schedule preview
                        let schedulePreview = buildSchedulePreview(template.slots);
                        
                        return `
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">üìã ${template.name}</div>
                                    <span class="badge badge-info">${template.doors.length} door(s)</span>
                                </div>
                                <div class="card-body">
                                    ${template.description ? `<p style="color: #64748b; margin-bottom: 15px;">${template.description}</p>` : ''}
                                    
                                    <!-- Schedule Preview -->
                                    <div style="background: #f8fafc; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                                        <div style="font-size: 12px; color: #64748b; margin-bottom: 8px; font-weight: 600;">SCHEDULE:</div>
                                        ${schedulePreview}
                                    </div>
                                    
                                    <!-- Assigned Doors -->
                                    <div style="font-size: 12px; color: #64748b; margin-bottom: 5px; font-weight: 600;">ASSIGNED DOORS:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                        ${template.doors.length > 0 
                                            ? template.doors.map(door => `
                                                <span style="background: #e0e7ff; color: #3730a3; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                                    üö™ ${door.name}
                                                </span>
                                            `).join('')
                                            : '<span style="color: #94a3b8; font-size: 13px;">No doors assigned</span>'
                                        }
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-secondary btn-small" onclick="editScheduleTemplate(${template.id})">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteScheduleTemplate(${template.id})">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading schedule templates:', error);
                showToast('Error loading templates', 'error');
            }
        }

        function buildSchedulePreview(slots) {
            if (!slots || slots.length === 0) {
                return '<div style="color: #94a3b8; font-size: 13px;">No schedule configured</div>';
            }

            // Group by day
            const byDay = {};
            slots.forEach(slot => {
                if (!byDay[slot.day_of_week]) byDay[slot.day_of_week] = [];
                byDay[slot.day_of_week].push(slot);
            });

            const modeColors = {
                'unlock': '#10b981',
                'controlled': '#3b82f6',
                'locked': '#ef4444'
            };

            const modeIcons = {
                'unlock': 'üîì',
                'controlled': 'üîê',
                'locked': 'üîí'
            };

            let html = '<div style="display: grid; gap: 4px;">';
            
            for (let day = 0; day < 7; day++) {
                const daySlots = byDay[day] || [];
                const dayAbbrev = dayNames[day].substring(0, 3);
                
                html += `<div style="display: flex; align-items: center; gap: 8px;">`;
                html += `<span style="width: 35px; font-size: 11px; color: #64748b; font-weight: 600;">${dayAbbrev}</span>`;
                
                if (daySlots.length === 0) {
                    html += `<span style="color: #cbd5e1; font-size: 12px;">‚Äî</span>`;
                } else {
                    daySlots.forEach(slot => {
                        const startTime = slot.start_time.substring(0, 5);
                        const endTime = slot.end_time.substring(0, 5);
                        html += `
                            <span style="background: ${modeColors[slot.mode]}20; color: ${modeColors[slot.mode]}; 
                                         padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                ${modeIcons[slot.mode]} ${startTime}-${endTime}
                            </span>
                        `;
                    });
                }
                
                html += `</div>`;
            }
            
            html += '</div>';
            return html;
        }

        async function openScheduleTemplateModal(templateId = null) {
            currentTemplateId = templateId;
            templateSlots = [];

            // Load doors
            await loadDoorsForTemplate();

            if (templateId) {
                document.getElementById('scheduleTemplateModalTitle').textContent = 'Edit Template';
                
                try {
                    const response = await fetch(`/api/schedule-templates/${templateId}`);
                    const data = await response.json();
                    
                    if (data.success && data.template) {
                        const template = data.template;
                        document.getElementById('templateId').value = template.id;
                        document.getElementById('templateName').value = template.name;
                        document.getElementById('templateDescription').value = template.description || '';
                        
                        // Load slots
                        templateSlots = template.slots.map(s => ({
                            day_of_week: s.day_of_week,
                            start_time: s.start_time,
                            end_time: s.end_time,
                            mode: s.mode,
                            priority: s.priority || 0
                        }));
                        
                        // Check assigned doors
                        template.doors.forEach(door => {
                            const checkbox = document.getElementById(`template-door-${door.id}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                } catch (error) {
                    console.error('Error loading template:', error);
                    showToast('Error loading template', 'error');
                    return;
                }
            } else {
                document.getElementById('scheduleTemplateModalTitle').textContent = 'Create Template';
                document.getElementById('scheduleTemplateForm').reset();
                document.getElementById('templateId').value = '';
                templateSlots = [];
            }

            renderTemplateWeekGrid();
            document.getElementById('scheduleTemplateModal').classList.add('active');
        }

        function closeScheduleTemplateModal() {
            document.getElementById('scheduleTemplateModal').classList.remove('active');
            currentTemplateId = null;
            templateSlots = [];
        }

        async function loadDoorsForTemplate() {
            try {
                const response = await fetch('/api/doors');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('templateDoorsCheckboxes');
                    
                    if (data.doors.length === 0) {
                        container.innerHTML = '<p style="color: #64748b;">No doors available. Add boards first.</p>';
                    } else {
                        container.innerHTML = data.doors.map(door => `
                            <div class="checkbox-item">
                                <input type="checkbox" id="template-door-${door.id}" value="${door.id}">
                                <label for="template-door-${door.id}">
                                    üö™ ${door.board_name} - ${door.name}
                                </label>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading doors:', error);
            }
        }

        function renderTemplateWeekGrid() {
            const container = document.getElementById('templateWeekGrid');
            
            const modeColors = {
                'unlock': { bg: '#d1fae5', border: '#10b981', text: '#065f46' },
                'controlled': { bg: '#dbeafe', border: '#3b82f6', text: '#1e40af' },
                'locked': { bg: '#fee2e2', border: '#ef4444', text: '#991b1b' }
            };

            let html = '';
            
            for (let day = 0; day < 7; day++) {
                const daySlots = templateSlots.filter(s => s.day_of_week === day);
                
                html += `
                    <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; border: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span style="font-weight: 600; color: #1e293b;">${dayNames[day]}</span>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addSlotForDay(${day})" style="padding: 4px 10px; font-size: 11px;">
                                + Add
                            </button>
                        </div>
                `;
                
                if (daySlots.length === 0) {
                    html += `<div style="color: #94a3b8; font-size: 13px; font-style: italic;">No schedule (default: controlled)</div>`;
                } else {
                    daySlots.forEach((slot, slotIndex) => {
                        const actualIndex = templateSlots.findIndex(s => 
                            s.day_of_week === day && 
                            s.start_time === slot.start_time && 
                            s.end_time === slot.end_time
                        );
                        const colors = modeColors[slot.mode];
                        
                        html += `
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 10px; 
                                        background: ${colors.bg}; border-left: 4px solid ${colors.border}; border-radius: 6px;">
                                <select class="form-select" style="width: 130px; padding: 6px; font-size: 13px;"
                                        onchange="updateSlotMode(${actualIndex}, this.value)">
                                    <option value="unlock" ${slot.mode === 'unlock' ? 'selected' : ''}>üîì Unlock</option>
                                    <option value="controlled" ${slot.mode === 'controlled' ? 'selected' : ''}>üîê Controlled</option>
                                    <option value="locked" ${slot.mode === 'locked' ? 'selected' : ''}>üîí Locked</option>
                                </select>
                                <input type="time" class="form-input" style="width: 110px; padding: 6px; font-size: 13px;"
                                       value="${slot.start_time.substring(0, 5)}"
                                       onchange="updateSlotTime(${actualIndex}, 'start', this.value)">
                                <span style="color: #64748b;">to</span>
                                <input type="time" class="form-input" style="width: 110px; padding: 6px; font-size: 13px;"
                                       value="${slot.end_time.substring(0, 5)}"
                                       onchange="updateSlotTime(${actualIndex}, 'end', this.value)">
                                <button type="button" onclick="removeSlot(${actualIndex})" 
                                        style="background: #ef4444; color: white; border: none; border-radius: 50%; 
                                               width: 24px; height: 24px; cursor: pointer; font-size: 14px;">√ó</button>
                            </div>
                        `;
                    });
                }
                
                html += `</div>`;
            }
            
            container.innerHTML = html;
        }

        function addTemplateSlot() {
            // Add slot for Monday by default
            addSlotForDay(0);
        }

        function addSlotForDay(day) {
            templateSlots.push({
                day_of_week: day,
                start_time: '09:00:00',
                end_time: '17:00:00',
                mode: 'unlock',
                priority: 0
            });
            renderTemplateWeekGrid();
        }

        function updateSlotMode(index, mode) {
            if (templateSlots[index]) {
                templateSlots[index].mode = mode;
                renderTemplateWeekGrid();
            }
        }

        function updateSlotTime(index, type, value) {
            if (templateSlots[index]) {
                if (type === 'start') {
                    templateSlots[index].start_time = value + ':00';
                } else {
                    templateSlots[index].end_time = value + ':00';
                }
            }
        }

        function removeSlot(index) {
            templateSlots.splice(index, 1);
            renderTemplateWeekGrid();
        }

        function copyMondayToWeekdays() {
            const mondaySlots = templateSlots.filter(s => s.day_of_week === 0);
            
            if (mondaySlots.length === 0) {
                showToast('Add slots to Monday first', 'warning');
                return;
            }

            // Remove existing weekday slots (Tue-Fri)
            templateSlots = templateSlots.filter(s => s.day_of_week === 0 || s.day_of_week > 4);
            
            // Copy Monday to Tue-Fri
            for (let day = 1; day <= 4; day++) {
                mondaySlots.forEach(slot => {
                    templateSlots.push({
                        ...slot,
                        day_of_week: day
                    });
                });
            }

            renderTemplateWeekGrid();
            showToast('Monday schedule copied to Tue-Fri', 'success');
        }

        function clearAllSlots() {
            if (confirm('Clear all time slots?')) {
                templateSlots = [];
                renderTemplateWeekGrid();
            }
        }

        async function saveScheduleTemplate(event) {
            event.preventDefault();

            const templateId = document.getElementById('templateId').value;
            const name = document.getElementById('templateName').value.trim();
            
            if (!name) {
                showToast('Please enter a template name', 'warning');
                return;
            }

            // Get selected doors
            const door_ids = Array.from(document.querySelectorAll('#templateDoorsCheckboxes input:checked'))
                .map(input => parseInt(input.value));

            const templateData = {
                name: name,
                description: document.getElementById('templateDescription').value.trim(),
                slots: templateSlots,
                door_ids: door_ids
            };

            try {
                const url = templateId ? `/api/schedule-templates/${templateId}` : '/api/schedule-templates';
                const method = templateId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(templateData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message || 'Template saved!', 'success');
                    closeScheduleTemplateModal();
                    loadScheduleTemplates();
                } else {
                    showToast(data.message || 'Error saving template', 'error');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                showToast('Error saving template', 'error');
            }
        }

        function editScheduleTemplate(templateId) {
            openScheduleTemplateModal(templateId);
        }

        async function deleteScheduleTemplate(templateId) {
            if (!confirm('Delete this template? This will remove the schedule from all assigned doors.')) {
                return;
            }

            try {
                const response = await fetch(`/api/schedule-templates/${templateId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Template deleted', 'success');
                    loadScheduleTemplates();
                } else {
                    showToast(data.message || 'Error deleting template', 'error');
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                showToast('Error deleting template', 'error');
            }
        }

        // ==================== PRESET TEMPLATES ====================
        async function showPresetTemplates() {
            try {
                const response = await fetch('/api/schedule-templates/presets');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('presetTemplatesList');
                    
                    container.innerHTML = data.presets.map((preset, index) => `
                        <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 15px; 
                                    border: 2px solid #e2e8f0; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.borderColor='#667eea'; this.style.background='#f0f4ff';"
                             onmouseout="this.style.borderColor='#e2e8f0'; this.style.background='#f8fafc';"
                             onclick="applyPresetTemplate(${index})">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #1e293b;">üìã ${preset.name}</h4>
                                    <p style="margin: 0; color: #64748b; font-size: 14px;">${preset.description}</p>
                                </div>
                                <button class="btn btn-primary btn-small">Use This</button>
                            </div>
                        </div>
                    `).join('');
                    
                    // Store presets for later use
                    window.presetTemplatesData = data.presets;
                }

                document.getElementById('presetTemplatesModal').classList.add('active');
            } catch (error) {
                console.error('Error loading presets:', error);
                showToast('Error loading presets', 'error');
            }
        }

        function closePresetTemplatesModal() {
            document.getElementById('presetTemplatesModal').classList.remove('active');
        }

        function applyPresetTemplate(presetIndex) {
            const preset = window.presetTemplatesData[presetIndex];
            
            if (!preset) {
                showToast('Preset not found', 'error');
                return;
            }

            closePresetTemplatesModal();
            
            // Open template modal with preset data
            currentTemplateId = null;
            templateSlots = preset.slots.map(s => ({...s}));
            
            document.getElementById('scheduleTemplateModalTitle').textContent = 'Create Template from Preset';
            document.getElementById('scheduleTemplateForm').reset();
            document.getElementById('templateId').value = '';
            document.getElementById('templateName').value = preset.name;
            document.getElementById('templateDescription').value = preset.description;
            
            loadDoorsForTemplate().then(() => {
                renderTemplateWeekGrid();
                document.getElementById('scheduleTemplateModal').classList.add('active');
            });
        }
    </script>
</body>
</html>
