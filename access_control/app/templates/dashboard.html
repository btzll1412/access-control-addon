<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîê</text></svg>">
    <title>Access Control System - Dashboard</title>
    <style>
        /* ========================================
           GLOBAL STYLES
           ======================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        /* ========================================
           HEADER
           ======================================== */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        /* ========================================
           EMERGENCY ALERT BANNER
           ======================================== */
        .emergency-alert {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 20px 40px;
            display: none;
            align-items: center;
            justify-content: space-between;
            animation: emergencyPulse 2s infinite;
        }

        .emergency-alert.active {
            display: flex;
        }

        @keyframes emergencyPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .emergency-alert-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .emergency-alert-icon {
            font-size: 32px;
            animation: emergencyRotate 2s infinite;
        }

        @keyframes emergencyRotate {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }

        .emergency-alert-text h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .emergency-alert-text p {
            font-size: 14px;
            opacity: 0.9;
        }

        /* ========================================
           STATS BAR
           ======================================== */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            padding: 30px 40px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-card.success {
            border-left-color: #10b981;
        }

        .stat-card.warning {
            border-left-color: #f59e0b;
        }

        .stat-card.danger {
            border-left-color: #ef4444;
        }

        .stat-card.info {
            border-left-color: #3b82f6;
        }

        /* ========================================
           TABS
           ======================================== */
        .tabs {
            display: flex;
            background: #f1f5f9;
            padding: 0 40px;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 500;
            color: #64748b;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        /* ========================================
           TAB CONTENT
           ======================================== */
        .tab-content {
            display: none;
            padding: 40px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* ========================================
           NOTIFICATION BANNER
           ======================================== */
        .notification-banner {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
            align-items: center;
            justify-content: space-between;
        }

        .notification-banner.show {
            display: flex;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-icon {
            font-size: 24px;
        }

        .notification-text h4 {
            font-size: 16px;
            color: #92400e;
            margin-bottom: 5px;
        }

        .notification-text p {
            font-size: 14px;
            color: #78350f;
        }

        /* ========================================
           EMERGENCY CONTROLS PANEL
           ======================================== */
        .emergency-panel {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 3px solid #ef4444;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .emergency-panel-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #fca5a5;
        }

        .emergency-panel-header h2 {
            font-size: 22px;
            color: #991b1b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .emergency-board-controls {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .emergency-board-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .emergency-board-name {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .emergency-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .emergency-status.normal {
            background: #d1fae5;
            color: #065f46;
        }

        .emergency-status.locked {
            background: #fecaca;
            color: #991b1b;
        }

        .emergency-status.unlocked {
            background: #dbeafe;
            color: #1e40af;
        }

        .emergency-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .emergency-door-overrides {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f1f5f9;
        }

        .emergency-door-overrides h4 {
            font-size: 16px;
            color: #64748b;
            margin-bottom: 15px;
        }

        .emergency-door-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .emergency-door-name {
            font-weight: 600;
            color: #1e293b;
        }

        .emergency-door-actions {
            display: flex;
            gap: 8px;
        }

        /* ========================================
           BUTTONS
           ======================================== */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-emergency {
            background: #dc2626;
            color: white;
            font-weight: 700;
            animation: emergencyButtonPulse 2s infinite;
        }

        .btn-emergency:hover {
            background: #991b1b;
        }

        @keyframes emergencyButtonPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        }

        /* ========================================
           CARDS
           ======================================== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        .card.emergency-active {
            border: 3px solid #ef4444;
            background: #fef2f2;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .card-body {
            margin-bottom: 15px;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        .card-info-label {
            color: #64748b;
            font-weight: 500;
        }

        .card-info-value {
            color: #1e293b;
            font-weight: 600;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 15px;
            border-top: 1px solid #f1f5f9;
            flex-wrap: wrap;
        }

        /* ========================================
           BADGES
           ======================================== */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-emergency {
            background: #dc2626;
            color: white;
            animation: emergencyBadgePulse 1s infinite;
        }

        @keyframes emergencyBadgePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* ========================================
           MODALS
           ======================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #64748b;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 2px solid #f1f5f9;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* ========================================
           FORMS
           ======================================== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-help {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            font-size: 14px;
            color: #1e293b;
        }

        /* ========================================
           TABLES
           ======================================== */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }

        thead {
            background: #f8fafc;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #1e293b;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* ========================================
           TOAST NOTIFICATIONS
           ======================================== */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: none;
            align-items: center;
            gap: 15px;
            min-width: 300px;
            z-index: 2000;
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(400px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast-icon {
            font-size: 24px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }

        /* ========================================
           LOADING SPINNER
           ======================================== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ========================================
           RESPONSIVE
           ======================================== */
        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: 1fr;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .tabs {
                overflow-x: scroll;
            }

            .emergency-board-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .emergency-actions {
                width: 100%;
            }

            .emergency-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîê Access Control System</h1>
            <div class="header-actions">
                <button class="btn btn-secondary btn-small" onclick="location.reload()">üîÑ Refresh</button>
            </div>
        </div>

        <!-- Emergency Alert Banner -->
        <div class="emergency-alert" id="emergencyAlert">
            <div class="emergency-alert-content">
                <div class="emergency-alert-icon">üö®</div>
                <div class="emergency-alert-text">
                    <h3>EMERGENCY MODE ACTIVE</h3>
                    <p id="emergencyAlertText">Emergency lockdown in effect</p>
                </div>
            </div>
            <button class="btn btn-secondary btn-small" onclick="showTab('emergency')">
                View Emergency Controls
            </button>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card success">
                <h3>Online Boards</h3>
                <div class="stat-value" id="statOnlineBoards">0</div>
            </div>
            <div class="stat-card info">
                <h3>Active Users</h3>
                <div class="stat-value" id="statActiveUsers">0</div>
            </div>
            <div class="stat-card warning">
                <h3>Total Doors</h3>
                <div class="stat-value" id="statTotalDoors">0</div>
            </div>
            <div class="stat-card info">
                <h3>Today's Events</h3>
                <div class="stat-value" id="statTodayEvents">0</div>
            </div>
            <div class="stat-card danger" id="statEmergencyCard" style="display: none;">
                <h3>üö® Emergency Active</h3>
                <div class="stat-value" id="statEmergencyActive">0</div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('boards')">üì° Boards</button>
            <button class="tab" onclick="showTab('doors')">üö™ Doors</button>
            <button class="tab" onclick="showTab('users')">üë• Users</button>
            <button class="tab" onclick="showTab('groups')">üè¢ Groups</button>
            <button class="tab" onclick="showTab('schedules')">üìÖ Schedules</button>
            <button class="tab" onclick="showTab('emergency')">üö® Emergency</button>
            <button class="tab" onclick="showTab('logs')">üìã Logs</button>
        </div>

        <!-- Tab: Boards -->
        <div id="tab-boards" class="tab-content active">
            <!-- Pending Boards Notification -->
            <div class="notification-banner" id="pendingBoardsNotification">
                <div class="notification-content">
                    <div class="notification-icon">üîî</div>
                    <div class="notification-text">
                        <h4>New Boards Waiting for Adoption</h4>
                        <p id="pendingBoardsText">0 boards are ready to be adopted</p>
                    </div>
                </div>
                <button class="btn btn-primary btn-small" onclick="showPendingBoards()">
                    ‚úÖ Adopt Boards
                </button>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Boards</h2>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="syncAllBoards()">üîÑ Sync All</button>
                    <button class="btn btn-primary" onclick="openBoardModal()">‚ûï Add Board</button>
                </div>
            </div>

            <div class="cards-grid" id="boardsList"></div>
        </div>

        <!-- Tab: Doors -->
        <div id="tab-doors" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Doors</h2>
            </div>

            <div class="cards-grid" id="doorsList"></div>
        </div>

        <!-- Tab: Users -->
        <div id="tab-users" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Users</h2>
                <button class="btn btn-primary" onclick="openUserModal()">‚ûï Add User</button>
            </div>

            <div class="table-container">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Cards</th>
                            <th>PINs</th>
                            <th>Groups</th>
                            <th>Schedules</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersList"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab: Groups -->
        <div id="tab-groups" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Access Groups</h2>
                <button class="btn btn-primary" onclick="openGroupModal()">‚ûï Add Group</button>
            </div>

            <div class="cards-grid" id="groupsList"></div>
        </div>

        <!-- Tab: Schedules -->
        <div id="tab-schedules" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Access Schedules (User Time Restrictions)</h2>
                <button class="btn btn-primary" onclick="openScheduleModal()">‚ûï Add Schedule</button>
            </div>

            <!-- Help Section -->
            <div style="background: #dbeafe; border-left: 4px solid #3b82f6; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #1e40af;">üìò Understanding Schedules</h4>
                <p style="margin: 0 0 10px 0; color: #1e3a8a;">
                    <strong>User Schedules (this page):</strong> Restrict WHEN specific users can access doors.<br>
                    <em>Example: "Cleaning crew can only access Monday-Friday 6pm-10pm"</em>
                </p>
                <p style="margin: 0; color: #1e3a8a;">
                    <strong>Door Schedules (Doors tab ‚Üí Schedule button):</strong> Control WHAT MODE the door is in at different times.<br>
                    <em>Example: "Main entrance is unlocked 8am-6pm, controlled 6pm-10pm, locked 10pm-8am"</em>
                </p>
            </div>

            <div class="form-help" style="margin-bottom: 20px;">
                Access schedules define when users are allowed to access doors. 
                Users without an assigned schedule have 24/7 access (subject to group permissions).
            </div>
            <div class="cards-grid" id="schedulesList"></div>
        </div>

        <!-- Tab: Emergency Controls -->
        <div id="tab-emergency" class="tab-content">
            <div style="margin-bottom: 20px;">
                <h2>üö® Emergency Controls</h2>
                <p style="color: #64748b; margin-top: 10px;">
                    Emergency controls override all schedules and permissions. Use with caution.
                </p>
            </div>

            <div id="emergencyControlsList"></div>
        </div>

        <!-- Tab: Access Logs -->
        <div id="tab-logs" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Access Logs</h2>
                <div style="display: flex; gap: 10px;">
                    <select class="form-select" id="logFilter" onchange="loadLogs()" style="width: auto;">
                        <option value="100">Last 100</option>
                        <option value="500">Last 500</option>
                        <option value="1000">Last 1000</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="loadLogs()">üîÑ Refresh</button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Board</th>
                            <th>Door</th>
                            <th>User</th>
                            <th>Credential</th>
                            <th>Result</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody id="logsList"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Board Modal -->
    <div id="boardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="boardModalTitle">Add Board</h3>
                <button class="modal-close" onclick="closeBoardModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="boardForm" onsubmit="saveBoard(event)">
                    <input type="hidden" id="boardId">
                    
                    <div class="form-group">
                        <label class="form-label">Board Name *</label>
                        <input type="text" class="form-input" id="boardName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">IP Address *</label>
                        <input type="text" class="form-input" id="boardIP" required 
                               placeholder="192.168.1.100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Door 1 Name *</label>
                        <input type="text" class="form-input" id="boardDoor1" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Door 2 Name *</label>
                        <input type="text" class="form-input" id="boardDoor2" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBoardModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('boardForm').requestSubmit()">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Add User</h3>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="saveUser(event)">
                    <input type="hidden" id="userId">
                    
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="userName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="userActive" checked> Active
                        </label>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label class="form-label">Valid From</label>
                            <input type="date" class="form-input" id="userValidFrom">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Valid Until</label>
                            <input type="date" class="form-input" id="userValidUntil">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Card Numbers</label>
                        <div id="userCards"></div>
                        <button type="button" class="btn btn-secondary btn-small" 
                                onclick="addCardInput()" style="margin-top: 10px;">
                            ‚ûï Add Card
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">PIN Codes</label>
                        <div id="userPins"></div>
                        <button type="button" class="btn btn-secondary btn-small" 
                                onclick="addPinInput()" style="margin-top: 10px;">
                            ‚ûï Add PIN
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Access Groups *</label>
                        <div class="form-help">Select which groups this user belongs to (determines door access)</div>
                        <div id="userGroupsCheckboxes" class="checkbox-group"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Time Schedules (Optional)</label>
                        <div class="form-help">Select schedules to restrict when this user can access doors. Leave empty for 24/7 access.</div>
                        <div id="userSchedulesCheckboxes" class="checkbox-group"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="userNotes"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('userForm').requestSubmit()">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="groupModalTitle">Add Group</h3>
                <button class="modal-close" onclick="closeGroupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="groupForm" onsubmit="saveGroup(event)">
                    <input type="hidden" id="groupId">
                    
                    <div class="form-group">
                        <label class="form-label">Group Name *</label>
                        <input type="text" class="form-input" id="groupName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="groupDescription"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Color</label>
                        <input type="color" class="form-input" id="groupColor" value="#6366f1">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Doors Access *</label>
                        <div class="form-help">Select which doors this group can access</div>
                        <div id="groupDoorsCheckboxes" class="checkbox-group"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGroupModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('groupForm').requestSubmit()">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="scheduleModalTitle">Add Schedule</h3>
                <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm" onsubmit="saveSchedule(event)">
                    <input type="hidden" id="scheduleId">
                    
                    <div class="form-group">
                        <label class="form-label">Schedule Name *</label>
                        <input type="text" class="form-input" id="scheduleName" required 
                               placeholder="e.g., Business Hours, Night Shift">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="scheduleDescription"
                                  placeholder="e.g., Monday-Friday 9 AM to 5 PM"></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="scheduleActive" checked> Active
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Time Ranges *</label>
                        <div class="form-help">Add time ranges when access is allowed</div>
                        <div id="scheduleTimeRanges"></div>
                        <button type="button" class="btn btn-secondary btn-small" 
                                onclick="addScheduleTimeRange()" style="margin-top: 10px;">
                            ‚ûï Add Time Range
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                <button class="btn btn-primary" type="button" onclick="saveSchedule(event)">
                    üíæ Save
                </button>
            </div>
        </div>
    </div>

    <!-- Door Schedule Modal -->
    <div id="doorScheduleModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="doorScheduleModalTitle">Door Schedule</h3>
                <button class="modal-close" onclick="closeDoorScheduleModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="doorScheduleDoorId">
                
                <div class="form-help" style="margin-bottom: 20px;">
                    Configure when this door is unlocked, requires credentials, or is locked completely.
                </div>

                <div id="doorSchedulesList"></div>

                <button type="button" class="btn btn-primary" onclick="addDoorSchedule()" 
                        style="margin-top: 20px;">
                    ‚ûï Add Schedule
                </button>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDoorScheduleModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveDoorSchedules()">üíæ Save All</button>
            </div>
        </div>
    </div>

    <!-- Door Settings Modal -->
<div id="doorSettingsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="doorSettingsModalTitle">Door Settings</h3>
            <button class="modal-close" onclick="closeDoorSettingsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="doorSettingsForm" onsubmit="saveDoorSettings(event)">
                <input type="hidden" id="settingsDoorId">
                
                <div class="form-group">
                    <label class="form-label">Door Name</label>
                    <input type="text" class="form-input" id="settingsDoorName" readonly disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Unlock Duration (milliseconds)</label>
                    <input type="number" class="form-input" id="settingsUnlockDuration" 
                           min="500" max="30000" step="100" value="3000" required>
                    <div class="form-help">
                        How long the relay stays active (1000ms = 1 second)<br>
                        Recommended: 3000-5000ms for standard doors
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDoorSettingsModal()">Cancel</button>
            <button class="btn btn-primary" onclick="document.getElementById('doorSettingsForm').requestSubmit()">
                üíæ Save Settings
            </button>
        </div>
    </div>
</div>

    <!-- Pending Boards Modal -->
    <div id="pendingBoardsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Pending Boards</h3>
                <button class="modal-close" onclick="closePendingBoardsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Board Name</th>
                                <th>IP Address</th>
                                <th>MAC Address</th>
                                <th>First Seen</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingBoardsList"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePendingBoardsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Emergency Confirm Modal -->
    <div id="emergencyConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: #fef2f2; border-bottom-color: #fecaca;">
                <h3 class="modal-title" style="color: #991b1b;">‚ö†Ô∏è Confirm Emergency Action</h3>
                <button class="modal-close" onclick="closeEmergencyConfirmModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="emergencyConfirmText" style="font-size: 16px; color: #1e293b; margin-bottom: 20px;"></p>
                
                <div class="form-group">
                    <label class="form-label">Your Name (for audit log)</label>
                    <input type="text" class="form-input" id="emergencyActivatedBy" 
                           placeholder="Enter your name" required>
                </div>

                <div id="emergencyAutoResetContainer" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Auto-Reset Time (minutes)</label>
                        <input type="number" class="form-input" id="emergencyAutoReset" 
                               value="30" min="5" max="480">
                        <div class="form-help">Door will automatically return to normal mode after this time</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEmergencyConfirmModal()">Cancel</button>
                <button class="btn btn-emergency" id="emergencyConfirmButton" onclick="confirmEmergencyAction()">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="toast-icon" id="toastIcon"></div>
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        let currentBoardId = null;
        let currentUserId = null;
        let currentGroupId = null;
        let currentScheduleId = null;
        let currentDoorId = null;
        let doorSchedules = [];
        let emergencyAction = null;
        let allGroups = [];
        let allSchedules = [];
        let allDoors = [];

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadBoards();
            loadPendingBoards();
            loadEmergencyStatus();
            
            // Refresh data every 30 seconds
            setInterval(() => {
                loadStats();
                loadBoards();
                loadPendingBoards();
                loadEmergencyStatus();
                
                // Reload current tab content
                const activeTab = document.querySelector('.tab.active');
                if (activeTab) {
                    const tabName = activeTab.textContent.trim().split(' ')[1].toLowerCase();
                    if (tabName === 'doors') loadDoors();
                    if (tabName === 'users') loadUsers();
                    if (tabName === 'groups') loadGroups();
                    if (tabName === 'schedules') loadSchedules();
                    if (tabName === 'logs') loadLogs();
                }
            }, 30000);
        });

        // ==================== TAB MANAGEMENT ====================
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');

            // Load data for tab
            if (tabName === 'boards') loadBoards();
            if (tabName === 'doors') loadDoors();
            if (tabName === 'users') loadUsers();
            if (tabName === 'groups') loadGroups();
            if (tabName === 'schedules') loadSchedules();
            if (tabName === 'emergency') loadEmergencyControls();
            if (tabName === 'logs') loadLogs();
        }

        // ==================== STATS ====================
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('statOnlineBoards').textContent = 
                        data.stats.online_boards + '/' + data.stats.total_boards;
                    document.getElementById('statActiveUsers').textContent = data.stats.active_users;
                    document.getElementById('statTotalDoors').textContent = data.stats.total_doors;
                    document.getElementById('statTodayEvents').textContent = data.stats.today_events;
                    
                    if (data.stats.emergency_active > 0) {
                        document.getElementById('statEmergencyCard').style.display = 'block';
                        document.getElementById('statEmergencyActive').textContent = data.stats.emergency_active;
                    } else {
                        document.getElementById('statEmergencyCard').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ==================== EMERGENCY STATUS ====================
        async function loadEmergencyStatus() {
            try {
                const response = await fetch('/api/emergency-status');
                const data = await response.json();

                if (data.success) {
                    const hasEmergency = data.emergency_boards.length > 0 || data.emergency_doors.length > 0;
                    
                    if (hasEmergency) {
                        document.getElementById('emergencyAlert').classList.add('active');
                        
                        let alertText = '';
                        if (data.emergency_boards.length > 0) {
                            const board = data.emergency_boards[0];
                            const mode = board.emergency_mode === 'lock' ? 'LOCKDOWN' : 'EVACUATION';
                            alertText = `${board.name}: ${mode} - Activated by ${board.emergency_activated_by}`;
                        } else if (data.emergency_doors.length > 0) {
                            alertText = `${data.emergency_doors.length} door(s) in override mode`;
                        }
                        
                        document.getElementById('emergencyAlertText').textContent = alertText;
                    } else {
                        document.getElementById('emergencyAlert').classList.remove('active');
                    }
                }
            } catch (error) {
                console.error('Error loading emergency status:', error);
            }
        }

        // ==================== BOARDS ====================
        async function loadBoards() {
            try {
                const response = await fetch('/api/boards');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('boardsList');
                    
                    if (data.boards.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No boards configured yet</p>';
                        return;
                    }

                    container.innerHTML = data.boards.map(board => {
                        const isEmergency = board.emergency_mode !== null;
                        const emergencyClass = isEmergency ? 'emergency-active' : '';
                        
                        return `
                            <div class="card ${emergencyClass}">
                                <div class="card-header">
                                    <div class="card-title">${board.name}</div>
                                    <span class="badge ${board.online ? 'badge-success' : 'badge-danger'}">
                                        ${board.online ? 'üü¢ Online' : 'üî¥ Offline'}
                                    </span>
                                </div>
                                ${isEmergency ? `
                                    <div style="background: #fef2f2; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                                        <span class="badge badge-emergency">
                                            üö® ${board.emergency_mode === 'lock' ? 'LOCKED' : 'UNLOCKED'}
                                        </span>
                                        <div style="font-size: 12px; color: #991b1b; margin-top: 5px;">
                                            By: ${board.emergency_activated_by || 'Unknown'}
                                        </div>
                                    </div>
                                ` : ''}
                                <div class="card-body">
                                    <div class="card-info">
                                        <span class="card-info-label">IP Address:</span>
                                        <span class="card-info-value">${board.ip_address}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Door 1:</span>
                                        <span class="card-info-value">${board.door1_name}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Door 2:</span>
                                        <span class="card-info-value">${board.door2_name}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Last Seen:</span>
                                        <span class="card-info-value">${board.last_seen_text}</span>
                                    </div>
                                    ${board.last_sync ? `
                                        <div class="card-info">
                                            <span class="card-info-label">Last Sync:</span>
                                            <span class="card-info-value">${board.last_sync}</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-success btn-small" 
                                            onclick="syncBoard(${board.id})"
                                            ${!board.online ? 'disabled' : ''}>
                                        üîÑ Sync
                                    </button>
                                    <button class="btn btn-secondary btn-small" 
                                            onclick="editBoard(${board.id})">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="btn btn-danger btn-small" 
                                            onclick="deleteBoard(${board.id})">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading boards:', error);
                showToast('Error loading boards', 'error');
            }
        }

        async function syncBoard(boardId) {
            try {
                showToast('Syncing board...', 'info');
                const response = await fetch(`/api/boards/${boardId}/sync`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadBoards();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error syncing board:', error);
                showToast('Error syncing board', 'error');
            }
        }

        async function syncAllBoards() {
            try {
                showToast('Syncing all boards...', 'info');
                const response = await fetch('/api/boards/sync-all', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadBoards();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error syncing boards:', error);
                showToast('Error syncing boards', 'error');
            }
        }

        function openBoardModal(boardId = null) {
            currentBoardId = boardId;
            
            if (boardId) {
                document.getElementById('boardModalTitle').textContent = 'Edit Board';
                // Load board data
                fetch(`/api/boards`)
                    .then(r => r.json())
                    .then(data => {
                        const board = data.boards.find(b => b.id === boardId);
                        if (board) {
                            document.getElementById('boardId').value = board.id;
                            document.getElementById('boardName').value = board.name;
                            document.getElementById('boardIP').value = board.ip_address;
                            document.getElementById('boardDoor1').value = board.door1_name;
                            document.getElementById('boardDoor2').value = board.door2_name;
                        }
                    });
            } else {
                document.getElementById('boardModalTitle').textContent = 'Add Board';
                document.getElementById('boardForm').reset();
                document.getElementById('boardId').value = '';
            }

            document.getElementById('boardModal').classList.add('active');
        }

        function closeBoardModal() {
            document.getElementById('boardModal').classList.remove('active');
        }

        async function saveBoard(event) {
            event.preventDefault();

            const boardId = document.getElementById('boardId').value;
            const boardData = {
                name: document.getElementById('boardName').value,
                ip_address: document.getElementById('boardIP').value,
                door1_name: document.getElementById('boardDoor1').value,
                door2_name: document.getElementById('boardDoor2').value
            };

            try {
                const url = boardId ? `/api/boards/${boardId}` : '/api/boards';
                const method = boardId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(boardData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    closeBoardModal();
                    loadBoards();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving board:', error);
                showToast('Error saving board', 'error');
            }
        }

        function editBoard(boardId) {
            openBoardModal(boardId);
        }

        async function deleteBoard(boardId) {
            if (!confirm('Are you sure you want to delete this board? This will also delete all associated doors.')) {
                return;
            }

            try {
                const response = await fetch(`/api/boards/${boardId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadBoards();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting board:', error);
                showToast('Error deleting board', 'error');
            }
        }

        // ==================== PENDING BOARDS ====================
        async function loadPendingBoards() {
            try {
                const response = await fetch('/api/pending-boards');
                const data = await response.json();

                if (data.success && data.pending_boards.length > 0) {
                    document.getElementById('pendingBoardsNotification').classList.add('show');
                    document.getElementById('pendingBoardsText').textContent = 
                        `${data.pending_boards.length} board(s) ready to be adopted`;
                } else {
                    document.getElementById('pendingBoardsNotification').classList.remove('show');
                }
            } catch (error) {
                console.error('Error loading pending boards:', error);
            }
        }

        async function showPendingBoards() {
            try {
                const response = await fetch('/api/pending-boards');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('pendingBoardsList');
                    
                    if (data.pending_boards.length === 0) {
                        container.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b;">No pending boards</td></tr>';
                    } else {
                        container.innerHTML = data.pending_boards.map(board => `
                            <tr>
                                <td>${board.board_name}</td>
                                <td>${board.ip_address}</td>
                                <td>${board.mac_address}</td>
                                <td>${board.first_seen}</td>
                                <td>
                                    <button class="btn btn-success btn-small" 
                                            onclick="adoptBoard(${board.id})">
                                        ‚úÖ Adopt
                                    </button>
                                    <button class="btn btn-danger btn-small" 
                                            onclick="rejectBoard(${board.id})">
                                        ‚ùå Reject
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }

                    document.getElementById('pendingBoardsModal').classList.add('active');
                }
            } catch (error) {
                console.error('Error showing pending boards:', error);
                showToast('Error loading pending boards', 'error');
            }
        }

        function closePendingBoardsModal() {
            document.getElementById('pendingBoardsModal').classList.remove('active');
        }

        async function adoptBoard(pendingId) {
            try {
                showToast('Adopting board...', 'info');
                const response = await fetch(`/api/pending-boards/${pendingId}/adopt`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadPendingBoards();
                    loadBoards();
                    closePendingBoardsModal();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error adopting board:', error);
                showToast('Error adopting board', 'error');
            }
        }

        async function rejectBoard(pendingId) {
            if (!confirm('Are you sure you want to reject this board?')) {
                return;
            }

            try {
                const response = await fetch(`/api/pending-boards/${pendingId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadPendingBoards();
                    showPendingBoards(); // Refresh modal
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error rejecting board:', error);
                showToast('Error rejecting board', 'error');
            }
        }

        // ==================== DOORS ====================
        async function loadDoors() {
            try {
                const response = await fetch('/api/doors');
                const data = await response.json();

                if (data.success) {
                    allDoors = data.doors;
                    const container = document.getElementById('doorsList');
                    
                    if (data.doors.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No doors configured yet</p>';
                        return;
                    }

                    container.innerHTML = data.doors.map(door => {
                        const isEmergency = door.emergency_override !== null;
                        const emergencyClass = isEmergency ? 'emergency-active' : '';
                        
                        return `
                            <div class="card ${emergencyClass}">
                                <div class="card-header">
                                    <div class="card-title">${door.name}</div>
                                    <span class="badge ${door.board_online ? 'badge-success' : 'badge-danger'}">
                                        ${door.board_online ? 'üü¢ Online' : 'üî¥ Offline'}
                                    </span>
                                </div>
                                ${isEmergency ? `
                                    <div style="background: #fef2f2; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                                        <span class="badge badge-emergency">
                                            üö® Override: ${door.emergency_override.toUpperCase()}
                                        </span>
                                    </div>
                                ` : ''}
                                <div class="card-body">
                                    <div class="card-info">
                                        <span class="card-info-label">Board:</span>
                                        <span class="card-info-value">${door.board_name}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">IP Address:</span>
                                        <span class="card-info-value">${door.ip_address}</span>
                                    </div>
                                    <div class="card-info">
                                        <span class="card-info-label">Door Number:</span>
                                        <span class="card-info-value">${door.door_number}</span>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-success btn-small" 
                                            onclick="unlockDoor(${door.id})"
                                            ${!door.board_online ? 'disabled' : ''}>
                                        üîì Unlock
                                    </button>
                                    <button class="btn btn-secondary btn-small" 
                                            onclick="openDoorScheduleModal(${door.id}, '${door.name}')">
                                        üìÖ Schedule
                                    </button>
                                    <button class="btn btn-secondary btn-small" 
                                            onclick="openDoorSettingsModal(${door.id}, '${door.name}', ${door.unlock_duration || 3000})">
                                        ‚öôÔ∏è Settings
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading doors:', error);
                showToast('Error loading doors', 'error');
            }
        }

        async function unlockDoor(doorId) {
            try {
                const response = await fetch(`/api/doors/${doorId}/unlock`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error unlocking door:', error);
                showToast('Error unlocking door', 'error');
            }
        }

        // ==================== Continue in next message... ====================
        // ==================== EMERGENCY CONTROLS ====================
        async function loadEmergencyControls() {
            try {
                const [boardsResponse, doorsResponse] = await Promise.all([
                    fetch('/api/boards'),
                    fetch('/api/doors')
                ]);

                const boardsData = await boardsResponse.json();
                const doorsData = await doorsResponse.json();

                if (boardsData.success && doorsData.success) {
                    const container = document.getElementById('emergencyControlsList');
                    
                    if (boardsData.boards.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b;">No boards configured</p>';
                        return;
                    }

                    container.innerHTML = boardsData.boards.map(board => {
                        const boardDoors = doorsData.doors.filter(d => d.board_id === board.id);
                        const isEmergency = board.emergency_mode !== null;
                        
                        return `
                            <div class="emergency-panel">
                                <div class="emergency-panel-header">
                                    <h2>üö® ${board.name}</h2>
                                </div>

                                <div class="emergency-board-controls">
                                    <div class="emergency-board-info">
                                        <div class="emergency-board-name">${board.name}</div>
                                        <div class="emergency-status ${isEmergency ? (board.emergency_mode === 'lock' ? 'locked' : 'unlocked') : 'normal'}">
                                            ${isEmergency 
                                                ? (board.emergency_mode === 'lock' ? 'üîí EMERGENCY LOCKED' : 'üîì EMERGENCY UNLOCKED')
                                                : 'üü¢ Normal Operation'
                                            }
                                        </div>
                                    </div>

                                    ${isEmergency ? `
                                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                            <strong>Active Since:</strong> ${new Date(board.emergency_activated_at).toLocaleString()}<br>
                                            <strong>Activated By:</strong> ${board.emergency_activated_by || 'Unknown'}<br>
                                            ${board.emergency_auto_reset_at ? `
                                                <strong>Auto-Reset:</strong> ${new Date(board.emergency_auto_reset_at).toLocaleString()}
                                            ` : ''}
                                        </div>
                                    ` : ''}

                                    <div class="emergency-actions">
                                        ${isEmergency ? `
                                            <button class="btn btn-success" 
                                                    onclick="emergencyReset(${board.id}, '${board.name}')"
                                                    ${!board.online ? 'disabled' : ''}>
                                                ‚úÖ Reset to Normal
                                            </button>
                                        ` : `
                                            <button class="btn btn-emergency" 
                                                    onclick="emergencyLock(${board.id}, '${board.name}')"
                                                    ${!board.online ? 'disabled' : ''}>
                                                üîí EMERGENCY LOCK ALL
                                            </button>
                                            <button class="btn btn-warning" 
                                                    onclick="emergencyUnlock(${board.id}, '${board.name}')"
                                                    ${!board.online ? 'disabled' : ''}>
                                                üîì EMERGENCY UNLOCK ALL
                                            </button>
                                        `}
                                    </div>

                                    <div class="emergency-door-overrides">
                                        <h4>Individual Door Controls:</h4>
                                        ${boardDoors.map(door => `
                                            <div class="emergency-door-item">
                                                <div>
                                                    <div class="emergency-door-name">üö™ ${door.name}</div>
                                                    ${door.emergency_override ? `
                                                        <span class="badge badge-emergency" style="margin-left: 10px;">
                                                            Override: ${door.emergency_override.toUpperCase()}
                                                        </span>
                                                    ` : ''}
                                                </div>
                                                <div class="emergency-door-actions">
                                                    ${door.emergency_override ? `
                                                        <button class="btn btn-success btn-small" 
                                                                onclick="doorOverrideReset(${door.id}, '${door.name}')"
                                                                ${!board.online ? 'disabled' : ''}>
                                                            Reset
                                                        </button>
                                                    ` : `
                                                        <button class="btn btn-danger btn-small" 
                                                                onclick="doorOverrideLock(${door.id}, '${door.name}')"
                                                                ${!board.online ? 'disabled' : ''}>
                                                            üîí Lock
                                                        </button>
                                                        <button class="btn btn-warning btn-small" 
                                                                onclick="doorOverrideUnlock(${door.id}, '${door.name}')"
                                                                ${!board.online ? 'disabled' : ''}>
                                                            üîì Unlock
                                                        </button>
                                                    `}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading emergency controls:', error);
                showToast('Error loading emergency controls', 'error');
            }
        }

        function emergencyLock(boardId, boardName) {
            emergencyAction = {
                type: 'lock',
                boardId: boardId,
                boardName: boardName
            };

            document.getElementById('emergencyConfirmText').textContent = 
                `Are you sure you want to EMERGENCY LOCK all doors on "${boardName}"? This will override all schedules and prevent ALL access.`;
            document.getElementById('emergencyAutoResetContainer').style.display = 'none';
            document.getElementById('emergencyConfirmButton').textContent = 'üîí LOCK ALL DOORS';
            document.getElementById('emergencyActivatedBy').value = '';
            document.getElementById('emergencyConfirmModal').classList.add('active');
        }

        function emergencyUnlock(boardId, boardName) {
            emergencyAction = {
                type: 'unlock',
                boardId: boardId,
                boardName: boardName
            };

            document.getElementById('emergencyConfirmText').textContent = 
                `Are you sure you want to EMERGENCY UNLOCK all doors on "${boardName}"? This will grant FREE ACCESS to all doors for evacuation purposes.`;
            document.getElementById('emergencyAutoResetContainer').style.display = 'block';
            document.getElementById('emergencyConfirmButton').textContent = 'üîì UNLOCK ALL DOORS';
            document.getElementById('emergencyActivatedBy').value = '';
            document.getElementById('emergencyConfirmModal').classList.add('active');
        }

        function emergencyReset(boardId, boardName) {
            emergencyAction = {
                type: 'reset',
                boardId: boardId,
                boardName: boardName
            };

            document.getElementById('emergencyConfirmText').textContent = 
                `Reset emergency mode on "${boardName}" and return to normal operation?`;
            document.getElementById('emergencyAutoResetContainer').style.display = 'none';
            document.getElementById('emergencyConfirmButton').textContent = '‚úÖ Reset to Normal';
            document.getElementById('emergencyActivatedBy').value = '';
            document.getElementById('emergencyConfirmModal').classList.add('active');
        }

        function doorOverrideLock(doorId, doorName) {
            emergencyAction = {
                type: 'door-lock',
                doorId: doorId,
                doorName: doorName
            };

            document.getElementById('emergencyConfirmText').textContent = 
                `Lock "${doorName}" in emergency mode? This door will be locked regardless of schedules.`;
            document.getElementById('emergencyAutoResetContainer').style.display = 'none';
            document.getElementById('emergencyConfirmButton').textContent = 'üîí Lock Door';
            document.getElementById('emergencyActivatedBy').value = '';
            document.getElementById('emergencyConfirmModal').classList.add('active');
        }

        function doorOverrideUnlock(doorId, doorName) {
            emergencyAction = {
                type: 'door-unlock',
                doorId: doorId,
                doorName: doorName
            };

            document.getElementById('emergencyConfirmText').textContent = 
                `Unlock "${doorName}" in emergency mode? This door will be unlocked regardless of schedules.`;
            document.getElementById('emergencyAutoResetContainer').style.display = 'none';
            document.getElementById('emergencyConfirmButton').textContent = 'üîì Unlock Door';
            document.getElementById('emergencyActivatedBy').value = '';
            document.getElementById('emergencyConfirmModal').classList.add('active');
        }

        function doorOverrideReset(doorId, doorName) {
            emergencyAction = {
                type: 'door-reset',
                doorId: doorId,
                doorName: doorName
            };

            document.getElementById('emergencyConfirmText').textContent = 
                `Reset emergency override on "${doorName}" and return to normal operation?`;
            document.getElementById('emergencyAutoResetContainer').style.display = 'none';
            document.getElementById('emergencyConfirmButton').textContent = '‚úÖ Reset Door';
            document.getElementById('emergencyActivatedBy').value = '';
            document.getElementById('emergencyConfirmModal').classList.add('active');
        }

        function closeEmergencyConfirmModal() {
            document.getElementById('emergencyConfirmModal').classList.remove('active');
            emergencyAction = null;
        }

        async function confirmEmergencyAction() {
            if (!emergencyAction) return;

            const activatedBy = document.getElementById('emergencyActivatedBy').value.trim();
            if (!activatedBy) {
                showToast('Please enter your name for the audit log', 'warning');
                return;
            }

            try {
                let url, method = 'POST', body = { activated_by: activatedBy };

                if (emergencyAction.type === 'lock') {
                    url = `/api/boards/${emergencyAction.boardId}/emergency-lock`;
                } else if (emergencyAction.type === 'unlock') {
                    url = `/api/boards/${emergencyAction.boardId}/emergency-unlock`;
                    body.auto_reset_minutes = parseInt(document.getElementById('emergencyAutoReset').value);
                } else if (emergencyAction.type === 'reset') {
                    url = `/api/boards/${emergencyAction.boardId}/emergency-reset`;
                    body.reset_by = activatedBy;
                } else if (emergencyAction.type === 'door-lock') {
                    url = `/api/doors/${emergencyAction.doorId}/emergency-override`;
                    body.mode = 'lock';
                } else if (emergencyAction.type === 'door-unlock') {
                    url = `/api/doors/${emergencyAction.doorId}/emergency-override`;
                    body.mode = 'unlock';
                } else if (emergencyAction.type === 'door-reset') {
                    url = `/api/doors/${emergencyAction.doorId}/emergency-override`;
                    body.mode = null;
                }

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    closeEmergencyConfirmModal();
                    loadEmergencyControls();
                    loadEmergencyStatus();
                    loadBoards();
                    loadDoors();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error executing emergency action:', error);
                showToast('Error executing emergency action', 'error');
            }
        }

        // ==================== DOOR SCHEDULES ====================
        async function openDoorScheduleModal(doorId, doorName) {
            currentDoorId = doorId;
            document.getElementById('doorScheduleModalTitle').textContent = `Schedule: ${doorName}`;
            document.getElementById('doorScheduleDoorId').value = doorId;

            try {
                const response = await fetch(`/api/door-schedules/${doorId}`);
                const data = await response.json();

                if (data.success) {
                    doorSchedules = data.schedules.length > 0 ? convertSchedulesToUI(data.schedules) : [];
                    renderDoorSchedules();
                }
            } catch (error) {
                console.error('Error loading door schedules:', error);
                doorSchedules = [];
                renderDoorSchedules();
            }

            document.getElementById('doorScheduleModal').classList.add('active');
        }

        function closeDoorScheduleModal() {
            document.getElementById('doorScheduleModal').classList.remove('active');
            doorSchedules = [];
        }

        function convertSchedulesToUI(schedules) {
            // Group schedules by name
            const grouped = {};
            schedules.forEach(s => {
                if (!grouped[s.name]) {
                    grouped[s.name] = {
                        name: s.name,
                        type: s.schedule_type,
                        days: [],
                        start_time: s.start_time,
                        end_time: s.end_time,
                        priority: s.priority
                    };
                }
                grouped[s.name].days.push(s.day_of_week);
            });
            return Object.values(grouped);
        }

        function addDoorSchedule() {
            doorSchedules.push({
                name: 'New Schedule',
                type: 'controlled',
                days: [0, 1, 2, 3, 4],
                start_time: '09:00:00',
                end_time: '17:00:00',
                priority: 0
            });
            renderDoorSchedules();
        }

        function removeDoorSchedule(index) {
            if (confirm('Remove this schedule?')) {
                doorSchedules.splice(index, 1);
                renderDoorSchedules();
            }
        }

        function renderDoorSchedules() {
            const container = document.getElementById('doorSchedulesList');
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            if (doorSchedules.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <p>No schedules configured. Door will operate in controlled mode (require credentials).</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = doorSchedules.map((schedule, index) => {
                const typeColors = {
                    'unlock': '#10b981',
                    'controlled': '#3b82f6',
                    'locked': '#ef4444'
                };

                return `
                    <div style="border: 2px solid ${typeColors[schedule.type]}; border-radius: 12px; padding: 20px; margin-bottom: 15px; position: relative;">
                        <button onclick="removeDoorSchedule(${index})" 
                                style="position: absolute; top: 15px; right: 15px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">
                            √ó
                        </button>

                        <div class="form-group">
                            <label class="form-label">Schedule Name</label>
                            <input type="text" class="form-input" value="${schedule.name}" 
                                   onchange="doorSchedules[${index}].name = this.value">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mode</label>
                            <select class="form-select" onchange="doorSchedules[${index}].type = this.value; renderDoorSchedules();">
                                <option value="unlock" ${schedule.type === 'unlock' ? 'selected' : ''}>
                                    üîì Unlock (Free access - door unlocked)
                                </option>
                                <option value="controlled" ${schedule.type === 'controlled' ? 'selected' : ''}>
                                    üîê Controlled (Require card/PIN)
                                </option>
                                <option value="locked" ${schedule.type === 'locked' ? 'selected' : ''}>
                                    üîí Locked (Deny all access)
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Days</label>
                            <div class="checkbox-group">
                                ${dayNames.map((day, dayIndex) => `
                                    <div class="checkbox-item">
                                        <input type="checkbox" 
                                               id="schedule-${index}-day-${dayIndex}"
                                               ${schedule.days.includes(dayIndex) ? 'checked' : ''}
                                               onchange="toggleScheduleDay(${index}, ${dayIndex})">
                                        <label for="schedule-${index}-day-${dayIndex}">${day}</label>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-input" value="${schedule.start_time.substring(0, 5)}" 
                                       onchange="doorSchedules[${index}].start_time = this.value + ':00'">
                            </div>
                            <div class="form-group">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-input" value="${schedule.end_time.substring(0, 5)}" 
                                       onchange="doorSchedules[${index}].end_time = this.value + ':00'">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Priority (higher = takes precedence)</label>
                            <input type="number" class="form-input" value="${schedule.priority}" 
                                   onchange="doorSchedules[${index}].priority = parseInt(this.value)">
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleScheduleDay(scheduleIndex, dayIndex) {
            const days = doorSchedules[scheduleIndex].days;
            const index = days.indexOf(dayIndex);

            if (index > -1) {
                days.splice(index, 1);
            } else {
                days.push(dayIndex);
            }

            renderDoorSchedules();
        }

        async function saveDoorSchedules() {
            const doorId = document.getElementById('doorScheduleDoorId').value;

            try {
                const response = await fetch(`/api/door-schedules/${doorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedules: doorSchedules })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Door schedules saved', 'success');
                    closeDoorScheduleModal();

                    // Sync the board
                    const door = allDoors.find(d => d.id == doorId);
                    if (door) {
                        const boardsResponse = await fetch('/api/boards');
                        const boardsData = await boardsResponse.json();
                        if (boardsData.success) {
                            const board = boardsData.boards.find(b => b.ip_address === door.ip_address);
                            if (board) {
                                await fetch(`/api/boards/${board.id}/sync`, { method: 'POST' });
                                showToast('Board synced with new schedules', 'success');
                            }
                        }
                    }
                } else {
                    showToast(data.message || 'Error saving schedules', 'error');
                }
            } catch (error) {
                console.error('Error saving door schedules:', error);
                showToast('Error saving schedules', 'error');
            }
        }

        // ==================== DOOR SETTINGS ====================
let currentDoorSettings = null;

async function openDoorSettingsModal(doorId, doorName, unlockDuration) {
    currentDoorSettings = { doorId, doorName };
    
    document.getElementById('doorSettingsModalTitle').textContent = `Settings: ${doorName}`;
    document.getElementById('settingsDoorId').value = doorId;
    document.getElementById('settingsDoorName').value = doorName;
    document.getElementById('settingsUnlockDuration').value = unlockDuration || 3000;
    
    document.getElementById('doorSettingsModal').classList.add('active');
}

function closeDoorSettingsModal() {
    document.getElementById('doorSettingsModal').classList.remove('active');
    currentDoorSettings = null;
}

async function saveDoorSettings(event) {
    event.preventDefault();
    
    const doorId = document.getElementById('settingsDoorId').value;
    const unlockDuration = parseInt(document.getElementById('settingsUnlockDuration').value);
    
    try {
        const response = await fetch(`/api/doors/${doorId}/settings`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ unlock_duration: unlockDuration })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Door settings saved', 'success');
            closeDoorSettingsModal();
            loadDoors();
        } else {
            showToast(data.message || 'Error saving settings', 'error');
        }
    } catch (error) {
        console.error('Error saving door settings:', error);
        showToast('Error saving settings', 'error');
    }
}

        // ==================== USERS ====================
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('usersList');

                    if (data.users.length === 0) {
                        container.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No users configured yet</td></tr>';
                        return;
                    }

                    container.innerHTML = data.users.map(user => `
                        <tr>
                            <td><strong>${user.name}</strong></td>
                            <td>
                                <span class="badge ${user.active ? 'badge-success' : 'badge-danger'}">
                                    ${user.active ? '‚úÖ Active' : '‚ùå Inactive'}
                                </span>
                            </td>
                            <td>${user.cards.length} card(s)</td>
                            <td>${user.pins.length} PIN(s)</td>
                            <td>${user.groups.length} group(s)</td>
                            <td>${user.schedules.length} schedule(s)</td>
                            <td>
                                <button class="btn btn-secondary btn-small" onclick="editUser(${user.id})">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteUser(${user.id})">
                                    üóëÔ∏è
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Error loading users', 'error');
            }
        }

        async function openUserModal(userId = null) {
            currentUserId = userId;

            // Load groups and schedules first
            await Promise.all([loadGroupsForUser(), loadSchedulesForUser()]);

            if (userId) {
                document.getElementById('userModalTitle').textContent = 'Edit User';
                const response = await fetch('/api/users');
                const data = await response.json();
                const user = data.users.find(u => u.id === userId);

                if (user) {
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userName').value = user.name;
                    document.getElementById('userActive').checked = user.active;
                    document.getElementById('userValidFrom').value = user.valid_from || '';
                    document.getElementById('userValidUntil').value = user.valid_until || '';
                    document.getElementById('userNotes').value = user.notes || '';

                    // Load cards
                    const cardsContainer = document.getElementById('userCards');
                    cardsContainer.innerHTML = user.cards.map((card, index) => `
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="form-input" value="${card.card_number}" 
                                   placeholder="Card number" data-card-index="${index}">
                            <button type="button" class="btn btn-danger btn-small" 
                                    onclick="this.parentElement.remove()">√ó</button>
                        </div>
                    `).join('');

                    // Load PINs
                    const pinsContainer = document.getElementById('userPins');
                    pinsContainer.innerHTML = user.pins.map((pin, index) => `
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" class="form-input" value="${pin.pin}" 
                                   placeholder="PIN" data-pin-index="${index}">
                            <button type="button" class="btn btn-danger btn-small" 
                                    onclick="this.parentElement.remove()">√ó</button>
                        </div>
                    `).join('');

                    // Select groups
                    user.groups.forEach(group => {
                        const checkbox = document.getElementById(`user-group-${group.id}`);
                        if (checkbox) checkbox.checked = true;
                    });

                    // Select schedules
                    user.schedules.forEach(schedule => {
                        const checkbox = document.getElementById(`user-schedule-${schedule.id}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } else {
                document.getElementById('userModalTitle').textContent = 'Add User';
                document.getElementById('userForm').reset();
                document.getElementById('userId').value = '';
                document.getElementById('userCards').innerHTML = '';
                document.getElementById('userPins').innerHTML = '';
            }

            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        async function loadGroupsForUser() {
            const response = await fetch('/api/groups');
            const data = await response.json();

            if (data.success) {
                allGroups = data.groups;
                const container = document.getElementById('userGroupsCheckboxes');

                if (data.groups.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; font-size: 13px;">No groups available. Create groups first.</p>';
                } else {
                    container.innerHTML = data.groups.map(group => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="user-group-${group.id}" value="${group.id}">
                            <label for="user-group-${group.id}">
                                <span style="display: inline-block; width: 12px; height: 12px; background: ${group.color}; border-radius: 3px; margin-right: 8px;"></span>
                                ${group.name}
                            </label>
                        </div>
                    `).join('');
                }
            }
        }

        async function loadSchedulesForUser() {
            const response = await fetch('/api/schedules');
            const data = await response.json();

            if (data.success) {
                allSchedules = data.schedules;
                const container = document.getElementById('userSchedulesCheckboxes');

                if (data.schedules.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; font-size: 13px;">No schedules available. Leave empty for 24/7 access.</p>';
                } else {
                    container.innerHTML = data.schedules.map(schedule => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="user-schedule-${schedule.id}" value="${schedule.id}">
                            <label for="user-schedule-${schedule.id}">
                                ${schedule.name} ${schedule.active ? '' : '(Inactive)'}
                            </label>
                        </div>
                    `).join('');
                }
            }
        }

        function addCardInput() {
            const container = document.getElementById('userCards');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            div.innerHTML = `
                <input type="text" class="form-input" placeholder="Card number (e.g., 173 37764)">
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        }

        function addPinInput() {
            const container = document.getElementById('userPins');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px;';
            div.innerHTML = `
                <input type="text" class="form-input" placeholder="PIN (4-8 digits)" maxlength="8">
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        }

        async function saveUser(event) {
            event.preventDefault();

            const userId = document.getElementById('userId').value;

            // Collect cards
            const cards = Array.from(document.querySelectorAll('#userCards input[type="text"]'))
                .map(input => ({ number: input.value.trim() }))
                .filter(card => card.number);

            // Collect PINs
            const pins = Array.from(document.querySelectorAll('#userPins input[type="text"]'))
                .map(input => ({ pin: input.value.trim() }))
                .filter(pin => pin.pin);

            // Collect selected groups
            const group_ids = Array.from(document.querySelectorAll('#userGroupsCheckboxes input:checked'))
                .map(input => parseInt(input.value));

            // Collect selected schedules
            const schedule_ids = Array.from(document.querySelectorAll('#userSchedulesCheckboxes input:checked'))
                .map(input => parseInt(input.value));

            if (group_ids.length === 0) {
                showToast('Please select at least one group', 'warning');
                return;
            }

            const userData = {
                name: document.getElementById('userName').value,
                active: document.getElementById('userActive').checked,
                valid_from: document.getElementById('userValidFrom').value || null,
                valid_until: document.getElementById('userValidUntil').value || null,
                notes: document.getElementById('userNotes').value,
                cards: cards,
                pins: pins,
                group_ids: group_ids,
                schedule_ids: schedule_ids
            };

            try {
                const url = userId ? `/api/users/${userId}` : '/api/users';
                const method = userId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    closeUserModal();
                    loadUsers();

                    // Sync all boards
                    await fetch('/api/boards/sync-all', { method: 'POST' });
                    showToast('All boards synced with user changes', 'success');
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                showToast('Error saving user', 'error');
            }
        }

        function editUser(userId) {
            openUserModal(userId);
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadUsers();

                    // Sync all boards
                    await fetch('/api/boards/sync-all', { method: 'POST' });
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Error deleting user', 'error');
            }
        }

        // ==================== GROUPS ====================
        async function loadGroups() {
            try {
                const response = await fetch('/api/groups');
                const data = await response.json();

                if (data.success) {
                    allGroups = data.groups;
                    const container = document.getElementById('groupsList');

                    if (data.groups.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No groups configured yet</p>';
                        return;
                    }

                    container.innerHTML = data.groups.map(group => `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <span style="display: inline-block; width: 16px; height: 16px; background: ${group.color}; border-radius: 4px; margin-right: 8px;"></span>
                                    ${group.name}
                                </div>
                            </div>
                            <div class="card-body">
                                ${group.description ? `<p style="color: #64748b; margin-bottom: 15px;">${group.description}</p>` : ''}
                                <div class="card-info">
                                    <span class="card-info-label">Doors:</span>
                                    <span class="card-info-value">${group.door_count}</span>
                                </div>
                                <div class="card-info">
                                    <span class="card-info-label">Users:</span>
                                    <span class="card-info-value">${group.user_count}</span>
                                </div>
                            </div>
                            <div class="card-actions">
                                <button class="btn btn-secondary btn-small" onclick="editGroup(${group.id})">
                                    ‚úèÔ∏è Edit
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteGroup(${group.id})">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading groups:', error);
                showToast('Error loading groups', 'error');
            }
        }

        async function openGroupModal(groupId = null) {
            currentGroupId = groupId;

            // Load doors
            await loadDoorsForGroup();

            if (groupId) {
                document.getElementById('groupModalTitle').textContent = 'Edit Group';
                const response = await fetch('/api/groups');
                const data = await response.json();
                const group = data.groups.find(g => g.id === groupId);

                if (group) {
                    document.getElementById('groupId').value = group.id;
                    document.getElementById('groupName').value = group.name;
                    document.getElementById('groupDescription').value = group.description || '';
                    document.getElementById('groupColor').value = group.color;

                    // Select doors
                    group.doors.forEach(door => {
                        const checkbox = document.getElementById(`group-door-${door.id}`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } else {
                document.getElementById('groupModalTitle').textContent = 'Add Group';
                document.getElementById('groupForm').reset();
                document.getElementById('groupId').value = '';
            }

            document.getElementById('groupModal').classList.add('active');
        }

        function closeGroupModal() {
            document.getElementById('groupModal').classList.remove('active');
        }

        async function loadDoorsForGroup() {
            const response = await fetch('/api/doors');
            const data = await response.json();

            if (data.success) {
                allDoors = data.doors;
                const container = document.getElementById('groupDoorsCheckboxes');

                if (data.doors.length === 0) {
                    container.innerHTML = '<p style="color: #64748b; font-size: 13px;">No doors available. Add boards first.</p>';
                } else {
                    container.innerHTML = data.doors.map(door => `
                        <div class="checkbox-item">
                            <input type="checkbox" id="group-door-${door.id}" value="${door.id}">
                            <label for="group-door-${door.id}">
                                ${door.board_name} - ${door.name}
                            </label>
                        </div>
                    `).join('');
                }
            }
        }

        async function saveGroup(event) {
            event.preventDefault();

            const groupId = document.getElementById('groupId').value;

            // Collect selected doors
            const door_ids = Array.from(document.querySelectorAll('#groupDoorsCheckboxes input:checked'))
                .map(input => parseInt(input.value));

            if (door_ids.length === 0) {
                showToast('Please select at least one door', 'warning');
                return;
            }

            const groupData = {
                name: document.getElementById('groupName').value,
                description: document.getElementById('groupDescription').value,
                color: document.getElementById('groupColor').value,
                door_ids: door_ids
            };

            try {
                const url = groupId ? `/api/groups/${groupId}` : '/api/groups';
                const method = groupId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(groupData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    closeGroupModal();
                    loadGroups();

                    // Sync all boards
                    await fetch('/api/boards/sync-all', { method: 'POST' });
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving group:', error);
                showToast('Error saving group', 'error');
            }
        }

        function editGroup(groupId) {
            openGroupModal(groupId);
        }

        async function deleteGroup(groupId) {
            if (!confirm('Are you sure you want to delete this group?')) {
                return;
            }

            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadGroups();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting group:', error);
                showToast('Error deleting group', 'error');
            }
        }

        // ==================== SCHEDULES (User Time Restrictions) ====================
        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules');
                const data = await response.json();

                if (data.success) {
                    allSchedules = data.schedules;
                    const container = document.getElementById('schedulesList');

                    if (data.schedules.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No schedules configured yet</p>';
                        return;
                    }

                    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

                    container.innerHTML = data.schedules.map(schedule => {
                        let timeRangesText = '';
                        if (schedule.times && schedule.times.length > 0) {
                            const grouped = {};
                            schedule.times.forEach(t => {
                                const key = `${t.start_time}-${t.end_time}`;
                                if (!grouped[key]) grouped[key] = [];
                                grouped[key].push(dayNames[t.day_of_week]);
                            });

                            timeRangesText = Object.entries(grouped).map(([time, days]) => {
                                const [start, end] = time.split('-');
                                return `${days.join(', ')}: ${start.substring(0, 5)} - ${end.substring(0, 5)}`;
                            }).join('<br>');
                        }

                        return `
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">${schedule.name}</div>
                                    <span class="badge ${schedule.active ? 'badge-success' : 'badge-danger'}">
                                        ${schedule.active ? '‚úÖ Active' : '‚ùå Inactive'}
                                    </span>
                                </div>
                                <div class="card-body">
                                    ${schedule.description ? `<p style="color: #64748b; margin-bottom: 15px;">${schedule.description}</p>` : ''}
                                    <div class="card-info">
                                        <span class="card-info-label">Time Ranges:</span>
                                    </div>
                                    <div style="font-size: 13px; color: #1e293b; margin-top: 5px;">
                                        ${timeRangesText || 'No time ranges'}
                                    </div>
                                    <div class="card-info" style="margin-top: 10px;">
                                        <span class="card-info-label">Users:</span>
                                        <span class="card-info-value">${schedule.user_count}</span>
                                    </div>
                                </div>
                                <div class="card-actions">
                                    <button class="btn btn-secondary btn-small" onclick="editSchedule(${schedule.id})">
                                        ‚úèÔ∏è Edit
                                    </button>
                                    <button class="btn btn-danger btn-small" onclick="deleteSchedule(${schedule.id})">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading schedules:', error);
                showToast('Error loading schedules', 'error');
            }
        }

        async function openScheduleModal(scheduleId = null) {
            currentScheduleId = scheduleId;

            if (scheduleId) {
                document.getElementById('scheduleModalTitle').textContent = 'Edit Schedule';
                const response = await fetch('/api/schedules');
                const data = await response.json();
                const schedule = data.schedules.find(s => s.id === scheduleId);

                if (schedule) {
                    document.getElementById('scheduleId').value = schedule.id;
                    document.getElementById('scheduleName').value = schedule.name;
                    document.getElementById('scheduleDescription').value = schedule.description || '';
                    document.getElementById('scheduleActive').checked = schedule.active;

                    // Load time ranges
                    const container = document.getElementById('scheduleTimeRanges');
                    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                    container.innerHTML = schedule.times.map((time) => `
                        <div class="schedule-time-range-item" style="border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
                                <select class="form-select schedule-day">
                                    ${dayNames.map((day, dayIndex) => `
                                        <option value="${dayIndex}" ${time.day_of_week === dayIndex ? 'selected' : ''}>
                                            ${day}
                                        </option>
                                    `).join('')}
                                </select>
                                <input type="time" class="form-input schedule-start" value="${time.start_time.substring(0, 5)}">
                                <input type="time" class="form-input schedule-end" value="${time.end_time.substring(0, 5)}">
                                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.parentElement.remove()">√ó</button>
                            </div>
                        </div>
                    `).join('');
                }
            } else {
                document.getElementById('scheduleModalTitle').textContent = 'Add Schedule';
                document.getElementById('scheduleForm').reset();
                document.getElementById('scheduleId').value = '';
                document.getElementById('scheduleTimeRanges').innerHTML = '';
            }

            document.getElementById('scheduleModal').classList.add('active');
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
        }

        function addScheduleTimeRange() {
            const container = document.getElementById('scheduleTimeRanges');
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

            const div = document.createElement('div');
            div.className = 'schedule-time-range-item';
            div.style.cssText = 'border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 10px;';
            div.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; align-items: center;">
                    <select class="form-select schedule-day">
                        ${dayNames.map((day, dayIndex) => `<option value="${dayIndex}">${day}</option>`).join('')}
                    </select>
                    <input type="time" class="form-input schedule-start" value="09:00">
                    <input type="time" class="form-input schedule-end" value="17:00">
                    <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.parentElement.remove()">√ó</button>
                </div>
            `;
            container.appendChild(div);
        }

        async function saveSchedule(event) {
            if (event) event.preventDefault();

            const scheduleId = document.getElementById('scheduleId').value;

            // Collect time ranges using the new class-based selectors
            const times = [];
            const timeRanges = document.querySelectorAll('.schedule-time-range-item');

            timeRanges.forEach((range) => {
                const day = range.querySelector('.schedule-day')?.value;
                const start = range.querySelector('.schedule-start')?.value;
                const end = range.querySelector('.schedule-end')?.value;

                if (day !== undefined && start && end) {
                    times.push({
                        day_of_week: parseInt(day),
                        start_time: start + ':00',
                        end_time: end + ':00'
                    });
                }
            });

            console.log('Collected times:', times); // Debug log

            if (times.length === 0) {
                showToast('Please add at least one time range', 'warning');
                return;
            }

            const scheduleData = {
                name: document.getElementById('scheduleName').value,
                description: document.getElementById('scheduleDescription').value,
                active: document.getElementById('scheduleActive').checked,
                times: times
            };

            try {
                const url = scheduleId ? `/api/schedules/${scheduleId}` : '/api/schedules';
                const method = scheduleId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });

                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    closeScheduleModal();
                    loadSchedules();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving schedule:', error);
                showToast('Error saving schedule', 'error');
            }
        }

        function editSchedule(scheduleId) {
            openScheduleModal(scheduleId);
        }

        async function deleteSchedule(scheduleId) {
            if (!confirm('Are you sure you want to delete this schedule?')) {
                return;
            }

            try {
                const response = await fetch(`/api/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showToast(data.message, 'success');
                    loadSchedules();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Error deleting schedule:', error);
                showToast('Error deleting schedule', 'error');
            }
        }

        // ==================== LOGS ====================
        async function loadLogs() {
            try {
                const limit = document.getElementById('logFilter').value;
                const response = await fetch(`/api/logs?limit=${limit}`);
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('logsList');

                    if (data.logs.length === 0) {
                        container.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #64748b;">No logs yet</td></tr>';
                        return;
                    }

                    container.innerHTML = data.logs.map(log => `
                        <tr>
                            <td>${log.timestamp}</td>
                            <td>${log.board_name || 'N/A'}</td>
                            <td>${log.door_name || 'N/A'}</td>
                            <td>${log.user_name || 'Unknown'}</td>
                            <td>
                                <strong>${log.credential || 'N/A'}</strong><br>
                                <small style="color: #64748b;">(${log.credential_type || 'unknown'})</small>
                            </td>
                            <td>
                                <span class="badge ${log.access_granted ? 'badge-success' : 'badge-danger'}">
                                    ${log.access_granted ? '‚úÖ Granted' : '‚ùå Denied'}
                                </span>
                            </td>
                            <td>${log.reason}</td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                showToast('Error loading logs', 'error');
            }
        }

        // ==================== TOAST ====================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');

            toast.className = 'toast show ' + type;
            toastMessage.textContent = message;

            if (type === 'success') {
                toastIcon.textContent = '‚úÖ';
            } else if (type === 'error') {
                toastIcon.textContent = '‚ùå';
            } else if (type === 'warning') {
                toastIcon.textContent = '‚ö†Ô∏è';
            } else {
                toastIcon.textContent = '‚ÑπÔ∏è';
            }

            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html>
